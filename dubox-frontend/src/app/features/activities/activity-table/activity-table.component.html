<div class="process-flow-table-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <p>Loading activities...</p>
  </div>

  <div class="table-wrapper" *ngIf="!isLoading">
    <table class="process-flow-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Team</th>
          <th>Activity</th>
          <th>Assigned to</th>
          <th>Duration</th>
          <th>Actual Start</th>
          <th>Progress</th>
          <th>Actual Finish</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let row of tableRows; let i = index">
          <!-- Regular Activity Row -->
          <tr 
            *ngIf="isActivityRow(row)"
            class="activity-row"
          >
            <td class="text-center">{{ row.sequence }}</td>
            <td class="text-center team-cell">{{ getTeam(getActivity(row)) }}</td>
            <td class="activity-name">
              <span>{{ getActivityName(getActivity(row)) }}</span>
            </td>
            <td class="assigned-to">
              <span>{{ getAssignedTo(getActivity(row)) }}</span>
            </td>
            <td class="text-center">
              <span>{{ getActivity(row)?.duration || '-' }}</span>
            </td>
            <td class="text-center">
              <span>{{ formatDate(getActivity(row)?.actualStartDate) }}</span>
            </td>
            <td class="text-center">
              <span *ngIf="getProgress(getActivity(row)) > 0" class="progress-badge">
                {{ getProgress(getActivity(row)) }}%
              </span>
            </td>
            <td class="text-center">
              {{ formatDate(getActivity(row)?.actualEndDate) }}
            </td>
            <td class="text-center actions-cell">
              <!-- Update Progress Button -->
              <button 
                *ngIf="getActivity(row)"
                class="btn-update-progress"
                (click)="openProgressModal(getActivity(row)!)"
                title="Update Progress"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>

              <!-- View Details Button -->
              <button 
                class="btn-view-details"
                [routerLink]="['/projects', projectId, 'boxes', boxId, 'activities', getActivity(row)?.boxActivityId]"
                title="View Activity Details"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </td>
          </tr>

          <!-- WIR Inspection Row -->
          <tr 
            *ngIf="isWIRRow(row)"
            class="wir-row wir-checkpoint"
          >
            <td class="text-center wir-code-cell">
              <strong>{{ getWIR(row)?.wirCode || 'WIR' }}</strong>
            </td>
            <td class="text-center team-cell wir-team-cell"><strong>QA/QC</strong></td>
            <!-- Activity cell: merge with Assigned to if empty -->
            <td class="activity-name wir-activity-cell" [attr.colspan]="hasWIRInspector(row) ? 1 : 2">
              <span class="stage-label">Clearance / WIR</span>
            </td>
            <!-- Assigned to cell: show for all WIRs, default to "QC Engineer" if not assigned -->
            <td class="assigned-to" *ngIf="hasWIRInspector(row)">
              <strong class="wir-assigned">{{ getWIRInspectorName(row) }}</strong>
            </td>
            <!-- Merge empty Duration and Actual Start cells -->
            <td class="text-center" colspan="2"></td>
            <td class="text-center wir-progress-cell">
              <span class="wir-progress-label">
                {{ getWIRDescription(getWIR(row)) }}
              </span>
            </td>
            <!-- Status cell: merge with Actions if empty -->
            <td class="text-center wir-status-cell" [attr.colspan]="hasWIRActions(row) ? 1 : 2">
              <span class="wir-status-card" [ngClass]="getWIR(row)?.status || 'Pending'">
                {{ getWIRStatusLabel(getWIR(row)?.status || 'Pending') }}
              </span>
            </td>
            <!-- Actions cell: only show if has data -->
            <td class="text-center actions-cell" *ngIf="hasWIRActions(row)">
              <button 
                class="btn-view-details"
                [routerLink]="['/projects', projectId, 'boxes', boxId, 'wir', getWIR(row)?.wirRecordId]"
                title="View WIR Details"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
              <button 
                class="btn-qa-qc"
                (click)="openWIRApprovalModal(getWIR(row)!)"
                title="Approve/Reject WIR"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                QA/QC
              </button>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Empty state -->
  <div class="empty-state" *ngIf="!isLoading && tableRows.length === 0">
    <p>No activities found for this box</p>
  </div>
</div>

<!-- Progress Update Modal -->
<app-update-progress-modal
  *ngIf="selectedActivity"
  [activity]="selectedActivity"
  [isOpen]="isModalOpen"
  (closeModal)="closeProgressModal()"
  (progressUpdated)="onProgressUpdated($event)"
></app-update-progress-modal>

<!-- WIR Approval Modal -->
<app-wir-approval-modal
  *ngIf="selectedWIR"
  [wirRecord]="selectedWIR"
  [isOpen]="isWIRModalOpen"
  [projectId]="projectId"
  [boxId]="boxId"
  (closeModal)="closeWIRApprovalModal()"
  (wirUpdated)="onWIRUpdated($event)"
></app-wir-approval-modal>
