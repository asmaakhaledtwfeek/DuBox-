<div class="modal-overlay" *ngIf="isOpen" (click)="close()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Update Activity Progress</h2>
      <button class="close-btn" (click)="close()" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Activity Info -->
      <div class="activity-info">
        <h3>{{ activity?.activityName }}</h3>
        <p class="activity-sequence">Activity #{{ activity?.sequence }}</p>
        
        <!-- WIR Checkpoint Badge -->
        <div *ngIf="isWIRCheckpoint" class="wir-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          <span>WIR Checkpoint - {{ wirCode }}</span>
        </div>
      </div>

      <!-- Alert Messages -->
      <div class="alert alert-danger" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
      <div class="alert alert-success" *ngIf="successMessage">
        {{ successMessage }}
      </div>

      <!-- WIR Warning for Checkpoint Activities -->
      <div *ngIf="isWIRCheckpoint && progressForm.get('progressPercentage')?.value === 100" class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div>
          <strong>QC Inspection Required</strong>
          <p>Completing this activity will automatically create {{ wirCode }} for QC Engineer inspection.</p>
        </div>
      </div>

      <!-- Progress Form -->
      <form [formGroup]="progressForm" (ngSubmit)="onSubmit()">
        <!-- Progress Percentage -->
        <div class="form-group">
          <label for="progressPercentage">Progress Percentage *</label>
          <div class="progress-input-group">
            <button type="button" class="btn-adjust" (click)="incrementProgress(-10)">-10%</button>
            <button type="button" class="btn-adjust" (click)="incrementProgress(-5)">-5%</button>
            <input 
              type="number" 
              id="progressPercentage" 
              formControlName="progressPercentage"
              min="0"
              max="100"
              class="form-control"
            />
            <span class="percentage-label">%</span>
            <button type="button" class="btn-adjust" (click)="incrementProgress(5)">+5%</button>
            <button type="button" class="btn-adjust" (click)="incrementProgress(10)">+10%</button>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" [style.width.%]="progressForm.get('progressPercentage')?.value"></div>
          </div>
        </div>

        <!-- Status Info (Read-only) -->
        <div class="form-group">
          <label>Status</label>
          <div class="status-info">
            <span *ngIf="progressForm.get('progressPercentage')?.value === 0" class="status-badge status-not-started">Not Started</span>
            <span *ngIf="progressForm.get('progressPercentage')?.value > 0 && progressForm.get('progressPercentage')?.value < 100" class="status-badge status-in-progress">In Progress</span>
            <span *ngIf="progressForm.get('progressPercentage')?.value === 100" class="status-badge status-completed">Completed</span>
          </div>
          <small class="form-text">Status is automatically determined by progress percentage</small>
        </div>

        <!-- Photo Upload Section -->
        <div class="form-group">
          <label>Progress Photos</label>
          <p class="photo-upload-hint">Upload an image, enter a URL, or use your camera</p>
          
          <!-- Tabs for different input methods -->
          <div class="photo-input-tabs">
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'url' && !selectedFile && !showCamera"
              (click)="photoInputMethod = 'url'; showCamera = false; selectedFile = null; photoPreview = null"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
              </svg>
              URL
            </button>
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'upload' && selectedFile && !showCamera"
              (click)="openFileInput()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Upload
            </button>
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'camera' && showCamera"
              (click)="openCamera()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
              Camera
            </button>
          </div>

          <!-- URL Input -->
          <div *ngIf="photoInputMethod === 'url' && !showCamera && !selectedFile" class="photo-input-content">
            <input
              type="text"
              class="form-control"
              placeholder="Enter photo URL (e.g., https://example.com/photo.jpg)"
              [(ngModel)]="photoUrl"
              [ngModelOptions]="{standalone: true}"
              [disabled]="isUploadingPhoto"
            />
          </div>

          <!-- File Upload Input (hidden) -->
          <input
            id="progress-photo-file-input"
            type="file"
            accept="image/*"
            style="display: none"
            (change)="onFileSelected($event)"
            [disabled]="isUploadingPhoto"
          />

          <!-- Camera Preview -->
          <div *ngIf="showCamera" class="camera-preview-container">
            <video id="progress-camera-preview" autoplay playsinline></video>
            <div class="camera-controls">
              <button type="button" class="btn btn-secondary btn-sm" (click)="stopCamera()">
                Cancel
              </button>
              <button type="button" class="btn btn-primary btn-sm" (click)="capturePhoto()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                Capture
              </button>
            </div>
          </div>

          <!-- Photo Preview -->
          <div *ngIf="photoPreview && !showCamera" class="photo-preview-container">
            <div class="photo-preview">
              <img [src]="photoPreview" alt="Preview" />
              <button type="button" class="remove-photo-btn" (click)="removeSelectedFile()" [disabled]="isUploadingPhoto">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <p class="photo-preview-info" *ngIf="selectedFile">
              {{ selectedFile.name }} ({{ (selectedFile.size / 1024).toFixed(1) }} KB)
            </p>
          </div>

          <!-- Upload Progress -->
          <div *ngIf="isUploadingPhoto" class="upload-progress">
            <div class="spinner-small"></div>
            <span>Uploading photo...</span>
          </div>

          <!-- Errors -->
          <p class="form-text text-danger" *ngIf="photoUploadError">{{ photoUploadError }}</p>
          <small class="form-text" *ngIf="!photoUploadError">Upload photos of completed work (optional)</small>
        </div>

        <!-- Work Description -->
        <div class="form-group">
          <label for="workDescription">Work Description</label>
          <textarea 
            id="workDescription" 
            formControlName="workDescription"
            class="form-control"
            rows="3"
            placeholder="Describe the work completed..."
          ></textarea>
        </div>

        <!-- Issues Encountered -->
        <div class="form-group">
          <label for="issuesEncountered">Issues Encountered</label>
          <textarea 
            id="issuesEncountered" 
            formControlName="issuesEncountered"
            class="form-control"
            rows="3"
            placeholder="Describe any issues or challenges..."
          ></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="close()" [disabled]="isSubmitting">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="progressForm.invalid || isSubmitting">
            <span *ngIf="!isSubmitting">Update Progress</span>
            <span *ngIf="isSubmitting">Updating...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

