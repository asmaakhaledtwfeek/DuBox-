<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn-back" (click)="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Back to Users
        </button>
        <div class="title-section">
          <h1 class="page-title">Audit Logs</h1>
          <p class="page-subtitle" *ngIf="user">
            Activity history for {{ user.fullName || user.email }}
          </p>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="filter-row">
        <div class="filter-field">
          <label for="tableName">Entity Type</label>
          <select id="tableName" [(ngModel)]="filterTableName" class="filter-input">
            <option value="">All Entities</option>
            <option *ngFor="let table of availableTables; trackBy: trackByTable" [value]="table">
              {{ getTableLabel(table) }}
            </option>
          </select>
        </div>

        <div class="filter-field">
          <label for="action">Action</label>
          <select id="action" [(ngModel)]="filterAction" class="filter-input">
            <option value="">All Actions</option>
            <option *ngFor="let action of availableActions; trackBy: trackByAction" [value]="action">
              {{ action }}
            </option>
          </select>
        </div>

        <div class="filter-field">
          <label for="searchTerm">Search</label>
          <input 
            type="text" 
            id="searchTerm" 
            [(ngModel)]="filterSearchTerm" 
            placeholder="Search in logs..."
            class="filter-input"
          />
        </div>

        <div class="filter-field">
          <label for="fromDate">From Date</label>
          <input 
            type="date" 
            id="fromDate" 
            [(ngModel)]="filterFromDate" 
            class="filter-input"
          />
        </div>

        <div class="filter-field">
          <label for="toDate">To Date</label>
          <input 
            type="date" 
            id="toDate" 
            [(ngModel)]="filterToDate" 
            class="filter-input"
          />
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="resetFilters()">Reset</button>
        <button class="btn btn-primary" (click)="applyFilters()">Apply Filters</button>
        <button 
          class="btn btn-success" 
          (click)="exportToExcel()"
          [disabled]="filteredLogs.length === 0"
          title="Export audit logs to Excel"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Export to Excel
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading audit logs...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadAuditLogs()">Retry</button>
    </div>

    <!-- Audit Logs List -->
    <div class="logs-container" *ngIf="!loading && !error">
      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredLogs.length === 0">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        <h3>No Audit Logs Found</h3>
        <p>No audit logs match your current filters. Try adjusting your search criteria.</p>
      </div>

      <!-- Log Entries -->
      <div
        class="log-entry"
        *ngFor="let log of filteredLogs"
        role="button"
        tabindex="0"
        (click)="openLogDetails(log)"
        (keydown.enter)="openLogDetails(log); $event.preventDefault()"
        (keydown.space)="openLogDetails(log); $event.preventDefault()"
      >
        <div class="log-header">
          <div class="log-icon">
            <span class="action-icon">{{ DiffUtil.getActionIcon(log.action) }}</span>
          </div>
          <div class="log-main">
            <div class="log-title">
              <strong>{{ DiffUtil.getActionLabel(log.action) }}</strong>
              <span class="entity-type">{{ DiffUtil.formatEntityName(log.tableName) }}</span>
              <span class="entity-name" *ngIf="log.entityDisplayName">"{{ log.entityDisplayName }}"</span>
              <span class="log-date">on {{ formatDate(log.timestamp) }}</span>
            </div>
            <p class="log-description" *ngIf="log.description">
              {{ formatDescription(log.description) }}
            </p>
            <div class="log-meta" *ngIf="getLogAuthor(log) as author">
              <span class="log-user">by {{ author }}</span>
            </div>
          </div>
        </div>

        <!-- Changes List -->
        <div class="log-changes" *ngIf="log.changes && log.changes.length > 0">
          <div class="changes-list">
            <div 
              class="change-item" 
              *ngFor="let change of (isExpanded(log.auditLogId) ? log.changes : getVisibleChanges(log.changes))"
            >
              <span class="change-field">{{ change.field }}:</span>
              <span class="change-old">{{ DiffUtil.formatValue(change.oldValue) }}</span>
              <span class="change-arrow">â†’</span>
              <span class="change-new">{{ DiffUtil.formatValue(change.newValue) }}</span>
            </div>
          </div>

          <!-- Expand/Collapse Button -->
          <button 
            class="btn-expand" 
            *ngIf="shouldShowExpandButton(log.changes)"
            (click)="toggleExpand(log.auditLogId); $event.stopPropagation()"
          >
            <span *ngIf="!isExpanded(log.auditLogId)">
              Show {{ getHiddenChanges(log.changes).length }} more changes
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </span>
            <span *ngIf="isExpanded(log.auditLogId)">
              Show less
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18 15 12 9 6 15"/>
              </svg>
            </span>
          </button>
        </div>

        <!-- No Changes Message -->
        <div class="log-no-changes" *ngIf="(!log.changes || log.changes.length === 0) && !log.description">
          <span class="no-changes-text">{{ getNoChangeSummary(log) }}</span>
        </div>
      </div>

      <!-- Pagination Controls -->
      <div class="pagination-container" *ngIf="!loading && !error && totalPages > 0">
        <div class="pagination-info">
          <span>Showing {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalCount) }} of {{ totalCount }} logs</span>
          <div class="page-size-selector">
            <label for="pageSize">Items per page:</label>
            <select id="pageSize" [(ngModel)]="pageSize" (change)="changePageSize(pageSize)" class="page-size-select">
              <option [value]="25">25</option>
              <option [value]="50">50</option>
              <option [value]="100">100</option>
            </select>
          </div>
        </div>
        <div class="pagination-controls">
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 1"
            (click)="goToPage(1)"
            title="First page"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="11 17 6 12 11 7"/>
              <polyline points="18 17 13 12 18 7"/>
            </svg>
          </button>
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 1"
            (click)="goToPage(currentPage - 1)"
            title="Previous page"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <div class="page-numbers">
            <button 
              *ngFor="let page of getPageNumbers()"
              class="page-number"
              [class.active]="page === currentPage"
              (click)="goToPage(page)"
            >
              {{ page }}
            </button>
          </div>
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === totalPages"
            (click)="goToPage(currentPage + 1)"
            title="Next page"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === totalPages"
            (click)="goToPage(totalPages)"
            title="Last page"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="13 17 18 12 13 7"/>
              <polyline points="6 17 11 12 6 7"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<app-audit-log-details-modal
  [visible]="isDetailsModalOpen"
  [log]="selectedLog"
  (closed)="closeLogDetails()"
></app-audit-log-details-modal>
