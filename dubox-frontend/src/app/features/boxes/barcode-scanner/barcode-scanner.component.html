<div class="scanner-modal-overlay" (click)="closeScanner()">
  <div class="scanner-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="scanner-header">
      <div class="header-content">
        <div class="icon-circle">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M8 11h8"/>
            <path d="M8 15h4"/>
          </svg>
        </div>
        <div>
          <h2>{{ getScanTypeLabel() }}</h2>
          <p class="subtitle">{{ getScanTypeDescription() }}</p>
        </div>
      </div>
      <button class="close-btn" (click)="closeScanner()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Scanner Body -->
    <div class="scanner-body">
      <!-- Scan Type Info -->
      <div class="scan-type-badge" [ngClass]="{
        'arrival': scanType === 'SiteArrival',
        'installation': scanType === 'Installation'
      }">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 11 12 14 22 4"></polyline>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
        {{ scanType }}
      </div>

      <!-- Camera Scanner View -->
      <div class="camera-section" *ngIf="isCameraMode">
        <div class="camera-container">
          <video #videoElement class="camera-video" playsinline autoplay muted></video>
          <canvas #canvasElement class="camera-canvas" style="display: none;"></canvas>
          <div class="camera-overlay" *ngIf="barcodeDetector && cameraActive">
            <div class="scan-frame"></div>
          </div>
          <div class="camera-loading" *ngIf="!cameraActive">
            <div class="loading-spinner-large"></div>
            <p>Starting camera...</p>
          </div>
        </div>
        <p class="camera-hint" *ngIf="cameraActive && isBarcodeDetectionAvailable()">
          Point camera at barcode to scan automatically
        </p>
        <p class="camera-hint" *ngIf="cameraActive && !isBarcodeDetectionAvailable()" style="color: #f59e0b;">
          Camera active. Barcode detection initializing...
        </p>
        <button class="btn btn-secondary btn-camera-toggle" (click)="toggleCameraMode()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M8 11h8"/>
            <path d="M8 15h4"/>
          </svg>
          Switch to Manual Entry
        </button>
      </div>

      <!-- Manual Barcode Entry -->
      <div class="barcode-input-section" *ngIf="!isCameraMode">
        <div class="input-header">
          <label for="barcodeInput" class="input-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M7 7v10"/>
              <path d="M11 7v10"/>
              <path d="M15 7v10"/>
              <path d="M19 7v10"/>
            </svg>
            Enter Barcode Manually
          </label>
          <button 
            class="btn-camera-toggle-small" 
            *ngIf="cameraSupported && !isCameraMode"
            (click)="toggleCameraMode()"
            title="Scan with camera">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Use Camera
          </button>
        </div>
        <div class="input-with-button">
          <input
            id="barcodeInput"
            type="text"
            [(ngModel)]="manualBarcode"
            placeholder="Type or scan barcode..."
            (keyup.enter)="scanManualBarcode()"
            [disabled]="scanning"
            class="barcode-input"
            autofocus
          />
          <button
            class="clear-btn"
            *ngIf="manualBarcode && !scanning"
            (click)="clearInput()"
            title="Clear">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
          </button>
        </div>
        <p class="helper-text">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          Barcode format: PANEL-XXXX or scan with device camera
        </p>
      </div>

      <!-- Success Message -->
      <div class="success-alert" *ngIf="successMessage && !scanning">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <div>
          <strong>Success!</strong>
          <p>{{ successMessage }}</p>
        </div>
      </div>

      <!-- Error Message -->
      <div class="error-alert" *ngIf="error && !scanning">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <div>
          <strong>Error</strong>
          <p>{{ error }}</p>
        </div>
      </div>

      <!-- Location Info -->
      <div class="location-info" *ngIf="latitude && longitude">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
        Location tracking enabled
      </div>
    </div>

    <!-- Scanner Footer -->
    <div class="scanner-footer">
      <button
        class="btn btn-secondary"
        (click)="closeScanner()"
        [disabled]="scanning">
        Cancel
      </button>
      <button
        class="btn btn-primary"
        (click)="scanManualBarcode()"
        [disabled]="(!manualBarcode.trim() && !isCameraMode) || scanning">
        <span *ngIf="!scanning" class="btn-content">
          <svg *ngIf="!isCameraMode" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M7 7v10"/>
            <path d="M11 7v10"/>
          </svg>
          <svg *ngIf="isCameraMode" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          {{ isCameraMode ? 'Scanning...' : 'Scan Barcode' }}
        </span>
        <span *ngIf="scanning" class="btn-content">
          <span class="spinner-small"></span>
          Processing...
        </span>
      </button>
    </div>
  </div>
</div>

