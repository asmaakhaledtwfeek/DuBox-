<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading box details...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadBox()">Retry</button>
    </div>

    <!-- Box Details -->
    <div *ngIf="box && !loading && !error">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-left">
          <button class="btn-back" (click)="goBack()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
            Back to Boxes
          </button>
          <div class="title-section">
            <h1 class="page-title">{{ box.name || box.code }}</h1>
            <span class="badge" [ngClass]="getStatusClass(box.status)">
              {{ getStatusLabel(box.status) }}
            </span>
          </div>
          <p class="page-subtitle">{{ box.code }} • {{ box.type }}</p>
        </div>
        <div class="header-right">
          <button class="btn btn-secondary" (click)="editBox()" *ngIf="canEdit">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit
          </button>
          <button class="btn btn-danger" (click)="deleteBox()" *ngIf="canDelete">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Delete
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab" 
          [class.active]="activeTab === 'overview'"
          (click)="setActiveTab('overview')"
        >
          Overview
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'activities'"
          (click)="setActiveTab('activities')"
        >
          Activities ({{ box.activities?.length || 0 }})
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'logs'"
          (click)="setActiveTab('logs')"
        >
          Logs ({{ box.logs?.length || 0 }})
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'attachments'"
          (click)="setActiveTab('attachments')"
        >
          Attachments ({{ box.attachments?.length || 0 }})
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <div *ngIf="activeTab === 'overview'" class="overview-tab">
          <div class="content-grid">
            <!-- Box Information Card -->
            <div class="info-card">
              <h3 class="card-title">Box Information</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Box Code</span>
                  <span class="value">{{ box.code }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Box Name</span>
                  <span class="value">{{ box.name || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Type</span>
                  <span class="value">{{ box.type || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Status</span>
                  <span class="value">
                    <span class="badge" [ngClass]="getStatusClass(box.status)">
                      {{ getStatusLabel(box.status) }}
                    </span>
                  </span>
                </div>
                <div class="info-item">
                  <span class="label">Assigned Team</span>
                  <span class="value">{{ box.assignedTeam || 'Not assigned' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Assigned To</span>
                  <span class="value">{{ box.assignedTo || 'Not assigned' }}</span>
                </div>
                <div class="info-item" *ngIf="box.description">
                  <span class="label">Description</span>
                  <span class="value">{{ box.description }}</span>
                </div>
              </div>
            </div>

            <!-- QR Code Card -->
            <div class="info-card qr-card" *ngIf="box.qrCode">
              <h3 class="card-title">QR Code</h3>
              <div class="qr-container">
                <img [src]="box.qrCode" alt="QR Code" class="qr-code-image">
                <button class="btn btn-primary btn-sm" (click)="downloadQRCode()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Download
                </button>
              </div>
            </div>
          </div>

          <!-- Progress Card -->
          <div class="info-card progress-card">
            <h3 class="card-title">Progress</h3>
            <div class="progress-container">
              <div class="progress-header">
                <span class="progress-label">Overall Completion</span>
                <span class="progress-value">{{ box.progress }}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="box.progress"></div>
              </div>
            </div>
          </div>

          <!-- Dates Card -->
          <div class="info-card">
            <h3 class="card-title">Schedule</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Planned Start</span>
                <span class="value">{{ box.plannedStartDate ? (box.plannedStartDate | date: 'MMM d, yyyy') : 'Not set' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Actual Start</span>
                <span class="value">{{ box.actualStartDate ? (box.actualStartDate | date: 'MMM d, yyyy') : 'Not started' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Planned End</span>
                <span class="value">{{ box.plannedEndDate ? (box.plannedEndDate | date: 'MMM d, yyyy') : 'Not set' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Actual End</span>
                <span class="value">{{ box.actualEndDate ? (box.actualEndDate | date: 'MMM d, yyyy') : 'Not completed' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Activities Tab -->
        <div *ngIf="activeTab === 'activities'" class="activities-tab">
          <app-activity-table 
            [activities]="box.activities || []" 
            [projectId]="projectId"
            [boxId]="boxId"
          ></app-activity-table>
        </div>

        <!-- Logs Tab -->
        <div *ngIf="activeTab === 'logs'" class="logs-tab">
          <div class="empty-state" *ngIf="!box.logs || box.logs.length === 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
            <h3>No Logs</h3>
            <p>No activity logs recorded for this box</p>
          </div>

          <div class="logs-list" *ngIf="box.logs && box.logs.length > 0">
            <div class="log-item" *ngFor="let log of box.logs">
              <div class="log-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <div class="log-content">
                <div class="log-header">
                  <strong>{{ log.action }}</strong>
                  <span class="log-time">{{ log.performedAt | date: 'MMM d, yyyy h:mm a' }}</span>
                </div>
                <p class="log-description">{{ log.description }}</p>
                <span class="log-user">by {{ log.performedBy }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Attachments Tab -->
        <div *ngIf="activeTab === 'attachments'" class="attachments-tab">
          <div class="empty-state" *ngIf="!box.attachments || box.attachments.length === 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
            <h3>No Attachments</h3>
            <p>No files attached to this box</p>
          </div>

          <div class="attachments-grid" *ngIf="box.attachments && box.attachments.length > 0">
            <div class="attachment-card" *ngFor="let attachment of box.attachments">
              <div class="attachment-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                  <polyline points="13 2 13 9 20 9"/>
                </svg>
              </div>
              <div class="attachment-info">
                <h4>{{ attachment.fileName }}</h4>
                <p class="attachment-meta">{{ attachment.fileSize | number }} KB • {{ attachment.uploadedAt | date: 'MMM d, yyyy' }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
