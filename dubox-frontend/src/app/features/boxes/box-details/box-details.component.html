<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading box details...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadBox()">Retry</button>
    </div>

    <!-- Box Details -->
    <div *ngIf="box && !loading && !error">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a [routerLink]="['/projects']" class="breadcrumb-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          </svg>
          Projects
        </a>
        <span class="breadcrumb-separator">/</span>
        <a [routerLink]="['/projects', box.projectId, 'dashboard']" class="breadcrumb-item">{{ box.projectCode || 'Project' }}</a>
        <span class="breadcrumb-separator">/</span>
        <a class="breadcrumb-item" (click)="goBack()">Boxes</a>
        <ng-container *ngIf="box.boxTypeName">
          <span class="breadcrumb-separator">/</span>
          <a [routerLink]="['/projects', box.projectId, 'boxes']" [queryParams]="{boxType: box.boxTypeName}" class="breadcrumb-item">{{ box.boxTypeName }}</a>
        </ng-container>
        <ng-container *ngIf="box.boxSubTypeName">
          <span class="breadcrumb-separator">/</span>
          <a [routerLink]="['/projects', box.projectId, 'boxes']" [queryParams]="{boxType: box.boxTypeName, boxSubType: box.boxSubTypeName}" class="breadcrumb-item">{{ box.boxSubTypeName }}</a>
        </ng-container>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-item active">{{ box.code }}</span>
      </nav>

      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <div class="box-info">
            <h1 class="box-name">{{ box.name || box.code }}</h1>
            <span class="box-id">{{ box.code }}</span>
            <span class="status-badge" [ngClass]="getStatusClass(box.status)">
              {{ getStatusLabel(box.status) }}
            </span>
          </div>
          <div class="header-actions">
            <button class="action-btn btn-update" (click)="openBoxStatusModal()" *ngIf="canUpdateBoxStatus" title="Update Status">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
              </svg>
              <span>Update Status</span>
            </button>
            <button class="action-btn btn-edit" (click)="editBox()" *ngIf="canEdit" title="Edit Box">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              <span>Edit</span>
            </button>
            <button class="action-btn btn-delete" (click)="openDeleteConfirm()" *ngIf="canDelete" title="Delete Box">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              <span>Delete</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab" 
          [class.active]="activeTab === 'overview'"
          (click)="setActiveTab('overview')"
        >
          Overview
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'activities'"
          (click)="setActiveTab('activities')"
        >
          Activities
        </button>
        <button 
          class="tab"
          [class.active]="activeTab === 'wir'"
          (click)="setActiveTab('wir')"
        >
          WIR Checkpoints
        </button>
        <button 
          class="tab"
          [class.active]="activeTab === 'quality-issues'"
          (click)="setActiveTab('quality-issues')"
        >
          Quality Issues
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'logs'"
          (click)="setActiveTab('logs')"
        >
          Logs
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'drawings'"
          (click)="setActiveTab('drawings')"
        >
          Drawing
        </button>
        <button 
        class="tab" 
        [class.active]="activeTab === 'attachments'"
        (click)="setActiveTab('attachments')"
      >
        All Attachments
      </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'progress-updates'"
          (click)="setActiveTab('progress-updates')"
        >
          Progress History
        </button>
       
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <div *ngIf="activeTab === 'overview'" class="overview-tab">
          <!-- Two Column Layout -->
          <div class="two-column-layout">
            <!-- Left Column: Box Information -->
            <div class="left-column">
            <!-- Box Information Card -->
              <div class="info-card compact-card">
              <h3 class="card-title">Box Information</h3>
                <div class="info-grid-compact">
              
                <!-- Order matches tag format: Building -> Floor -> Box Type -> Box Sub Type -->
                <div class="info-item" *ngIf="box.buildingNumber">
                  <span class="label">Building Number</span>
                  <span class="value">{{ box.buildingNumber }}</span>
                </div>
                <div class="info-item" *ngIf="box.floor">
                  <span class="label">Floor</span>
                  <span class="value">{{ box.floor }}</span>
                </div>
                <div class="info-item" *ngIf="getBoxTypeFromTag()">
                  <span class="label">Box Type</span>
                  <span class="value">{{ getBoxTypeFromTag() }}</span>
                </div>
                <div class="info-item" *ngIf="getBoxSubTypeFromTag()">
                  <span class="label">Box Sub Type</span>
                  <span class="value">{{ getBoxSubTypeFromTag() }}</span>
                </div>
                <div class="info-item" *ngIf="box.boxFunction">
                  <span class="label">Box Function</span>
                  <span class="value">{{ box.boxFunction }}</span>
                </div>
                <div class="info-item" *ngIf="box.zone">
                  <span class="label">Zone</span>
                  <span class="value">{{ box.zone }}</span>
                </div>
                <div class="info-item" *ngIf="box.length">
                  <span class="label">Length</span>
                  <span class="value">{{ box.length }} m</span>
                </div>
                <div class="info-item" *ngIf="box.width">
                  <span class="label">Width</span>
                  <span class="value">{{ box.width }} m</span>
                </div>
                <div class="info-item" *ngIf="box.height">
                  <span class="label">Height</span>
                  <span class="value">{{ box.height }} m</span>
                </div>
                <div class="info-item" *ngIf="box.assignedTeam">
                  <span class="label">Assigned Team</span>
                  <span class="value">{{ box.assignedTeam }}</span>
                </div>
                <div class="info-item" *ngIf="box.assignedTo">
                  <span class="label">Assigned To</span>
                  <span class="value">{{ box.assignedTo }}</span>
                </div>
                <div class="info-item" *ngIf="box.duration">
                  <span class="label">Duration</span>
                  <span class="value">{{ box.duration }} days</span>
                </div>
                <div class="info-item" *ngIf="box.revitElementId">
                  <span class="label">Revit Group Element ID</span>
                  <span class="value">{{ box.revitElementId }}</span>
                </div>
                <div class="info-item" *ngIf="box.currentLocationCode">
                  <span class="label">Current Location</span>
                  <span class="value">
                    <a [routerLink]="['/locations', box.currentLocationId]" class="location-link">
                      {{ box.currentLocationCode }} - {{ box.currentLocationName }}
                    </a>
                  </span>
                </div>
                <div class="info-item" *ngIf="!box.currentLocationCode && !box.bay && !box.row && !box.position">
                  <span class="label">Current Location</span>
                  <span class="value text-muted">Not assigned</span>
                </div>
                <div class="info-item" *ngIf="box.bay || box.row || box.position">
                  <span class="label">Position (Bay / Row / Position)</span>
                  <span class="value">
                    <span *ngIf="box.bay" class="position-badge">Bay: {{ box.bay }}</span>
                    <span *ngIf="box.row" class="position-badge">Row: {{ box.row }}</span>
                    <span *ngIf="box.position" class="position-badge">Position: {{ box.position }}</span>
                  </span>
                </div>
                <div class="info-item" *ngIf="box.description">
                  <span class="label">Description</span>
                  <span class="value">{{ box.description }}</span>
                </div>
                <div class="info-item" *ngIf="box.notes">
                  <span class="label">Notes</span>
                  <span class="value">{{ box.notes }}</span>
                </div>
              </div>
              </div>
            </div>

            <!-- Right Column: Serial Number & QR Code -->
            <div class="right-column">
              <div class="info-card compact-card serial-qr-card" *ngIf="box.serialNumber || box.qrCode">
                <h3 class="card-title">Serial Number & QR Code</h3>
                
                <!-- Serial Number Section -->
                <div class="serial-number-section-compact" *ngIf="box.serialNumber">
                  <div class="serial-label">SERIAL NUMBER</div>
                  <div class="serial-value-container-compact">
                    <span class="serial-value-compact">{{ formatSerialNumber(box.serialNumber) }}</span>
                    <button 
                      class="btn-copy-compact" 
                      (click)="copyToClipboard(box.serialNumber)"
                      [class.copied]="copiedSerialNumber"
                      title="{{ copiedSerialNumber ? 'Copied!' : 'Copy' }}">
                      <svg *ngIf="!copiedSerialNumber" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                      </svg>
                      <svg *ngIf="copiedSerialNumber" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      Copy
                    </button>
                  </div>
                </div>

                <!-- QR Code Section -->
                <div class="qr-code-section-compact" *ngIf="box.qrCode">
                  <div class="qr-label-compact">QR CODE</div>
                  <div class="qr-container-compact">
                    <div class="qr-image-wrapper-compact">
                      <img [src]="box.qrCode" alt="QR Code" class="qr-code-image-compact" loading="lazy">
                    </div>
                    <button class="btn btn-primary btn-sm btn-download-compact" (click)="downloadQRCode()">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                      Download QR Code
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- End Two Column Layout -->

          <!-- Additional Overview Cards -->
          <div class="overview-additional-cards">
          <!-- Activities Chart Card -->
          <div class="info-card chart-card">
            <h3 class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"/>
                <line x1="18" y1="20" x2="18" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="16"/>
              </svg>
              Activity Progress Overview
            </h3>
            <div class="chart-container">
              <!-- Visual Chart Section -->
              <div class="visual-chart-section">
                <!-- Donut Chart -->
                <div class="donut-chart-wrapper">
                  <svg class="donut-chart" viewBox="0 0 200 200">
                    <!-- Background circle -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#e2e8f0" 
                      stroke-width="30"/>
                    
                    <!-- Completed segment (green) -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#22c55e" 
                      stroke-width="30"
                      [attr.stroke-dasharray]="getCircleSegment('Completed')"
                      [attr.stroke-dashoffset]="0"
                      transform="rotate(-90 100 100)"
                      class="segment completed-segment"/>
                    
                    <!-- In Progress segment (blue) -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#3b82f6" 
                      stroke-width="30"
                      [attr.stroke-dasharray]="getCircleSegment('InProgress')"
                      [attr.stroke-dashoffset]="getCircleOffset('InProgress')"
                      transform="rotate(-90 100 100)"
                      class="segment in-progress-segment"/>
                    
                    <!-- Not Started segment (gray) -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#94a3b8" 
                      stroke-width="30"
                      [attr.stroke-dasharray]="getCircleSegment('NotStarted')"
                      [attr.stroke-dashoffset]="getCircleOffset('NotStarted')"
                      transform="rotate(-90 100 100)"
                      class="segment not-started-segment"/>
                    
                    <!-- Center text -->
                    <text x="100" y="95" text-anchor="middle" class="chart-center-value">
                      {{ box.activitiesCount || box.activities?.length || 0 }}
                    </text>
                    <text x="100" y="115" text-anchor="middle" class="chart-center-label">
                      Activities
                    </text>
                  </svg>
                  
                  <!-- Chart Legend -->
                  <div class="chart-legend">
                    <div class="legend-item">
                      <div class="legend-color completed-color"></div>
                      <span class="legend-text">Completed ({{ getActivityPercentage('Completed') }}%)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color in-progress-color"></div>
                      <span class="legend-text">In Progress ({{ getActivityPercentage('InProgress') }}%)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color not-started-color"></div>
                      <span class="legend-text">Not Started ({{ getActivityPercentage('NotStarted') }}%)</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="activity-stats">
                <div class="stat-item">
                  <div class="stat-icon not-started">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ getActivityCountByStatus('NotStarted') }}</div>
                    <div class="stat-label">Not Started</div>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="stat-icon in-progress">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ getActivityCountByStatus('InProgress') }}</div>
                    <div class="stat-label">In Progress</div>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="stat-icon completed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                      <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ getActivityCountByStatus('Completed') }}</div>
                    <div class="stat-label">Completed</div>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="stat-icon total">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <line x1="3" y1="9" x2="21" y2="9"/>
                      <line x1="9" y1="21" x2="9" y2="9"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ box.activitiesCount || box.activities?.length || 0 }}</div>
                    <div class="stat-label">Total Activities</div>
                  </div>
                </div>
              </div>

           
            </div>
          </div>

          <!-- Progress Card -->
          <div class="info-card progress-card">
            <h3 class="card-title">Progress</h3>
            <div class="progress-container">
              <div class="progress-header">
                <span class="progress-label">Overall Completion</span>
                <span class="progress-value">{{ box.progress | number:'1.2-2' }}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="box.progress"></div>
              </div>
            </div>
          </div>

        

          <!-- Dates Card -->
          <div class="info-card">
            <h3 class="card-title">Schedule</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Planned Start</span>
                <span class="value">{{ box.plannedStartDate ? (box.plannedStartDate | date: 'MMM d, yyyy') : 'Not set' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Actual Start</span>
                <span class="value">{{ box.actualStartDate ? (box.actualStartDate | date: 'MMM d, yyyy') : 'Not started' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Planned End</span>
                <span class="value">{{ box.plannedEndDate ? (box.plannedEndDate | date: 'MMM d, yyyy') : 'Not set' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Actual End</span>
                <span class="value">{{ box.actualEndDate ? (box.actualEndDate | date: 'MMM d, yyyy') : 'Not completed' }}</span>
              </div>
            </div>
          </div>
        </div>
          <!-- End Additional Overview Cards -->
        </div>
        <!-- End Overview Tab -->

        <!-- Activities Tab -->
        <div *ngIf="activeTab === 'activities'" class="activities-tab">
          <app-activity-table
            [isProjectClosed]="isProjectClosed"
            [activities]="box.activities || []" 
            [projectId]="projectId"
            [boxId]="boxId"
            [boxStatus]="box.status"
            [isProjectOnHold]="isProjectOnHold"
            [isProjectArchived]="isProjectArchived"
            (boxDataChanged)="loadBox()"
            (activityCountChanged)="onActivityCountChanged($event)"
          ></app-activity-table>
        </div>

        <!-- WIR Tab -->
        <div *ngIf="activeTab === 'wir'" class="wir-tab">
          <!-- Enhanced Header Section -->
          <div class="wir-header-section">
            <div class="header-top">
              <div class="header-left">
                <div class="header-icon-wrapper">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                  </svg>
                </div>
                <div class="header-titles">
                  <h2 class="page-title">WIR Checkpoints</h2>
                  <p class="page-subtitle">Work Inspection Request • Quality Control</p>
                </div>
              </div>
              <div class="header-right">
                <button 
                  class="btn btn-outline btn-icon-refresh" 
                  (click)="refreshWIRCheckpoints()" 
                  [disabled]="wirLoading"
                  title="Refresh checkpoints"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <polyline points="1 20 1 14 7 14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"/>
                    <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"/>
                  </svg>
                  <span>Refresh</span>
                </button>
              </div>
            </div>
            
            <div class="header-description">
              <p>Quality control inspection points automatically created when checkpoint activities are completed. Each checkpoint requires review and approval before proceeding to the next stage of work.</p>
            </div>
            
            <!-- Status Summary Cards -->
            <div class="status-summary-grid" *ngIf="!wirLoading && !wirError && wirCheckpoints.length > 0">
              <div class="summary-card total">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                  </svg>
                </div>
                <div class="summary-content">
                  <div class="summary-value">{{ wirCheckpoints.length }}</div>
                  <div class="summary-label">Total</div>
                </div>
              </div>
              
              <div class="summary-card approved">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                </div>
                <div class="summary-content">
                  <div class="summary-value">{{ getApprovedCheckpointsCount() }}</div>
                  <div class="summary-label">Approved</div>
                </div>
              </div>
              
              <div class="summary-card pending" *ngIf="getPendingCheckpointsCount() > 0">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                </div>
                <div class="summary-content">
                  <div class="summary-value">{{ getPendingCheckpointsCount() }}</div>
                  <div class="summary-label">Pending Review</div>
                </div>
              </div>
              
              <div class="summary-card conditional">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    <circle cx="18" cy="6" r="2" fill="currentColor"/>
                  </svg>
                </div>
                <div class="summary-content">
                  <div class="summary-value">{{ getConditionalApprovedCheckpointsCount() }}</div>
                  <div class="summary-label">Conditional Approved</div>
                </div>
              </div>
              
              <div class="summary-card rejected">
                <div class="summary-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                  </svg>
                </div>
                <div class="summary-content">
                  <div class="summary-value">{{ getRejectedCheckpointsCount() }}</div>
                  <div class="summary-label">Rejected</div>
                </div>
              </div>
            </div>
          </div>

          <div class="wir-card-body">
            <div class="wir-loading-state" *ngIf="wirLoading">
              <div class="spinner small"></div>
              <p>Loading WIR checkpoints...</p>
            </div>

            <div class="wir-error-state" *ngIf="!wirLoading && wirError">
              <p>{{ wirError }}</p>
              <button class="btn btn-primary btn-sm" (click)="refreshWIRCheckpoints()">Retry</button>
            </div>

            <div class="wir-empty-state" *ngIf="!wirLoading && !wirError && wirCheckpoints.length === 0">
              <div class="empty-state-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
              </div>
              <h3 class="empty-state-title">No WIR Checkpoints Yet</h3>
              <p class="empty-state-description">Work Inspection Request checkpoints are automatically generated when you complete checkpoint activities.</p>
              <div class="empty-state-action">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4"/>
                  <path d="M12 8h.01"/>
                </svg>
                <span>Complete a checkpoint activity to generate its WIR</span>
              </div>
            </div>

            <div class="wir-checkpoints-list" *ngIf="!wirLoading && !wirError && wirCheckpoints.length > 0">
              <div class="wir-checkpoint-card" *ngFor="let checkpoint of wirCheckpoints">
                <!-- Card Header -->
                <div class="checkpoint-header">
                  <div class="checkpoint-id-section">
                    <div class="checkpoint-number">{{ checkpoint.wirNumber }}</div>
                    <div class="checkpoint-status-badge" [ngClass]="getWIRCheckpointStatusClass(checkpoint.status)">
                      <span class="status-indicator"></span>
                      {{ getWIRCheckpointStatusLabel(checkpoint.status) }}
                    </div>
                  </div>
                </div>

                <!-- Card Body -->
                <div class="checkpoint-body">
                  <h3 class="checkpoint-title">{{ checkpoint.wirName || 'Inspection Checkpoint' }}</h3>
                  <p class="checkpoint-description">{{ checkpoint.wirDescription || 'Auto-generated quality control checkpoint' }}</p>

                  <!-- Info Grid -->
                  <div class="checkpoint-info-grid">
                    <div class="info-item">
                      <div class="info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                          <line x1="16" y1="2" x2="16" y2="6"/>
                          <line x1="8" y1="2" x2="8" y2="6"/>
                          <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Requested</div>
                        <div class="info-value">{{ formatWIRDate(checkpoint.requestedDate) }}</div>
                        <div class="info-sub">{{ checkpoint.requestedBy || 'System' }}</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                          <circle cx="12" cy="7" r="4"/>
                        </svg>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Inspector</div>
                        <div class="info-value">{{ checkpoint.inspectorName || 'QC Engineer' }}</div>
                        <div class="info-sub">{{ checkpoint.inspectorRole || 'Pending assignment' }}</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M9 11l3 3L22 4"/>
                          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Checklist Items</div>
                        <div class="info-value">{{ checkpoint.checklistItems?.length || 0 }} items</div>
                        <div class="info-sub">to review</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12 6 12 12 16 14"/>
                        </svg>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Last Update</div>
                        <div class="info-value">{{ formatWIRDate(checkpoint.approvalDate || checkpoint.inspectionDate || checkpoint.createdDate) }}</div>
                        <div class="info-sub">{{ checkpoint.approvalDate ? 'Approved' : 'Awaiting approval' }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Card Actions -->
                <div class="checkpoint-actions">
                  <button 
                    *ngIf="canNavigateToAddChecklist(checkpoint)"
                    class="action-btn secondary" 
                    (click)="navigateToAddChecklist(checkpoint)"
                    title="Add or edit checklist items"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 5v14"/>
                      <path d="M5 12h14"/>
                    </svg>
                    <span>Add Checklist</span>
                  </button>
                 
                  <button 
                    *ngIf="canNavigateToReview(checkpoint)"
                    class="action-btn primary" 
                    (click)="navigateToReview(checkpoint)"
                    title="Open QA/QC review workflow"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    <span>Review</span>
                  </button>
                  
                  <button
                    class="action-btn outline"
                    (click)="exportWIRToPDF(checkpoint)"
                    title="Export WIR as PDF"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 6 2 18 2 18 9"/>
                      <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                      <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                    <span>Print</span>
                  </button>
                  
                  <button
                    class="action-btn outline"
                    (click)="downloadWIRAsPDF(checkpoint)"
                    title="Download WIR as PDF"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span>Download</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quality Issues Tab -->
        <div *ngIf="activeTab === 'quality-issues'" class="quality-tab">
          <div class="quality-card-header">
            <div class="quality-header-content">
              <div class="quality-title-section">
                <h2 class="card-title">Quality Issues</h2>
                <p class="card-subtitle">List of every quality issue logged for this box.</p>
              </div>
              <div class="quality-card-actions">
                <span class="quality-count-badge" *ngIf="!qualityIssuesLoading && !qualityIssuesError">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                  </svg>
                  {{ qualityIssueCount }} total
                </span>
                <button 
                  class="btn btn-success btn-sm quality-action-btn" 
                  (click)="openCreateQualityIssueModal()" 
                  [disabled]="qualityIssuesLoading"
                  *ngIf="canCreateQualityIssue"
                  title="Create new quality issue"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Create Issue
                </button>
                <button 
                  class="btn btn-primary btn-sm quality-action-btn" 
                  (click)="exportQualityIssuesToExcel()" 
                  [disabled]="qualityIssuesLoading || qualityIssues.length === 0"
                  title="Export quality issues to Excel"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  Export to Excel
                </button>
                <button 
                  class="btn btn-secondary btn-sm quality-action-btn" 
                  (click)="refreshQualityIssues()" 
                  [disabled]="qualityIssuesLoading"
                  title="Refresh quality issues"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <polyline points="1 20 1 14 7 14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"/>
                    <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"/>
                  </svg>
                  Refresh
                </button>
              </div>
            </div>
          </div>

          <div class="quality-card-body">
            <div class="quality-loading-state" *ngIf="qualityIssuesLoading">
              <div class="spinner small"></div>
              <p>Loading quality issues...</p>
            </div>

            <div class="quality-error-state" *ngIf="!qualityIssuesLoading && qualityIssuesError">
              <p>{{ qualityIssuesError }}</p>
              <button class="btn btn-primary btn-sm" (click)="refreshQualityIssues()">Retry</button>
            </div>

            <div class="quality-empty-state" *ngIf="!qualityIssuesLoading && !qualityIssuesError && qualityIssues.length === 0">
              <div class="empty-state-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  <path d="m9 12 2 2 4-4"/>
                </svg>
              </div>
              <h3 class="empty-state-title">No Quality Issues Logged</h3>
              <p class="empty-state-description">This box has a clean record with no quality issues reported. Quality issues will appear here once they are created and logged.</p>
              <div class="empty-state-action" *ngIf="canCreateQualityIssue">
                <button class="create-issue-btn" (click)="openCreateQualityIssueModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  <span>Create Quality Issue</span>
                </button>
              </div>
              <div class="empty-state-hint" *ngIf="!canCreateQualityIssue">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4"/>
                  <path d="M12 8h.01"/>
                </svg>
                <span>Quality issues can be created by authorized team members</span>
              </div>
            </div>

            <div class="quality-table-wrapper" *ngIf="!qualityIssuesLoading && !qualityIssuesError && qualityIssues.length > 0">
              <table class="designer-table quality-issues-table">
                <thead>
                  <tr>
                    <th class="col-seq">Seq</th>
                    <th class="col-wir">WIR</th>
                    <th class="col-extra">Issue Type</th>
                    <th class="col-extra">Severity</th>
                    <th class="col-extra">Assigned To</th>
                    <th class="col-extra">Due Date</th>
                    <th class="col-extra">Reported By</th>
                    <th class="col-extra">Issue Date</th>
                    <th class="col-extra">Status</th>
                    <th class="col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let issue of qualityIssues; let i = index" class="quality-issue-row">
                    <td class="text-center seq-cell">
                      <span class="seq-number">{{ i + 1 }}</span>
                    </td>
                    <td class="wir-cell">
                      <span class="wir-badge" [class.has-wir]="getQualityIssueWir(issue) !== '—'">
                        {{ getQualityIssueWir(issue) }}
                      </span>
                    </td>
                    <td class="issue-type-cell">
                      <span class="issue-type-badge">{{ issue.issueType || '—' }}</span>
                    </td>
                    <td class="severity-cell">
                      <span class="severity-badge" [ngClass]="'severity-' + (issue.severity ? issue.severity.toLowerCase() : 'none')">
                        {{ issue.severity || '—' }}
                      </span>
                    </td>
                    <td class="assigned-cell">{{ issue.assignedTeamName || '—' }}</td>
                    <td class="due-date-cell">{{ formatIssueDate(issue.dueDate) }}</td>
                    <td class="reported-cell">{{ issue.reportedBy || '—' }}</td>
                    <td class="issue-date-cell">{{ formatIssueDate(issue.issueDate) }}</td>
                    <td class="status-cell">
                      <span class="status-pill" [ngClass]="getQualityIssueStatusClass(issue.status)">
                        {{ getQualityIssueStatusLabel(issue.status) }}
                      </span>
                    </td>
                    <td class="col-actions">
                      <div class="action-stack">
                        <button 
                          class="action-btn ghost" 
                          title="View details" 
                          aria-label="View details"
                          (click)="openIssueDetails(issue)"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                          </svg>
                        </button>
                        <button 
                          class="action-btn assign" 
                          title="Assign to Team" 
                          aria-label="Assign to Team"
                          (click)="openAssignModal(issue); $event.stopPropagation()"
                          *ngIf="canUpdateQualityIssueStatus"
                          type="button"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                          </svg>
                        </button>
                        <button 
                          class="action-btn primary" 
                          title="Update status" 
                          aria-label="Update status"
                          (click)="openStatusModal(issue)"
                          *ngIf="canUpdateQualityIssueStatus"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/>
                            <path d="M14.06 4.94l3.75 3.75"/>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      <div class="status-modal-backdrop" *ngIf="isStatusModalOpen || isDetailsModalOpen">
        <div class="status-modal" *ngIf="isStatusModalOpen">
          <div class="modal-header">
            <div>
              <h3>Update Issue Status</h3>
              <p class="modal-subtitle">{{ selectedIssueForStatus?.issueType }} • {{ selectedIssueForStatus?.severity }}</p>
            </div>
            <button class="icon-button" (click)="closeStatusModal()" [disabled]="statusUpdateLoading">
              &times;
            </button>
          </div>

          <div class="modal-body">
            <label class="modal-label" for="statusSelect">Status</label>
            <select id="statusSelect" class="modal-input" [(ngModel)]="statusUpdateForm.status" name="statusSelect">
              <option *ngFor="let status of qualityIssueStatuses" [value]="status">
                {{ status === 'InProgress' ? 'In Progress' : status }}
              </option>
            </select>

            <label class="modal-label" for="resolutionDescription" *ngIf="requiresResolutionDescription(statusUpdateForm.status)">
              Resolution Notes <span class="required">*</span>
            </label>
            <textarea
              *ngIf="requiresResolutionDescription(statusUpdateForm.status)"
              id="resolutionDescription"
              class="modal-input"
              rows="3"
              placeholder="Add resolution details"
              [(ngModel)]="statusUpdateForm.resolutionDescription"
              name="resolutionDescription"
            ></textarea>

            <!-- Multiple Images Upload Section -->
            <div class="photo-upload-section">
              <label class="modal-label">Photos / Documents</label>
              <p class="photo-upload-hint">Upload multiple images from device, camera, or URLs</p>
              
              <!-- Tabs for different input methods -->
              <div class="photo-input-tabs">
                <button 
                  type="button"
                  class="tab-button"
                  [class.active]="currentImageInputMode === 'url' && !showCamera"
                  (click)="setImageInputMode('url')"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                  </svg>
                  URL
                </button>
                <button 
                  type="button"
                  class="tab-button"
                  [class.active]="currentImageInputMode === 'upload' && !showCamera"
                  (click)="openFileInput()"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  Upload
                </button>
                <button 
                  type="button"
                  class="tab-button"
                  [class.active]="currentImageInputMode === 'camera' && showCamera"
                  (click)="openCamera()"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                    <circle cx="12" cy="13" r="4"/>
                  </svg>
                  Camera
                </button>
              </div>

              <!-- URL Input -->
              <div *ngIf="currentImageInputMode === 'url' && !showCamera" class="photo-input-content">
                <div class="url-input-group">
                  <div class="url-input-wrapper">
                    <svg class="url-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                    <input
                      id="photoUrl"
                      class="modal-input url-input"
                      type="text"
                      placeholder="Enter image URL (e.g., https://example.com/photo.jpg)"
                      [(ngModel)]="currentUrlInput"
                      name="currentUrlInput"
                      (keyup.enter)="addImageFromUrl()"
                      [disabled]="statusUpdateLoading"
                    />
                  </div>
                  <button 
                    type="button" 
                    class="btn btn-primary btn-add-url"
                    (click)="addImageFromUrl()"
                    [disabled]="!currentUrlInput || !currentUrlInput.trim() || statusUpdateLoading"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add
                  </button>
                </div>
              </div>

              <!-- File Upload Input (hidden, supports multiple) -->
              <input
                id="box-details-photo-file-input"
                type="file"
                accept="image/*"
                multiple
                style="display: none"
                (change)="onFileSelected($event)"
                [disabled]="statusUpdateLoading"
              />

              <!-- Full Screen Camera Preview -->
              <div *ngIf="showCamera" class="camera-fullscreen-overlay" (click)="stopCamera()">
                <div class="camera-fullscreen-container" (click)="$event.stopPropagation()">
                  <div class="camera-header">
                    <h4>Camera</h4>
                    <button type="button" class="camera-close-btn" (click)="stopCamera()" title="Close Camera">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </button>
                  </div>
                  <video id="box-details-camera-preview" autoplay playsinline></video>
                  <div class="camera-controls-fullscreen">
                    <button type="button" class="btn btn-secondary btn-lg" (click)="stopCamera()">
                      Cancel
                    </button>
                    <button type="button" class="btn-capture" (click)="capturePhoto()" title="Capture Photo">
                      <div class="capture-button-inner"></div>
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" (click)="capturePhoto()">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                      Capture
                    </button>
                  </div>
                </div>
              </div>

              <!-- Selected Images Preview List -->
              <div *ngIf="selectedImages.length > 0 && !showCamera" class="images-preview-list">
                <div class="images-preview-header">
                  <span class="images-count">{{ selectedImages.length }} {{ selectedImages.length === 1 ? 'image' : 'images' }} selected</span>
                </div>
                <div class="images-grid">
                  <div *ngFor="let image of selectedImages; trackBy: trackByImageId" class="image-preview-item">
                    <div class="image-preview-wrapper">
                      <div class="image-overlay">
                        <button 
                          type="button" 
                          class="remove-image-btn" 
                          (click)="removeImage(image.id)"
                          [disabled]="statusUpdateLoading"
                          title="Remove image"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                          </svg>
                        </button>
                      </div>
                      <img [src]="image.preview" [alt]="image.name || 'Preview'" loading="lazy" />
                    </div>
                    <div class="image-preview-info">
                      <span class="image-name" *ngIf="image.name" [title]="image.name">{{ image.name.length > 25 ? (image.name.substring(0, 25) + '...') : image.name }}</span>
                      <div class="image-meta">
                        <span class="image-size" *ngIf="image.size">{{ (image.size / 1024).toFixed(1) }} KB</span>
                        <span class="image-type-badge" [class]="'type-' + image.type">
                          <svg *ngIf="image.type === 'file'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                            <polyline points="13 2 13 9 20 9"/>
                          </svg>
                          <svg *ngIf="image.type === 'url'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                          </svg>
                          <svg *ngIf="image.type === 'camera'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                          </svg>
                          {{ image.type }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Errors -->
              <p class="modal-error" *ngIf="photoUploadError">{{ photoUploadError }}</p>
            </div>

            <p class="modal-error" *ngIf="statusUpdateError">{{ statusUpdateError }}</p>
          </div>

          <div class="modal-actions">
            <button class="btn btn-secondary" (click)="closeStatusModal()" [disabled]="statusUpdateLoading">
              Cancel
            </button>
            <button 
              class="btn btn-primary" 
              (click)="submitStatusUpdate()" 
              [disabled]="!canSubmitStatusUpdate() || statusUpdateLoading"
            >
              <span *ngIf="statusUpdateLoading">Updating...</span>
              <span *ngIf="!statusUpdateLoading">Update Status</span>
            </button>
          </div>
        </div>

      

        <app-quality-issue-details-modal
          [issue]="selectedIssueDetails"
          [wirCheckpoints]="wirCheckpoints"
          [isOpen]="isDetailsModalOpen"
          (close)="closeIssueDetails()"
        ></app-quality-issue-details-modal>
        </div>

        <!-- Create Quality Issue Modal -->
        <div class="status-modal-backdrop" *ngIf="isCreateQualityIssueModalOpen">
          <div class="status-modal create-quality-issue-modal">
            <div class="modal-header">
              <div>
                <h3>Create Quality Issue</h3>
                <p class="modal-subtitle">{{ box && (box.name || box.code) }}</p>
              </div>
              <button class="icon-button" (click)="closeCreateQualityIssueModal()" [disabled]="createQualityIssueLoading">
                &times;
              </button>
            </div>

            <div class="modal-body">
              <!-- Issue Type -->
              <label class="modal-label" for="createIssueType">Issue Type <span class="required">*</span></label>
              <select id="createIssueType" class="modal-input" [(ngModel)]="newQualityIssueForm.issueType" name="createIssueType">
                <option *ngFor="let type of issueTypes" [value]="type">
                  {{ type === 'NonConformance' ? 'Non-Conformance' : type }}
                </option>
              </select>

              <!-- Severity -->
              <label class="modal-label" for="createSeverity">Severity <span class="required">*</span></label>
              <select id="createSeverity" class="modal-input" [(ngModel)]="newQualityIssueForm.severity" name="createSeverity">
                <option *ngFor="let severity of severityLevels" [value]="severity">
                  {{ severity }}
                </option>
              </select>

              <!-- Issue Description -->
              <label class="modal-label" for="createIssueDescription">Issue Description <span class="required">*</span></label>
              <textarea
                id="createIssueDescription"
                class="modal-input"
                rows="4"
                placeholder="Describe the issue in detail..."
                [(ngModel)]="newQualityIssueForm.issueDescription"
                name="createIssueDescription"
              ></textarea>

              <!-- Assigned To Team -->
              <label class="modal-label" for="createAssignedTo">Assigned To Team</label>
              <select
                id="createAssignedTo"
                class="modal-input"
                [(ngModel)]="newQualityIssueForm.assignedTo"
                name="createAssignedTo"
                [disabled]="loadingTeams || createQualityIssueLoading"
                (change)="onQualityIssueTeamChange()"
              >
                <option [value]="''">Select Team (Optional)</option>
                <option *ngFor="let team of availableTeams" [value]="team.teamId">
                  {{ team.teamName }} ({{ team.teamCode }})
                </option>
              </select>
              <div *ngIf="loadingTeams" class="loading-text" style="font-size: 12px; color: #64748b; margin-top: 4px;">
                Loading teams...
              </div>

              <!-- Assigned To User (within selected team) -->
              <label class="modal-label" for="createAssignedToUser" *ngIf="newQualityIssueForm.assignedTo">Assigned To User</label>
              <select
                id="createAssignedToUser"
                class="modal-input"
                [(ngModel)]="newQualityIssueForm.assignedToUserId"
                name="createAssignedToUser"
                [disabled]="loadingTeamUsers || createQualityIssueLoading || !newQualityIssueForm.assignedTo"
                *ngIf="newQualityIssueForm.assignedTo"
              >
                <option [value]="''">Select User (Optional)</option>
                <option *ngFor="let user of availableTeamUsers" [value]="user.userId">
                  {{ user.userName }} <span *ngIf="user.userEmail">({{ user.userEmail }})</span>
                </option>
              </select>
              <div *ngIf="loadingTeamUsers && newQualityIssueForm.assignedTo" class="loading-text" style="font-size: 12px; color: #64748b; margin-top: 4px;">
                Loading team members...
              </div>

              <!-- Due Date -->
              <label class="modal-label" for="createDueDate">Due Date</label>
              <input
                id="createDueDate"
                type="date"
                class="modal-input"
                [(ngModel)]="newQualityIssueForm.dueDate"
                name="createDueDate"
              />

              <!-- Multiple Images Upload Section -->
              <div class="photo-upload-section">
                <label class="modal-label">Photos / Documents</label>
                <p class="photo-upload-hint">Upload multiple images from device, camera, or URLs</p>
                
                <!-- Tabs for different input methods -->
                <div class="photo-input-tabs">
                  <button 
                    type="button"
                    class="tab-button"
                    [class.active]="currentImageInputMode === 'url' && !showCamera"
                    (click)="setQualityIssueImageInputMode('url')"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                    URL
                  </button>
                  <button 
                    type="button"
                    class="tab-button"
                    [class.active]="currentImageInputMode === 'upload' && !showCamera"
                    (click)="openQualityIssueFileInput()"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload
                  </button>
                  <button 
                    type="button"
                    class="tab-button"
                    [class.active]="currentImageInputMode === 'camera' && showCamera"
                    (click)="openQualityIssueCamera()"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                      <circle cx="12" cy="13" r="4"/>
                    </svg>
                    Camera
                  </button>
                </div>

                <!-- URL Input -->
                <div *ngIf="currentImageInputMode === 'url' && !showCamera" class="photo-input-content">
                  <div class="url-input-group">
                    <div class="url-input-wrapper">
                      <svg class="url-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                      </svg>
                      <input
                        id="qualityIssuePhotoUrl"
                        class="modal-input url-input"
                        type="text"
                        placeholder="Enter image URL (e.g., https://example.com/photo.jpg)"
                        [(ngModel)]="currentUrlInput"
                        name="currentUrlInput"
                        (keyup.enter)="addQualityIssueImageUrl()"
                        [disabled]="createQualityIssueLoading"
                      />
                    </div>
                    <button 
                      type="button" 
                      class="btn btn-primary btn-add-url"
                      (click)="addQualityIssueImageUrl()"
                      [disabled]="!currentUrlInput || !currentUrlInput.trim() || createQualityIssueLoading"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                      Add
                    </button>
                  </div>
                </div>

                <!-- File Upload Input (hidden, supports multiple) -->
                <input
                  id="qualityIssueFileInput"
                  type="file"
                  accept="image/*"
                  multiple
                  style="display: none"
                  (change)="onQualityIssueFileSelected($event)"
                  [disabled]="createQualityIssueLoading"
                />

                <!-- Full Screen Camera Preview -->
                <div *ngIf="showCamera" class="camera-fullscreen-overlay" (click)="closeQualityIssueCamera()">
                  <div class="camera-fullscreen-container" (click)="$event.stopPropagation()">
                    <div class="camera-header">
                      <h4>Camera</h4>
                      <button type="button" class="camera-close-btn" (click)="closeQualityIssueCamera()" title="Close Camera">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="18" y1="6" x2="6" y2="18"/>
                          <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                      </button>
                    </div>
                    <video id="qualityIssueCameraVideo" autoplay playsinline></video>
                    <div class="camera-controls-fullscreen">
                      <button type="button" class="btn btn-secondary btn-lg" (click)="closeQualityIssueCamera()">
                        Cancel
                      </button>
                      <button type="button" class="btn-capture" (click)="captureQualityIssuePhoto()" title="Capture Photo">
                        <div class="capture-button-inner"></div>
                      </button>
                      <button type="button" class="btn btn-primary btn-lg" (click)="captureQualityIssuePhoto()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Capture
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Selected Images Preview List -->
                <div *ngIf="qualityIssueImages.length > 0 && !showCamera" class="images-preview-list">
                  <div class="images-preview-header">
                    <span class="images-count">{{ qualityIssueImages.length }} {{ qualityIssueImages.length === 1 ? 'image' : 'images' }} selected</span>
                  </div>
                  <div class="images-grid">
                    <div *ngFor="let image of qualityIssueImages; trackBy: trackByImageId" class="image-preview-item">
                      <div class="image-preview-wrapper">
                        <div class="image-overlay">
                          <button 
                            type="button" 
                            class="remove-image-btn" 
                            (click)="removeQualityIssueImage(image.id)"
                            [disabled]="createQualityIssueLoading"
                            title="Remove image"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                              <line x1="18" y1="6" x2="6" y2="18"/>
                              <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                          </button>
                        </div>
                        <img [src]="image.preview" [alt]="image.name || 'Preview'" loading="lazy" />
                      </div>
                      <div class="image-preview-info">
                        <span class="image-name" *ngIf="image.name" [title]="image.name">{{ image.name.length > 25 ? (image.name.substring(0, 25) + '...') : image.name }}</span>
                        <div class="image-meta">
                          <span class="image-size" *ngIf="image.size">{{ (image.size / 1024).toFixed(1) }} KB</span>
                          <span class="image-type-badge" [class]="'type-' + image.type">
                            <svg *ngIf="image.type === 'file'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                              <polyline points="13 2 13 9 20 9"/>
                            </svg>
                            <svg *ngIf="image.type === 'url'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                            </svg>
                            <svg *ngIf="image.type === 'camera'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                              <circle cx="12" cy="13" r="4"/>
                            </svg>
                            {{ image.type }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <p class="modal-error" *ngIf="createQualityIssueError">{{ createQualityIssueError }}</p>
            </div>

            <div class="modal-actions">
              <button class="btn btn-secondary" (click)="closeCreateQualityIssueModal()" [disabled]="createQualityIssueLoading">
                Cancel
              </button>
              <button 
                class="btn btn-primary" 
                (click)="createQualityIssue()" 
                [disabled]="!newQualityIssueForm.issueDescription || !newQualityIssueForm.issueDescription.trim() || createQualityIssueLoading"
              >
                <span *ngIf="createQualityIssueLoading">Creating...</span>
                <span *ngIf="!createQualityIssueLoading">Create Issue</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Logs Tab -->
        <div *ngIf="activeTab === 'logs'" class="logs-tab">
          <div class="box-logs-card">
            <div class="card-header">
              <div>
                <h3>Box Logs</h3>
                <p class="subtitle">Complete audit trail of all actions performed on this box</p>
              </div>
              <div class="card-header-actions">
                <button 
                  class="btn btn-secondary btn-sm" 
                  (click)="toggleBoxLogsSearch()"
                  [class.active]="showBoxLogsSearch"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                  </svg>
                  {{ showBoxLogsSearch ? 'Hide Search' : 'Search' }}
                </button>
                <button 
                  class="btn btn-primary btn-sm" 
                  (click)="exportBoxLogsToExcel()" 
                  [disabled]="boxLogsLoading || boxLogsTotalCount === 0"
                  title="Export logs to Excel"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Export to Excel
                </button>
                <button 
                  class="btn btn-secondary btn-sm" 
                  (click)="loadBoxLogs(boxLogsCurrentPage, boxLogsPageSize)" 
                  [disabled]="boxLogsLoading"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <polyline points="1 20 1 14 7 14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"/>
                    <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"/>
                  </svg>
                  Refresh
                </button>
              </div>
            </div>

            <!-- Filters Section (matching Audit Logs) -->
            <div class="filters-section" *ngIf="showBoxLogsSearch">
              <div class="filter-row">
                <div class="filter-field">
                  <label for="boxLogsAction">Action</label>
                  <select id="boxLogsAction" [(ngModel)]="boxLogsAction" class="filter-input">
                    <option value="">All Actions</option>
                    <option *ngFor="let action of availableBoxLogActions; trackBy: trackByAction" [value]="action">
                      {{ action }}
                    </option>
                  </select>
                </div>

                <div class="filter-field">
                  <label for="boxLogsSearchTerm">Search</label>
                  <input 
                    type="text" 
                    id="boxLogsSearchTerm" 
                    [(ngModel)]="boxLogsSearchTerm" 
                    placeholder="Search in logs..."
                    class="filter-input"
                  />
                </div>

                <div class="filter-field">
                  <label for="boxLogsFromDate">From Date</label>
                  <input 
                    type="date" 
                    id="boxLogsFromDate" 
                    [(ngModel)]="boxLogsFromDate" 
                    class="filter-input"
                  />
                </div>

                <div class="filter-field">
                  <label for="boxLogsToDate">To Date</label>
                  <input 
                    type="date" 
                    id="boxLogsToDate" 
                    [(ngModel)]="boxLogsToDate" 
                    class="filter-input"
                  />
                </div>
              </div>

              <div class="filter-actions">
                <button class="btn btn-secondary" (click)="resetBoxLogsFilters()">Reset</button>
                <button class="btn btn-primary" (click)="applyBoxLogsFilters()">Apply Filters</button>
              </div>
            </div>

            <!-- Search Toggle Button -->
            <div class="search-toggle-container" *ngIf="!showBoxLogsSearch">
              <button type="button" class="btn btn-outline btn-sm" (click)="toggleBoxLogsSearch()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
                Search & Filter
              </button>
            </div>

            <div *ngIf="boxLogsError" class="alert alert-error">
              <span>{{ boxLogsError }}</span>
            </div>

            <div *ngIf="boxLogsLoading && !boxLogsError" class="loading-state">
              <span class="spinner large"></span>
              <p>Loading box logs...</p>
            </div>

            <!-- Logs Container (matching Audit Logs) -->
            <div class="logs-container" *ngIf="!boxLogsLoading && !boxLogsError">
              <!-- Empty State -->
              <div class="empty-state" *ngIf="boxLogs.length === 0">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                <h3>No Box Logs Found</h3>
                <p>No logs match your current filters. Try adjusting your search criteria.</p>
              </div>

              <!-- Log Entries (Timeline Format) -->
              <div class="logs-timeline">
                <div
                  class="log-entry"
                  *ngFor="let log of boxLogs; trackBy: trackByLogId; let last = last"
                  [class.last-entry]="last"
                  [class.quality-issue-log-entry]="isQualityIssueLog(log)"
                  role="button"
                  tabindex="0"
                  (click)="openBoxLogDetails(log)"
                  (keydown.enter)="openBoxLogDetails(log); $event.preventDefault()"
                  (keydown.space)="openBoxLogDetails(log); $event.preventDefault()"
                >
                  <!-- Timeline Connector -->
                  <div class="timeline-connector" *ngIf="!last"></div>
                  
                  <!-- Timeline Dot -->
                  <div class="timeline-dot" 
                       [class]="isQualityIssueLog(log) ? 'dot-quality-issue' : 'dot-' + getActionType(log.action)">
                    <!-- Quality Issue Icon -->
                    <svg *ngIf="isQualityIssueLog(log)" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                      <line x1="12" y1="9" x2="12" y2="13"/>
                      <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <!-- Regular Icons -->
                    <svg *ngIf="!isQualityIssueLog(log) && getActionType(log.action) === 'create'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    <svg *ngIf="!isQualityIssueLog(log) && getActionType(log.action) === 'update'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    <svg *ngIf="!isQualityIssueLog(log) && getActionType(log.action) === 'delete'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    <svg *ngIf="!isQualityIssueLog(log) && getActionType(log.action) === 'assignment'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                      <circle cx="8.5" cy="7" r="4"/>
                      <line x1="20" y1="8" x2="20" y2="14"/>
                      <line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                    <svg *ngIf="!isQualityIssueLog(log) && getActionType(log.action) === 'default'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="16" x2="12" y2="12"/>
                      <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                  </div>

                  <!-- Log Content -->
                  <div class="log-content">
                    <div class="log-header">
                      <div class="log-title-row">
                        <div class="log-action-title">
                          <span class="action-badge" [class]="'badge-' + getActionType(log.action)">
                            {{ DiffUtil.getActionLabel(log.action) }}
                          </span>
                          <span class="entity-info">
                            <span class="entity-type">{{ isQualityIssueLog(log) ? 'QualityIssue' : 'Box' }}</span>
                            <span class="entity-name" *ngIf="log.entityDisplayName">"{{ log.entityDisplayName }}"</span>
                            <span class="entity-name" *ngIf="!log.entityDisplayName && box">"{{ box.name || box.code }}"</span>
                          </span>
                        </div>
                        <div class="log-meta-info">
                          <span class="log-date">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <circle cx="12" cy="12" r="10"/>
                              <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            {{ formatBoxLogDate(log.performedAt) }}
                          </span>
                        </div>
                      </div>
                      
                      <p class="log-description" *ngIf="log.description">
                        {{ formatBoxLogDescription(log.description) }}
                      </p>
                      
                      <div class="log-user" *ngIf="log.performedBy">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                          <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>by {{ log.performedBy }}</span>
                      </div>
                    </div>

                    <!-- Changes List -->
                    <div class="log-changes" *ngIf="log.field || log.oldValue || log.newValue">
                      <div class="changes-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="9 11 12 14 22 4"/>
                          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        <span>Field Changes</span>
                      </div>
                      <div class="changes-list">
                        <div class="change-item">
                          <span class="change-field">{{ log.field || 'Field' }}</span>
                          <div class="change-values">
                            <span class="change-old">{{ DiffUtil.formatValue(log.oldValue) }}</span>
                            <span class="change-arrow">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                                <polyline points="12 5 19 12 12 19"/>
                              </svg>
                            </span>
                            <span class="change-new">{{ DiffUtil.formatValue(log.newValue) }}</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- No Changes Message -->
                    <div class="log-no-changes" *ngIf="!log.field && !log.oldValue && !log.newValue && !log.description">
                      <span class="no-changes-text">{{ getBoxLogNoChangeSummary(log) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-container" *ngIf="!boxLogsLoading && !boxLogsError && boxLogsTotalPages > 0">
              <div class="pagination-info">
                <span>Showing {{ (boxLogsCurrentPage - 1) * boxLogsPageSize + 1 }} - {{ Math.min(boxLogsCurrentPage * boxLogsPageSize, boxLogsTotalCount) }} of {{ boxLogsTotalCount }} logs</span>
                <div class="page-size-selector">
                  <label for="boxLogsPageSize">Items per page:</label>
                  <select id="boxLogsPageSize" [ngModel]="boxLogsPageSize" (ngModelChange)="onBoxLogsPageSizeChange($event)" class="page-size-select">
                    <option [value]="10">10</option>
                    <option [value]="25">25</option>
                    <option [value]="50">50</option>
                    <option [value]="100">100</option>
                  </select>
                </div>
              </div>
              <div class="pagination-controls">
                <button 
                  class="pagination-btn" 
                  [disabled]="boxLogsCurrentPage === 1"
                  (click)="onBoxLogsPageChange(1)"
                  title="First page"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="11 17 6 12 11 7"/>
                    <polyline points="18 17 13 12 18 7"/>
                  </svg>
                </button>
                <button 
                  class="pagination-btn" 
                  [disabled]="boxLogsCurrentPage === 1"
                  (click)="onBoxLogsPageChange(boxLogsCurrentPage - 1)"
                  title="Previous page"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                  </svg>
                </button>
                <div class="page-numbers">
                  <button 
                    *ngFor="let page of getBoxLogsPageNumbers()"
                    class="page-number"
                    [class.active]="page === boxLogsCurrentPage"
                    (click)="onBoxLogsPageChange(page)"
                  >
                    {{ page }}
                  </button>
                </div>
                <button 
                  class="pagination-btn" 
                  [disabled]="boxLogsCurrentPage === boxLogsTotalPages"
                  (click)="onBoxLogsPageChange(boxLogsCurrentPage + 1)"
                  title="Next page"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </button>
                <button 
                  class="pagination-btn" 
                  [disabled]="boxLogsCurrentPage === boxLogsTotalPages"
                  (click)="onBoxLogsPageChange(boxLogsTotalPages)"
                  title="Last page"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="13 17 18 12 13 7"/>
                    <polyline points="6 17 11 12 6 7"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

        </div>

        <!-- Drawing Tab -->
        <div *ngIf="activeTab === 'drawings'" class="drawings-tab">
          <!-- Loading State -->
          <div class="loading-state" *ngIf="loadingBoxDrawings">
            <div class="spinner"></div>
            <p>Loading drawings...</p>
          </div>

          <!-- Error State -->
          <div class="error-state" *ngIf="!loadingBoxDrawings && boxDrawingsError">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h3>Error Loading Drawings</h3>
            <p>{{ boxDrawingsError }}</p>
            <button class="btn btn-primary" (click)="loadBoxDrawings()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"/>
                <polyline points="1 20 1 14 7 14"/>
                <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"/>
                <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"/>
              </svg>
              Retry
            </button>
          </div>

          <!-- Sub-navigation for Drawings -->
          <div *ngIf="!loadingBoxDrawings && !boxDrawingsError" class="drawing-header-container">
            <div class="drawing-sub-nav">
              <button 
                class="sub-tab-btn" 
                [class.active]="activeDrawingTab === 'file'"
                (click)="setActiveDrawingTab('file')"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                  <polyline points="13 2 13 9 20 9"/>
                </svg>
                Files
                <span class="count-badge">{{ getFileTypeImages().length }}</span>
              </button>
              <button 
                class="sub-tab-btn" 
                [class.active]="activeDrawingTab === 'url'"
                (click)="setActiveDrawingTab('url')"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                URLs
                <span class="count-badge">{{ getUrlTypeImages().length }}</span>
              </button>
            </div>
            <button 
              *ngIf="canUploadDrawing"
              class="btn btn-primary btn-upload-drawing" 
              (click)="openUploadDrawingModal()"
              title="Upload Drawing"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Upload Drawing
            </button>
          </div>

          <!-- Empty State -->
          <div class="empty-state" *ngIf="!loadingBoxDrawings && !boxDrawingsError && boxDrawings.length === 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
            <h3>No URLs</h3>
            <p>No URLs attached to this box</p>
          </div>

          <!-- File Drawings Section (PDF/DWG files) - Grouped by filename with versions -->
          <div *ngIf="!loadingBoxDrawings && !boxDrawingsError && activeDrawingTab === 'file' && getFileTypeImages().length > 0" class="progress-images-section">
            <div class="section-header">
              <h3 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                  <polyline points="13 2 13 9 20 9"/>
                </svg>
                Uploaded Files
              </h3>
              <span class="section-count">{{ getFileTypeImages().length }} file(s)</span>
            </div>
            
            <!-- Group files by name -->
            <div class="file-group" *ngFor="let group of getGroupedFileTypeImages()">
              <!-- File Group Header (if multiple versions) -->
              <div class="file-group-header" *ngIf="group.versions.length > 1" [class.expanded]="isFileGroupExpanded(group.fileName)">
                <div class="file-group-header-left" (click)="toggleFileGroupExpansion(group.fileName)">
                  <svg class="chevron-icon" [class.rotated]="isFileGroupExpanded(group.fileName)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                  <h4 class="file-group-name">{{ group.fileName }}</h4>
                </div>
                <div class="file-group-header-right">
                  <button class="version-history-btn" (click)="openVersionHistory(group); $event.stopPropagation()" title="View version history">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Version History
                  </button>
                  <span class="version-count-badge" (click)="toggleFileGroupExpansion(group.fileName)" title="Click to toggle versions">
                    {{ isFileGroupExpanded(group.fileName) ? group.versions.length + ' version(s) expanded' : 'Show all ' + group.versions.length + ' versions' }}
                  </span>
                </div>
              </div>
              
              <!-- All versions for this file (ordered newest first) -->
              <div class="file-drawing-item" *ngFor="let drawing of getVisibleVersions(group); let i = index">
                <div class="file-drawing-card" (click)="openFileDrawing(drawing)">
                  <!-- Version Badge - Always show -->
                  <div class="version-badge">
                    V{{ drawing.version || 1 }}
                  </div>
                  <!-- Latest Version Badge (when collapsed and multiple versions exist) -->
                  <div class="latest-badge" *ngIf="group.versions.length > 1 && !isFileGroupExpanded(group.fileName) && i === 0">
                    Latest
                  </div>
                  
                  <div class="file-icon-wrapper">
                    <svg *ngIf="drawing.fileExtension?.toLowerCase() === '.pdf'" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                      <polyline points="13 2 13 9 20 9"/>
                      <line x1="13" y1="2" x2="13" y2="9" x2="20" y2="9"/>
                    </svg>
                    <svg *ngIf="drawing.fileExtension?.toLowerCase() !== '.pdf'" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                      <polyline points="13 2 13 9 20 9"/>
                    </svg>
                  </div>
                  <div class="file-info">
                    <h4 class="file-name" [title]="drawing.fileName || 'Untitled'">
                      {{ drawing.fileName || 'Untitled' }}
                    </h4>
                    <p class="file-meta">
                      <span class="file-extension">{{ drawing.fileExtension?.toUpperCase() || 'FILE' }}</span>
                      <span class="file-size" *ngIf="drawing.fileSize">{{ formatFileSize(drawing.fileSize) }}</span>
                    </p>
                    <p class="file-date" *ngIf="drawing.updateDate">Uploaded on {{ drawing.updateDate | date: 'MMM d, yyyy' }}</p>
                    <p class="file-creator" *ngIf="drawing.createdByName">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                      </svg>
                      {{ drawing.createdByName }}
                    </p>
                  </div>
                  <div class="file-actions">
                    <button class="btn-download" (click)="downloadFileDrawing(drawing); $event.stopPropagation()" title="Download">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- File Drawings Empty State -->
          <div class="empty-state" *ngIf="!loadingBoxDrawings && !boxDrawingsError && activeDrawingTab === 'file' && getFileTypeImages().length === 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <h3>No File Drawings</h3>
            <p>No uploaded files (PDF/DWG) found for this box</p>
          </div>

          <!-- URL Images Section -->
          <div *ngIf="!loadingBoxDrawings && !boxDrawingsError && activeDrawingTab === 'url' && getUrlTypeImages().length > 0" class="progress-images-section">
            <div class="section-header">
              <h3 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                URL Links
              </h3>
              <span class="section-count">{{ getUrlTypeImages().length }} link(s)</span>
            </div>
            <div class="url-links-gallery">
              <div class="url-link-item" *ngFor="let urlItem of getUrlTypeImages(); let i = index">
                <div class="url-link-card" (click)="openUrl(urlItem.displayUrl || urlItem.imageUrl || urlItem.originalUrl || '')">
                  <!-- Version Badge - Always show -->
                  <div class="version-badge">
                    V{{ urlItem.version || 1 }}
                  </div>
                  <div class="url-icon-wrapper">
                    <svg *ngIf="isImageUrl(urlItem.displayUrl || urlItem.imageUrl || '')" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="8.5" cy="8.5" r="1.5"/>
                      <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <svg *ngIf="!isImageUrl(urlItem.displayUrl || urlItem.imageUrl || '')" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                  </div>
                  <div class="url-info">
                    <h4 class="url-title" [title]="urlItem.displayUrl || urlItem.imageUrl || urlItem.originalUrl || 'URL'">
                      {{ (urlItem.displayUrl || urlItem.imageUrl || urlItem.originalUrl || 'URL').substring(0, 60) }}{{ (urlItem.displayUrl || urlItem.imageUrl || urlItem.originalUrl || '').length > 60 ? '...' : '' }}
                    </h4>
                    <p class="url-link" [title]="urlItem.displayUrl || urlItem.imageUrl || urlItem.originalUrl || ''">
                      {{ urlItem.displayUrl || urlItem.imageUrl || urlItem.originalUrl || 'No URL' }}
                    </p>
                    <p class="url-date" *ngIf="urlItem.updateDate">{{ urlItem.updateDate | date: 'MMM d, yyyy' }}</p>
                    <p class="url-creator" *ngIf="urlItem.createdByName">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                      </svg>
                      {{ urlItem.createdByName }}
                    </p>
                  </div>
                  <div class="url-actions">
                    <button class="btn-open-url" (click)="openUrl(urlItem.displayUrl || urlItem.imageUrl || urlItem.originalUrl || ''); $event.stopPropagation()" title="Open URL">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- URL Images Empty State -->
          <div class="empty-state" *ngIf="!loadingBoxDrawings && !boxDrawingsError && activeDrawingTab === 'url' && getUrlTypeImages().length === 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            <h3>No URLs</h3>
            <p>No URL-based drawings found for this box</p>
          </div>

          <!-- Version History Sidebar -->
          <div class="version-history-sidebar" *ngIf="versionHistorySidebarOpen" [@slideIn]>
            <div class="version-sidebar-header">
              <div class="version-sidebar-title">
                <div class="title-content">
                  <div class="title-row">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <h3>Version history</h3>
                    <svg class="warning-icon" *ngIf="currentFileVersions.length > 10" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" title="Many versions">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                      <line x1="12" y1="9" x2="12" y2="13"/>
                      <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                  </div>
                  <div class="file-name-subtitle" *ngIf="currentFileName">
                    {{ currentFileName }}
                  </div>
                </div>
              </div>
              <button class="version-sidebar-close" (click)="closeVersionHistory()" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>

            <div class="version-sidebar-controls">
              <div class="compare-button-wrapper">
              <button class="compare-versions-btn" [class.active]="compareMode" (click)="toggleCompareMode()" [disabled]="currentFileVersions.length < 2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="16 3 21 3 21 8"/>
                  <line x1="4" y1="20" x2="21" y2="3"/>
                  <polyline points="21 16 21 21 16 21"/>
                  <line x1="15" y1="15" x2="21" y2="21"/>
                  <line x1="4" y1="4" x2="9" y2="9"/>
                </svg>
                {{ compareMode ? 'Cancel Compare' : 'Compare versions' }}
              </button>
                <span class="coming-soon-badge-inline">Coming Soon</span>
              </div>
              <button class="execute-compare-btn" *ngIf="compareMode && selectedVersionsForCompare.length === 2" (click)="compareSelectedVersions()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Compare Selected
              </button>
            </div>

            <div class="version-sidebar-content">
              
              <!-- Empty State -->
              <div class="version-empty-state" *ngIf="currentFileVersions.length === 0">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                <h3>No versions found</h3>
                <p>There are no version history records for this file.</p>
              </div>

              <!-- Versions List -->
              <div class="versions-list" *ngIf="currentFileVersions.length > 0">
                <div class="version-item" *ngFor="let version of currentFileVersions; let i = index" 
                     [class.selected]="isVersionSelected(version)"
                     [class.selectable]="compareMode"
                     (click)="compareMode && toggleVersionSelection(version)">
                  
                  <div class="version-checkbox" *ngIf="compareMode">
                    <input type="checkbox" 
                           [checked]="isVersionSelected(version)" 
                           [id]="'version-' + version.version"
                           (change)="toggleVersionSelection(version)">
                    <label [for]="'version-' + version.version"></label>
                  </div>

                  <div class="version-badge-circle">
                    <span class="version-number">V{{ version.version || 1 }}</span>
                  </div>

                  <div class="version-details">
                    <div class="version-file-info">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                        <polyline points="13 2 13 9 20 9"/>
                      </svg>
                      <span class="version-filename">{{ version.fileName || version.originalFileName || 'Untitled' }}</span>
                    </div>
                    <div class="version-meta">
                      <span class="version-uploader">Uploaded by <strong>{{ version.createdByName || 'Unknown' }}</strong></span>
                      <span class="version-date">on {{ getFormattedDateTime(version.updateDate || version.createdDate) }}</span>
                    </div>
                    <div class="version-size" *ngIf="version.fileSize">
                      {{ formatFileSize(version.fileSize) }}
                    </div>
                  </div>

                  <div class="version-actions">
                    <button class="version-action-btn view-btn" (click)="openFileDrawing(version); $event.stopPropagation()" title="View">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                    </button>
                    <button class="version-action-btn download-btn" (click)="downloadFileDrawing(version); $event.stopPropagation()" title="Download">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                    </button>
                  </div>

                  <div class="version-more" (click)="$event.stopPropagation()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="1"/>
                      <circle cx="19" cy="12" r="1"/>
                      <circle cx="5" cy="12" r="1"/>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <div class="version-count-footer" *ngIf="currentFileVersions.length > 0">
              Showing {{ currentFileVersions.length }} version(s)
            </div>
          </div>

          <!-- Sidebar Overlay -->
          <div class="version-sidebar-overlay" *ngIf="versionHistorySidebarOpen" (click)="closeVersionHistory()"></div>
        </div>


        <!-- Progress Updates Tab -->
        <div *ngIf="activeTab === 'progress-updates'" class="progress-updates-tab">
         
          <app-progress-updates-table
            [updates]="progressUpdates"
            [loading]="progressUpdatesLoading"
            [error]="progressUpdatesError"
            [currentPage]="progressUpdatesCurrentPage"
            [pageSize]="progressUpdatesPageSize"
            [totalCount]="progressUpdatesTotalCount"
            [totalPages]="progressUpdatesTotalPages"
            [showSearch]="showProgressUpdatesSearch"
            [searchTerm]="progressUpdatesSearchTerm"
            [activityName]="progressUpdatesActivityName"
            [status]="progressUpdatesStatus"
            [fromDate]="progressUpdatesFromDate"
            [toDate]="progressUpdatesToDate"
            (refresh)="loadProgressUpdates(progressUpdatesCurrentPage, progressUpdatesPageSize, true)"
            (viewDetails)="openProgressDetails($event)"
            (pageChange)="loadProgressUpdates($any($event), progressUpdatesPageSize)"
            (pageSizeChange)="loadProgressUpdates(1, $any($event))"
            (searchChange)="onProgressUpdatesSearchChange($any($event))"
            (clearSearch)="clearProgressUpdatesSearch()"
            (toggleSearch)="toggleProgressUpdatesSearch()"
          ></app-progress-updates-table>
        </div>

        <!-- All Attachments Tab -->
        <div *ngIf="activeTab === 'attachments'" class="attachments-tab">
          <!-- Loading State -->
          <div class="loading-state" *ngIf="loadingBoxAttachments">
            <div class="spinner"></div>
            <p>Loading attachments...</p>
          </div>

          <!-- Error State -->
          <div class="error-state" *ngIf="!loadingBoxAttachments && boxAttachmentsError">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h3>Error Loading Attachments</h3>
            <p>{{ boxAttachmentsError }}</p>
            <button class="btn btn-primary" (click)="loadAllBoxAttachments()">Retry</button>
          </div>

          <!-- Empty State -->
          <div class="empty-state" *ngIf="!loadingBoxAttachments && !boxAttachmentsError && boxAttachments && boxAttachments.totalCount === 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
            <h3>No Attachments</h3>
            <p>No attachments found for this box</p>
          </div>

          <!-- Attachments Content -->
          <div *ngIf="!loadingBoxAttachments && !boxAttachmentsError && boxAttachments && boxAttachments.totalCount > 0" class="attachments-content">
            <div class="attachments-summary">
              <div class="summary-left">
                <h3>All Box Attachments</h3>
              </div>
              <div class="summary-right">
                <span class="total-count">{{ boxAttachments.totalCount }} total attachments</span>
                <div class="expand-collapse-buttons">
                  <button class="btn-expand-collapse" (click)="expandAllAttachments()" title="Expand All">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="7 13 12 18 17 13"/>
                      <polyline points="7 6 12 11 17 6"/>
                    </svg>
                    Expand All
                  </button>
                  <button class="btn-expand-collapse" (click)="collapseAllAttachments()" title="Collapse All">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="17 11 12 6 7 11"/>
                      <polyline points="17 18 12 13 7 18"/>
                    </svg>
                    Collapse All
                  </button>
                </div>
              </div>
            </div>

            <!-- WIR Checkpoint Images -->
            <div class="attachment-section" *ngIf="boxAttachments.wirCheckpointImages && boxAttachments.wirCheckpointImages.length > 0">
              <div class="section-header" (click)="toggleWirImages()">
                <h3 class="section-title">
                  <svg class="chevron-icon" [class.expanded]="wirImagesExpanded" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                  </svg>
                  WIR Checkpoint Images
                </h3>
                <span class="section-count">{{ boxAttachments.wirCheckpointImages.length }} image(s)</span>
              </div>
              <div class="images-gallery" *ngIf="wirImagesExpanded" [@slideDown]>
                <!-- Group images by filename -->
                <div class="file-group" *ngFor="let group of getGroupedWirImages()">
                  <!-- Group Header (if multiple versions) -->
                  <div class="file-group-header" *ngIf="group.versions.length > 1" [class.expanded]="isWirImageGroupExpanded(group.fileName)">
                    <div class="file-group-header-left" (click)="toggleWirImageGroupExpansion(group.fileName)">
                      <svg class="chevron-icon" [class.rotated]="isWirImageGroupExpanded(group.fileName)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                      <h4 class="file-group-name">{{ group.fileName }}</h4>
                    </div>
                    <div class="file-group-header-right">
                      <span class="version-count-badge" (click)="toggleWirImageGroupExpansion(group.fileName)" title="Click to toggle versions">
                        {{ isWirImageGroupExpanded(group.fileName) ? group.versions.length + ' version(s) expanded' : 'Show all ' + group.versions.length + ' versions' }}
                      </span>
                    </div>
                  </div>
                  
                  <!-- Image cards for this group -->
                  <div class="image-card" *ngFor="let image of getVisibleWirImageVersions(group); let i = index">
                    <div class="image-wrapper" (click)="openImagePreview(image.imageData, image.imageType)">
                      <!-- Version Badge - Always show -->
                      <div class="version-badge">
                        V{{ image.version || 1 }}
                      </div>
                      <!-- Latest Badge (when collapsed) -->
                      <div class="latest-badge" *ngIf="group.versions.length > 1 && !isWirImageGroupExpanded(group.fileName) && i === 0">
                        Latest
                      </div>
                      <img [src]="formatImageData(image.imageData, image.imageType)" [alt]="image.originalName || 'WIR image'">
                      <div class="image-overlay">
                        <div class="overlay-actions">
                          <button class="overlay-btn view-btn" (click)="openImagePreview(image.imageData, image.imageType); $event.stopPropagation()" title="View full size">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                              <circle cx="12" cy="12" r="3"/>
                            </svg>
                          </button>
                          <button class="overlay-btn download-btn" (click)="downloadAttachmentImage(image.imageData, image.imageType, image.originalName); $event.stopPropagation()" title="Download image">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                              <polyline points="7 10 12 15 17 10"/>
                              <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="image-info">
                      <p class="image-name">{{ image.originalName || 'Image' }}</p>
                      <p class="image-date">{{ image.createdDate | date: 'MMM d, yyyy' }}</p>
                      <p class="image-size" *ngIf="image.fileSize">{{ formatFileSize(image.fileSize) }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Progress Update Images -->
            <div class="attachment-section" *ngIf="boxAttachments.progressUpdateImages && boxAttachments.progressUpdateImages.length > 0">
              <div class="section-header" (click)="toggleProgressImages()">
                <h3 class="section-title">
                  <svg class="chevron-icon" [class.expanded]="progressImagesExpanded" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                  </svg>
                  Progress Update Images
                </h3>
                <span class="section-count">{{ boxAttachments.progressUpdateImages.length }} image(s)</span>
              </div>
              <div class="images-gallery" *ngIf="progressImagesExpanded" [@slideDown]>
                <!-- Group images by filename -->
                <div class="file-group" *ngFor="let group of getGroupedProgressImages()">
                  <!-- Group Header (if multiple versions) -->
                  <div class="file-group-header" *ngIf="group.versions.length > 1" [class.expanded]="isProgressImageGroupExpanded(group.fileName)">
                    <div class="file-group-header-left" (click)="toggleProgressImageGroupExpansion(group.fileName)">
                      <svg class="chevron-icon" [class.rotated]="isProgressImageGroupExpanded(group.fileName)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                      <h4 class="file-group-name">{{ group.fileName }}</h4>
                    </div>
                    <div class="file-group-header-right">
                      <span class="version-count-badge" (click)="toggleProgressImageGroupExpansion(group.fileName)" title="Click to toggle versions">
                        {{ isProgressImageGroupExpanded(group.fileName) ? group.versions.length + ' version(s) expanded' : 'Show all ' + group.versions.length + ' versions' }}
                      </span>
                    </div>
                  </div>
                  
                  <!-- Image cards for this group -->
                  <div class="image-card" *ngFor="let image of getVisibleProgressImageVersions(group); let i = index">
                    <div class="image-wrapper" (click)="openImagePreview(image.imageData, image.imageType)">
                      <!-- Version Badge - Always show -->
                      <div class="version-badge">
                        V{{ image.version || 1 }}
                      </div>
                      <!-- Activity Name Badge - Clickable -->
                      <div class="activity-badge" 
                           *ngIf="image.activityName && image.boxActivityId"
                           [routerLink]="['/projects', projectId, 'boxes', boxId, 'activities', image.boxActivityId]"
                           [queryParams]="{ returnTo: 'attachments' }"
                           (click)="$event.stopPropagation()"
                           title="Go to activity details">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M9 11l3 3L22 4"/>
                          <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                        </svg>
                        {{ image.activityName }}
                      </div>
                      <!-- Latest Badge (when collapsed) -->
                      <div class="latest-badge" *ngIf="group.versions.length > 1 && !isProgressImageGroupExpanded(group.fileName) && i === 0">
                        Latest
                      </div>
                      <img [src]="formatImageData(image.imageData, image.imageType)" [alt]="image.originalName || 'Progress image'">
                      <div class="image-overlay">
                        <div class="overlay-actions">
                          <button class="overlay-btn view-btn" (click)="openImagePreview(image.imageData, image.imageType); $event.stopPropagation()" title="View full size">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                              <circle cx="12" cy="12" r="3"/>
                            </svg>
                          </button>
                          <button class="overlay-btn download-btn" (click)="downloadAttachmentImage(image.imageData, image.imageType, image.originalName); $event.stopPropagation()" title="Download image">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                              <polyline points="7 10 12 15 17 10"/>
                              <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="image-info">
                      <p class="image-name">{{ image.originalName || 'Image' }}</p>
                      <p class="image-date">{{ image.createdDate | date: 'MMM d, yyyy' }}</p>
                      <p class="image-activity" *ngIf="image.activityName && image.boxActivityId">
                        <a [routerLink]="['/projects', projectId, 'boxes', boxId, 'activities', image.boxActivityId]" 
                           [queryParams]="{ returnTo: 'attachments' }"
                           class="activity-link" 
                           title="View activity details">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                          </svg>
                          {{ image.activityName }}
                        </a>
                      </p>
                      <p class="image-size" *ngIf="image.fileSize">{{ formatFileSize(image.fileSize) }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quality Issue Images -->
            <div class="attachment-section" *ngIf="boxAttachments.qualityIssueImages && boxAttachments.qualityIssueImages.length > 0">
              <div class="section-header" (click)="toggleQualityImages()">
                <h3 class="section-title">
                  <svg class="chevron-icon" [class.expanded]="qualityImagesExpanded" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  Quality Issue Images
                </h3>
                <span class="section-count">{{ boxAttachments.qualityIssueImages.length }} image(s)</span>
              </div>
              <div class="images-gallery" *ngIf="qualityImagesExpanded" [@slideDown]>
                <!-- Group images by filename -->
                <div class="file-group" *ngFor="let group of getGroupedQualityImages()">
                  <!-- Group Header (if multiple versions) -->
                  <div class="file-group-header" *ngIf="group.versions.length > 1" [class.expanded]="isQualityImageGroupExpanded(group.fileName)">
                    <div class="file-group-header-left" (click)="toggleQualityImageGroupExpansion(group.fileName)">
                      <svg class="chevron-icon" [class.rotated]="isQualityImageGroupExpanded(group.fileName)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                      <h4 class="file-group-name">{{ group.fileName }}</h4>
                    </div>
                    <div class="file-group-header-right">
                      <span class="version-count-badge" (click)="toggleQualityImageGroupExpansion(group.fileName)" title="Click to toggle versions">
                        {{ isQualityImageGroupExpanded(group.fileName) ? group.versions.length + ' version(s) expanded' : 'Show all ' + group.versions.length + ' versions' }}
                      </span>
                    </div>
                  </div>
                  
                  <!-- Image cards for this group -->
                  <div class="image-card" *ngFor="let image of getVisibleQualityImageVersions(group); let i = index">
                    <div class="image-wrapper" (click)="openImagePreview(image.imageData, image.imageType)">
                      <!-- Version Badge - Always show -->
                      <div class="version-badge">
                        V{{ image.version || 1 }}
                      </div>
                      <!-- Latest Badge (when collapsed) -->
                      <div class="latest-badge" *ngIf="group.versions.length > 1 && !isQualityImageGroupExpanded(group.fileName) && i === 0">
                        Latest
                      </div>
                      <!-- Box Code Badge (clickable) -->
                      <div class="box-code-badge" 
                           (click)="openQualityIssueFromImage(image.referenceId); $event.stopPropagation()"
                           title="Click to view quality issue details">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        {{image.issueType}} - {{image.issueSeverity}}
                      </div>
                     
                      <img [src]="formatImageData(image.imageData, image.imageType)" [alt]="image.originalName || 'Quality issue image'">
                      <div class="image-overlay">
                        <div class="overlay-actions">
                          <button class="overlay-btn view-btn" (click)="openImagePreview(image.imageData, image.imageType); $event.stopPropagation()" title="View full size">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                              <circle cx="12" cy="12" r="3"/>
                            </svg>
                          </button>
                          <button class="overlay-btn download-btn" (click)="downloadAttachmentImage(image.imageData, image.imageType, image.originalName); $event.stopPropagation()" title="Download image">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                              <polyline points="7 10 12 15 17 10"/>
                              <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="image-info">
                      <p class="image-name">{{ image.originalName || 'Image' }}</p>
                      <p class="image-date">{{ image.createdDate | date: 'MMM d, yyyy' }}</p>
                      <p class="image-size" *ngIf="image.fileSize">{{ formatFileSize(image.fileSize) }}</p>
                      <p class="image-wir-code" *ngIf="image.wirCode">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                          <polyline points="14 2 14 8 20 8"/>
                          <line x1="16" y1="13" x2="8" y2="13"/>
                          <line x1="16" y1="17" x2="8" y2="17"/>
                          <polyline points="10 9 9 9 8 9"/>
                        </svg>
                        WIR: {{ image.wirCode }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="progress-modal-backdrop" *ngIf="isProgressModalOpen && selectedProgressUpdate" (click)="closeProgressDetails()">
  <div class="progress-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
        </div>
        <div>
          <h2>Progress Update Details</h2>
          <p class="header-subtitle">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            {{ selectedProgressUpdate.updateDate | date: 'MMM d, yyyy' }} at {{ selectedProgressUpdate.updateDate | date: 'h:mm a' }}
          </p>
        </div>
      </div>
      <button class="icon-button" (click)="closeProgressDetails()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <!-- Key Metrics Section -->
      <div class="metrics-section">
        <div class="metric-card primary">
          <div class="metric-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
          </div>
          <div class="metric-content">
            <label>Activity Progress</label>
            <div class="metric-value">
              <span class="progress-pill-large" [ngClass]="{
                'pill-low': selectedProgressUpdate.progressPercentage < 25,
                'pill-medium': selectedProgressUpdate.progressPercentage >= 25 && selectedProgressUpdate.progressPercentage < 75,
                'pill-high': selectedProgressUpdate.progressPercentage >= 75
              }">
                {{ selectedProgressUpdate.progressPercentage | number:'1.2-2' }}%
              </span>
            </div>
          </div>
        </div>
        <div class="metric-card" *ngIf="selectedProgressUpdate.boxProgressSnapshot !== undefined && selectedProgressUpdate.boxProgressSnapshot !== null">
          <div class="metric-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <line x1="9" y1="3" x2="9" y2="21"/>
              <line x1="3" y1="9" x2="21" y2="9"/>
            </svg>
          </div>
          <div class="metric-content">
            <label>Box Progress</label>
            <div class="metric-value">
              <span class="progress-pill-large box-progress" [ngClass]="{
                'pill-low': (selectedProgressUpdate.boxProgressSnapshot ?? 0) < 25,
                'pill-medium': (selectedProgressUpdate.boxProgressSnapshot ?? 0) >= 25 && (selectedProgressUpdate.boxProgressSnapshot ?? 0) < 75,
                'pill-high': (selectedProgressUpdate.boxProgressSnapshot ?? 0) >= 75
              }">
                {{ (selectedProgressUpdate.boxProgressSnapshot ?? 0) | number:'1.2-2' }}%
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Details Grid -->
      <div class="details-section">
        <div class="detail-item">
          <div class="detail-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v20M2 12h20"/>
            </svg>
            Activity
          </div>
          <div class="detail-value">{{ selectedProgressUpdate.activityName || '—' }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
            Status
          </div>
          <div class="detail-value">
            <span class="status-badge-modal" [ngClass]="getProgressStatusClass(selectedProgressUpdate.status)">
              {{ getProgressStatusLabel(selectedProgressUpdate.status) }}
            </span>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            Updated By
          </div>
          <div class="detail-value">{{ selectedProgressUpdate.updatedByName || selectedProgressUpdate.updatedBy || '—' }}</div>
        </div>
        <div class="detail-item" *ngIf="selectedProgressUpdate.updateMethod">
          <div class="detail-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
            Update Method
          </div>
          <div class="detail-value">{{ selectedProgressUpdate.updateMethod }}</div>
        </div>
        <div class="detail-item" *ngIf="selectedProgressUpdate.locationDescription">
          <div class="detail-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            Location
          </div>
          <div class="detail-value">{{ selectedProgressUpdate.locationDescription }}</div>
        </div>
      </div>

      <!-- Work Description -->
      <div class="text-section" *ngIf="selectedProgressUpdate.workDescription">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          <h3>Work Description</h3>
        </div>
        <div class="section-content">
          <p>{{ selectedProgressUpdate.workDescription }}</p>
        </div>
      </div>

      <!-- Issues Encountered -->
      <div class="text-section issues-section" *ngIf="selectedProgressUpdate.issuesEncountered">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <h3>Issues Encountered</h3>
        </div>
        <div class="section-content">
          <p>{{ selectedProgressUpdate.issuesEncountered }}</p>
        </div>
      </div>

      <!-- Photos -->
      <div class="photo-section" *ngIf="getPhotoUrls(selectedProgressUpdate).length > 0">
        <div class="section-header">
          <div class="header-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </div>
          <div>
            <h3>Photos</h3>
            <p class="section-subtitle">{{ getPhotoUrls(selectedProgressUpdate).length }} photo{{ getPhotoUrls(selectedProgressUpdate).length !== 1 ? 's' : '' }} attached</p>
          </div>
        </div>
        <div class="photo-gallery">
          <div class="photo-item" *ngFor="let photoUrl of getPhotoUrls(selectedProgressUpdate); let i = index">
            <div class="photo-wrapper">
              <img [src]="photoUrl" 
                   [alt]="'Progress photo ' + (i + 1)"
                   class="photo-thumbnail"
                   (click)="openPhotoInNewTab(photoUrl)"
                   (error)="onImageError($event)"
                   loading="lazy" />
              <div class="photo-overlay">
                <button class="photo-view-btn" (click)="openPhotoInNewTab(photoUrl); $event.stopPropagation()" title="View full size">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
                <button class="photo-download-btn" (click)="downloadPhoto(photoUrl); $event.stopPropagation()" title="Download photo">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                </button>
              </div>
              <div class="photo-number">{{ i + 1 }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <!-- Assign to Crew Modal -->
  <app-assign-to-crew-modal
    [issue]="selectedIssueForAssign"
    [isOpen]="isAssignModalOpen"
    (close)="closeAssignModal()"
    (assign)="onAssignToCrew($event)"
  ></app-assign-to-crew-modal>
<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" *ngIf="showDeleteConfirm" (click)="cancelDelete()">
  <div class="confirm-modal" (click)="$event.stopPropagation()">
    <!-- Success Message -->
    <div class="modal-success-state" *ngIf="deleteSuccess">
      <div class="success-icon-wrapper">
        <div class="success-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
        </div>
      </div>
      <div class="modal-content">
        <h3>Box Deleted Successfully</h3>
        <p>The box has been permanently removed from the project.</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" type="button" (click)="cancelDelete()">
          Close
        </button>
      </div>
    </div>
    
    <!-- Error Message -->
    <div class="modal-error-state" *ngIf="error && !deleteSuccess">
      <div class="error-icon-wrapper">
        <div class="error-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
        </div>
      </div>
      <div class="modal-content">
        <h3>Error Deleting Box</h3>
        <p>{{ error }}</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline-secondary" type="button" (click)="cancelDelete()">
          Close
        </button>
        <button class="btn btn-danger-primary" type="button" (click)="deleteBox()">
          Try Again
        </button>
      </div>
    </div>

    <!-- Default Delete Confirmation -->
    <div *ngIf="!deleteSuccess && !error">
      <div class="modal-icon-wrapper">
        <div class="modal-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
          </svg>
        </div>
      </div>
      <div class="modal-content">
        <h3>Delete this box?</h3>
        <p>This action cannot be undone. Are you sure you want to permanently remove this box and all its associated data from the project?</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline-secondary" type="button" (click)="cancelDelete()" [disabled]="deleting">
          Cancel
        </button>
        <button class="btn btn-danger-primary" type="button" (click)="deleteBox()" [disabled]="deleting">
          <span class="spinner small" *ngIf="deleting"></span>
          <span *ngIf="!deleting">Delete Box</span>
          <span *ngIf="deleting">Deleting...</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Box Status Update Modal -->
<div class="modal-backdrop" *ngIf="isBoxStatusModalOpen" (click)="closeBoxStatusModal()">
  <div class="box-status-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M2 12h20"/>
          </svg>
        </div>
        <div>
          <h3>Update Box Status</h3>
          <p class="modal-subtitle">{{ box?.name || box?.code }}</p>
        </div>
      </div>
      <button class="icon-button" (click)="closeBoxStatusModal()" [disabled]="boxStatusUpdateLoading" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Status Transition Display -->
      <div class="status-transition" *ngIf="box">
        <div class="status-item current">
          <div class="status-label">Current Status</div>
          <div class="status-badge-wrapper">
            <span class="status-badge" [ngClass]="getStatusClass(box.status)">
              <span class="status-dot"></span>
              {{ getStatusLabel(box.status) }}
            </span>
          </div>
        </div>
        
        <div class="status-arrow" *ngIf="selectedBoxStatus">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </div>
        
        <div class="status-item new" *ngIf="selectedBoxStatus">
          <div class="status-label">New Status</div>
          <div class="status-badge-wrapper">
            <span class="status-badge" [ngClass]="getStatusClass(selectedBoxStatus)">
              <span class="status-dot"></span>
              {{ getStatusLabelForModal(selectedBoxStatus) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Status Selection -->
      <div class="status-selection-wrapper">
        <label class="form-label" for="boxStatusSelect">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          Select New Status
        </label>
        <div class="select-wrapper">
          <select 
            id="boxStatusSelect" 
            class="status-select" 
            [(ngModel)]="selectedBoxStatus"
            [disabled]="boxStatusUpdateLoading"
          >
            <option [value]="null">Choose a status...</option>
            <option *ngFor="let status of availableBoxStatuses" [value]="status">
              {{ getStatusLabelForModal(status) }}
            </option>
          </select>
          <svg class="select-arrow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </div>
      </div>

      <!-- Error Message -->
      <div class="error-message" *ngIf="boxStatusUpdateError">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>{{ boxStatusUpdateError }}</span>
      </div>
    </div>
    
    <div class="modal-actions">
      <button 
        class="btn btn-secondary" 
        (click)="closeBoxStatusModal()" 
        [disabled]="boxStatusUpdateLoading"
      >
        Cancel
      </button>
      <button 
        class="btn btn-primary" 
        (click)="updateBoxStatus()" 
        [disabled]="boxStatusUpdateLoading || !selectedBoxStatus"
      >
        <svg *ngIf="!boxStatusUpdateLoading" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        <span class="spinner-small" *ngIf="boxStatusUpdateLoading"></span>
        <span>{{ boxStatusUpdateLoading ? 'Updating...' : 'Update Status' }}</span>
      </button>
    </div>
  </div>
</div>

<app-box-log-details-modal
  [visible]="isBoxLogDetailsModalOpen"
  [log]="selectedBoxLog"
  [boxName]="box?.name || box?.code"
  (closed)="closeBoxLogDetails()"
></app-box-log-details-modal>

<app-upload-drawing-modal
  [isOpen]="isUploadDrawingModalOpen"
  [boxId]="boxId"
  [boxName]="box?.name || box?.code || ''"
  [boxStatus]="box?.status"
  [isProjectOnHold]="isProjectOnHold"
  [isProjectArchived]="isProjectArchived"
  (closed)="closeUploadDrawingModal()"
  (uploaded)="onDrawingUploaded()"
></app-upload-drawing-modal>

