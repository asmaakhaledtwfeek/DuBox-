<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <div class="breadcrumb" *ngIf="showBoxTypes">
          <button class="breadcrumb-link" (click)="backToProject()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Project
          </button>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">Box Types</span>
        </div>
        <div class="breadcrumb" *ngIf="!showBoxTypes && selectedBoxType">
          <button class="breadcrumb-link" (click)="backToBoxTypes()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Box Types
          </button>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">{{ selectedBoxType }}</span>
        </div>
        <h1 class="page-title">{{ showBoxTypes ? 'Box Types' : 'Boxes' }}</h1>
        <p class="page-subtitle" *ngIf="projectName || projectCode">
          <span *ngIf="projectCode" class="project-code">{{ projectCode }}</span>
          <span *ngIf="projectName" class="project-name">{{ projectName }}</span>
        </p>
        <p class="page-helper">
          {{ showBoxTypes ? 'Select a box type to view boxes' : 'Manage boxes for ' + selectedBoxType }}
        </p>
      </div>
      <div class="header-right" *ngIf="canCreate">
        <button class="btn btn-primary" (click)="createBox()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Box
        </button>
      </div>
    </div>

    <!-- Filters (only show when viewing boxes) -->
    <div class="filters-section" *ngIf="!showBoxTypes">
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="text" 
          placeholder="Search boxes by name, code, serial number, type, or activity (name, status, assigned to, dates)..." 
          [formControl]="searchControl"
          class="search-input"
        />
      </div>

      <div class="filter-buttons">
        <button 
          class="filter-btn" 
          [class.active]="selectedStatus === 'All'"
          (click)="filterByStatus('All')"
        >
          All
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedStatus === BoxStatus.NotStarted"
          (click)="filterByStatus(BoxStatus.NotStarted)"
        >
          Not Started
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedStatus === BoxStatus.InProgress"
          (click)="filterByStatus(BoxStatus.InProgress)"
        >
          In Progress
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedStatus === BoxStatus.Completed"
          (click)="filterByStatus(BoxStatus.Completed)"
        >
          Completed
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedStatus === BoxStatus.Dispatched"
          (click)="filterByStatus(BoxStatus.Dispatched)"
        >
          Dispatched
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading boxes...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadBoxes()">Retry</button>
    </div>

    <!-- Box Types Grid -->
    <div class="boxes-grid" *ngIf="showBoxTypes && !loading && !error">
      <!-- Empty State -->
      <div class="empty-state" *ngIf="boxTypes.length === 0">
        <div class="empty-state-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="7.5 4.21 12 6.81 16.5 4.21"/>
            <polyline points="7.5 19.79 7.5 14.6 3 12"/>
            <polyline points="21 12 16.5 14.6 16.5 19.79"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
        </div>
        <div class="empty-state-content">
          <h3 class="empty-state-title">No Boxes Yet</h3>
          <p class="empty-state-description">Start building your project by creating your first box. Boxes help you organize and track different components of your project.</p>
          <button class="btn btn-primary btn-create" (click)="createBox()" *ngIf="canCreate">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Create Your First Box
          </button>
        </div>
      </div>

      <!-- Box Type Cards -->
      <div class="box-card" *ngFor="let boxType of boxTypes" (click)="viewBoxType(boxType.boxType)">
        <div class="card-header">
          <div class="box-info">
            <h3 class="box-name">{{ boxType.boxType }}</h3>
            <span class="box-code">{{ boxType.boxCount }} {{ boxType.boxCount === 1 ? 'box' : 'boxes' }}</span>
          </div>
        </div>

        <div class="card-body">
          <div class="box-progress">
            <div class="progress-header">
              <span class="progress-label">Overall Progress</span>
              <span class="progress-value">{{ Math.round(boxType.overallProgress) }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="boxType.overallProgress"></div>
            </div>
          </div>

          <div class="box-stats">
            <div class="stat-item">
              <span class="stat-label">Total Boxes</span>
              <span class="stat-value">{{ boxType.boxCount }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Progress</span>
              <span class="stat-value">{{ Math.round(boxType.overallProgress) }}%</span>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button class="btn-text" (click)="viewBoxType(boxType.boxType); $event.stopPropagation()">
            View Boxes
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Boxes Grid -->
    <div class="boxes-grid" *ngIf="!showBoxTypes && !loading && !error">
      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredBoxes.length === 0">
        <div class="empty-state-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="7.5 4.21 12 6.81 16.5 4.21"/>
            <polyline points="7.5 19.79 7.5 14.6 3 12"/>
            <polyline points="21 12 16.5 14.6 16.5 19.79"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
        </div>
        <div class="empty-state-content">
          <h3 class="empty-state-title">{{ boxes.length === 0 ? 'No Boxes in This Type' : 'No Results Found' }}</h3>
          <p class="empty-state-description">{{ boxes.length === 0 ? 'Start organizing this box type by adding boxes. Each box can contain multiple activities and track progress.' : 'Try adjusting your search or filter criteria to find what you\'re looking for.' }}</p>
          <button class="btn btn-primary btn-create" (click)="createBox()" *ngIf="canCreate && boxes.length === 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Box
          </button>
        </div>
      </div>

      <!-- Box Cards -->
      <div class="box-card" *ngFor="let box of filteredBoxes" (click)="viewBox(box.id)">
        <div class="card-header">
          <div class="box-info">
            <h3 class="box-name">{{ box.name || box.code }}</h3>
            <span class="box-code">{{ box.code }}</span>
          </div>
          <span class="badge" [ngClass]="getStatusClass(box.status)">
            {{ getStatusLabel(box.status) }}
          </span>
        </div>

        <div class="card-body">
          <div class="box-details">
            <div class="detail-item" *ngIf="box.type">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              </svg>
              <span>{{ box.type }}</span>
            </div>
            
            <div class="detail-item" *ngIf="box.assignedTeam">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              <span>{{ box.assignedTeam }}</span>
            </div>
          </div>

          <div class="box-progress">
            <div class="progress-header">
              <span class="progress-label">Progress</span>
              <span class="progress-value">{{ box.progress }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="box.progress"></div>
            </div>
          </div>

          <div class="box-stats">
            <div class="stat-item">
              <span class="stat-label">Activities</span>
              <span class="stat-value">{{ box.activitiesCount }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Attachments</span>
              <span class="stat-value">{{ box.attachments?.length || 0 }}</span>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button class="btn-text" (click)="viewBox(box.id); $event.stopPropagation()">
            View Details
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
