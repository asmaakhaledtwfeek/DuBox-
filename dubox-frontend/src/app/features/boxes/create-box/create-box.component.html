<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn-back" (click)="onCancel()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Back to Boxes
        </button>
        <h1 class="page-title">Create New Box</h1>
        <p class="page-subtitle">Add a new modular box to the project</p>
      </div>
    </div>

    <!-- Success Message -->
    <div class="alert alert-success" *ngIf="successMessage">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
      {{ successMessage }}
    </div>

    <!-- Error Message -->
    <div class="alert alert-error" *ngIf="error">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      {{ error }}
    </div>

    <!-- Stepper -->
    <div class="stepper-container">
      <div class="stepper">
        <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1" (click)="goToStep(1)">
          <div class="step-number">
            <span *ngIf="currentStep > 1">âœ“</span>
            <span *ngIf="currentStep <= 1">1</span>
          </div>
          <div class="step-label">Box Details</div>
        </div>
        <div class="step-connector" [class.completed]="currentStep > 1"></div>
        <div class="step" [class.active]="currentStep === 2" (click)="goToStep(2)">
          <div class="step-number">2</div>
          <div class="step-label">Add Assets</div>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form [formGroup]="boxForm" (ngSubmit)="onSubmit()" class="box-form">
      <!-- Step 1: Box Details -->
      <div class="step-content" *ngIf="currentStep === 1">
        <!-- Basic Information -->
        <div class="form-card">
          <div class="card-header">
            <h3>Basic Information</h3>
            <p>Enter the basic details about the box</p>
          </div>

          <div class="card-body">
            <div class="form-row">
              <!-- Box Tag -->
              <div class="form-group">
                <label for="boxTag" class="form-label required">Box Tag</label>
                <input
                  id="boxTag"
                  type="text"
                  formControlName="boxTag"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('boxTag')"
                  placeholder="e.g., B1-GF-LIV-01"
                />
                <div class="error-message" *ngIf="isFieldInvalid('boxTag')">
                  {{ getFieldError('boxTag') }}
                </div>
              </div>

              <!-- Box Name -->
              <div class="form-group">
                <label for="boxName" class="form-label">Box Name</label>
                <input
                  id="boxName"
                  type="text"
                  formControlName="boxName"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('boxName')"
                  placeholder="e.g., Living Room 01"
                />
                <div class="error-message" *ngIf="isFieldInvalid('boxName')">
                  {{ getFieldError('boxName') }}
                </div>
              </div>
            </div>

            <div class="form-row">
              <!-- Box Type -->
              <div class="form-group">
                <label for="boxType" class="form-label required">Box Type</label>
                <select
                  id="boxType"
                  formControlName="boxType"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('boxType')"
                >
                  <option *ngFor="let type of boxTypes" [value]="type">{{ type }}</option>
                </select>
                <div class="error-message" *ngIf="isFieldInvalid('boxType')">
                  {{ getFieldError('boxType') }}
                </div>
              </div>

              <!-- Floor -->
              <div class="form-group">
                <label for="floor" class="form-label required">Floor</label>
                <select
                  id="floor"
                  formControlName="floor"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('floor')"
                >
                  <option *ngFor="let floor of floors" [value]="floor">{{ floor }}</option>
                </select>
                <div class="error-message" *ngIf="isFieldInvalid('floor')">
                  {{ getFieldError('floor') }}
                </div>
              </div>
            </div>

            <div class="form-row">
              <!-- Building -->
              <div class="form-group">
                <label for="building" class="form-label">Building</label>
                <input
                  id="building"
                  type="text"
                  formControlName="building"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('building')"
                  placeholder="e.g., Building 1"
                />
                <div class="error-message" *ngIf="isFieldInvalid('building')">
                  {{ getFieldError('building') }}
                </div>
              </div>

              <!-- Zone -->
              <div class="form-group">
                <label for="zone" class="form-label">Zone</label>
                <input
                  id="zone"
                  type="text"
                  formControlName="zone"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('zone')"
                  placeholder="e.g., Zone A"
                />
                <div class="error-message" *ngIf="isFieldInvalid('zone')">
                  {{ getFieldError('zone') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dimensions -->
        <div class="form-card">
          <div class="card-header">
            <h3>Dimensions (mm)</h3>
            <p>Enter the physical dimensions of the box</p>
          </div>

          <div class="card-body">
            <div class="form-row-3">
              <!-- Length -->
              <div class="form-group">
                <label for="length" class="form-label">Length</label>
                <input
                  id="length"
                  type="number"
                  formControlName="length"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('length')"
                  placeholder="e.g., 6000"
                />
                <div class="error-message" *ngIf="isFieldInvalid('length')">
                  {{ getFieldError('length') }}
                </div>
              </div>

              <!-- Width -->
              <div class="form-group">
                <label for="width" class="form-label">Width</label>
                <input
                  id="width"
                  type="number"
                  formControlName="width"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('width')"
                  placeholder="e.g., 3000"
                />
                <div class="error-message" *ngIf="isFieldInvalid('width')">
                  {{ getFieldError('width') }}
                </div>
              </div>

              <!-- Height -->
              <div class="form-group">
                <label for="height" class="form-label">Height</label>
                <input
                  id="height"
                  type="number"
                  formControlName="height"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('height')"
                  placeholder="e.g., 2800"
                />
                <div class="error-message" *ngIf="isFieldInvalid('height')">
                  {{ getFieldError('height') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule -->
        <div class="form-card">
          <div class="card-header">
            <h3>Schedule</h3>
            <p>Plan when the box work will start and how long it lasts</p>
          </div>

          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label for="boxPlannedStartDate" class="form-label">Box Planned Start Date</label>
                <input
                  id="boxPlannedStartDate"
                  type="date"
                  formControlName="boxPlannedStartDate"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('boxPlannedStartDate')"
                />
                <div class="error-message" *ngIf="isFieldInvalid('boxPlannedStartDate')">
                  {{ getFieldError('boxPlannedStartDate') }}
                </div>
              </div>

              <div class="form-group">
                <label for="boxDuration" class="form-label">Box Duration (days)</label>
                <input
                  id="boxDuration"
                  type="number"
                  formControlName="boxDuration"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('boxDuration')"
                  min="1"
                  placeholder="e.g., 45"
                />
                <div class="error-message" *ngIf="isFieldInvalid('boxDuration')">
                  {{ getFieldError('boxDuration') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- BIM Information -->
        <div class="form-card">
          <div class="card-header">
            <h3>BIM Information</h3>
            <p>Link to BIM model and Revit element (optional)</p>
          </div>

          <div class="card-body">
            <div class="form-row">
              <!-- BIM Model Reference -->
              <div class="form-group">
                <label for="bimModelReference" class="form-label">BIM Model Reference</label>
                <input
                  id="bimModelReference"
                  type="text"
                  formControlName="bimModelReference"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('bimModelReference')"
                  placeholder="e.g., REV-2024-001"
                />
                <div class="error-message" *ngIf="isFieldInvalid('bimModelReference')">
                  {{ getFieldError('bimModelReference') }}
                </div>
              </div>

              <!-- Revit Element ID -->
              <div class="form-group">
                <label for="revitElementId" class="form-label">Revit Element ID</label>
                <input
                  id="revitElementId"
                  type="text"
                  formControlName="revitElementId"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('revitElementId')"
                  placeholder="e.g., 123456"
                />
                <div class="error-message" *ngIf="isFieldInvalid('revitElementId')">
                  {{ getFieldError('revitElementId') }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Add Assets -->
      <div class="step-content" *ngIf="currentStep === 2">
        <div class="form-card">
          <div class="card-header assets-header">
            <div>
              <h3>Assets</h3>
              <p>Add assets that belong to this box (optional)</p>
            </div>
            <button type="button" class="btn btn-link" (click)="openAssetModal()">
              + Add Asset
            </button>
          </div>

          <div class="card-body">
            <div class="empty-assets" *ngIf="assets.length === 0">
              No assets added yet. Click "Add Asset" to include equipment or materials for this box.
            </div>

            <div class="assets-table" *ngIf="assets.length > 0">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Asset Type</th>
                    <th>Asset Code</th>
                    <th>Asset Name</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let asset of assets.controls; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>{{ asset.value.assetType }}</td>
                    <td>{{ asset.value.assetCode || '-' }}</td>
                    <td>{{ asset.value.assetName || '-' }}</td>
                    <td>{{ asset.value.quantity || 1 }}</td>
                    <td>{{ asset.value.unit || '-' }}</td>
                    <td>
                      <button type="button" class="btn-icon btn-edit" (click)="editAsset(i)" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                      </button>
                      <button type="button" class="btn-icon btn-delete" (click)="removeAsset(i)" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="loading">
          Cancel
        </button>
        <div class="step-actions">
          <button type="button" class="btn btn-secondary" *ngIf="currentStep > 1" (click)="previousStep()" [disabled]="loading">
            Previous
          </button>
          <button type="button" class="btn btn-primary" *ngIf="currentStep < totalSteps" (click)="nextStep()" [disabled]="loading">
            Next
          </button>
          <button type="submit" class="btn btn-primary" *ngIf="currentStep === totalSteps" [disabled]="loading">
            <span class="spinner" *ngIf="loading"></span>
            <span *ngIf="!loading">Create Box</span>
            <span *ngIf="loading">Creating...</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Asset Modal -->
<div class="modal-backdrop" *ngIf="isAssetModalOpen" (click)="closeAssetModal()">
  <div class="asset-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingAssetIndex !== null ? 'Edit Asset' : 'Add Asset' }}</h3>
      <button class="icon-button" (click)="closeAssetModal()" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <form [formGroup]="assetForm" (ngSubmit)="saveAsset()" class="modal-body">
      <div class="form-group">
        <label for="assetType" class="form-label required">Asset Type</label>
        <input
          id="assetType"
          type="text"
          formControlName="assetType"
          class="form-control"
          [class.invalid]="assetForm.get('assetType')?.invalid && (assetForm.get('assetType')?.dirty || assetForm.get('assetType')?.touched)"
          placeholder="e.g., MEP, Furniture"
        />
        <div class="error-message" *ngIf="assetForm.get('assetType')?.invalid && (assetForm.get('assetType')?.dirty || assetForm.get('assetType')?.touched)">
          Asset type is required
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="assetCode" class="form-label">Asset Code</label>
          <input
            id="assetCode"
            type="text"
            formControlName="assetCode"
            class="form-control"
            placeholder="e.g., AST-001"
          />
        </div>

        <div class="form-group">
          <label for="assetName" class="form-label">Asset Name</label>
          <input
            id="assetName"
            type="text"
            formControlName="assetName"
            class="form-control"
            placeholder="e.g., HVAC Unit"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="quantity" class="form-label required">Quantity</label>
          <input
            id="quantity"
            type="number"
            formControlName="quantity"
            class="form-control"
            min="1"
            [class.invalid]="assetForm.get('quantity')?.invalid && (assetForm.get('quantity')?.dirty || assetForm.get('quantity')?.touched)"
            placeholder="1"
          />
          <div class="error-message" *ngIf="assetForm.get('quantity')?.invalid && (assetForm.get('quantity')?.dirty || assetForm.get('quantity')?.touched)">
            Quantity must be at least 1
          </div>
        </div>

        <div class="form-group">
          <label for="unit" class="form-label">Unit</label>
          <input
            id="unit"
            type="text"
            formControlName="unit"
            class="form-control"
            placeholder="e.g., pcs"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="specifications" class="form-label">Specifications</label>
        <textarea
          id="specifications"
          formControlName="specifications"
          class="form-control"
          rows="3"
          placeholder="Add specs or technical details"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="notes" class="form-label">Notes</label>
        <textarea
          id="notes"
          formControlName="notes"
          class="form-control"
          rows="3"
          placeholder="Add any additional notes"
        ></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeAssetModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          {{ editingAssetIndex !== null ? 'Update' : 'Add' }} Asset
        </button>
      </div>
    </form>
  </div>
</div>
