<div class="create-box-page">
  <app-header></app-header>
  <app-sidebar></app-sidebar>

  <div class="page-container">
    <div class="page-content">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a [routerLink]="['/projects']" class="breadcrumb-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          Projects
        </a>
        <span class="breadcrumb-separator">/</span>
        <a [routerLink]="['/projects', projectId, 'boxes']" class="breadcrumb-item">Boxes</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-item active">Create Box</span>
      </nav>

      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              <polyline points="7.5 4.21 12 6.81 16.5 4.21"/>
              <polyline points="7.5 19.79 7.5 14.6 3 12"/>
              <polyline points="21 12 16.5 14.6 16.5 19.79"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
          </div>
          <div>
            <h1 class="page-title">Create New Box</h1>
            <p class="page-subtitle">Add a new modular box to your project with details and assets</p>
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="alert alert-success" *ngIf="successMessage">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        {{ successMessage }}
      </div>

      <div class="alert alert-error" *ngIf="error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        {{ error }}
      </div>

      <!-- Stepper -->
      <div class="stepper-container">
        <div class="stepper">
          <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1" (click)="goToStep(1)">
            <div class="step-number">
              <span *ngIf="currentStep > 1">‚úì</span>
              <span *ngIf="currentStep <= 1">1</span>
            </div>
            <div class="step-label">Box Details</div>
          </div>
          <div class="step-connector" [class.completed]="currentStep > 1"></div>
          <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2" (click)="goToStep(2)">
            <div class="step-number">2</div>
            <div class="step-label">Add Assets</div>
          </div>
        </div>
      </div>

      <!-- Form Container -->
      <div class="form-container">
        <form [formGroup]="boxForm" (ngSubmit)="onSubmit()">
          <!-- Step 1: Box Details -->
          <div class="step-content" *ngIf="currentStep === 1">
            <!-- Basic Information -->
            <div class="form-section">
              <div class="section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <line x1="3" y1="9" x2="21" y2="9"/>
                  <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                <div>
                  <h3 class="section-title">Basic Information</h3>
                  <p class="section-description">Enter the core details to identify and categorize this box</p>
                </div>
              </div>

              <div class="form-grid">
                <!-- Box Tag (Read-only, Auto-generated) -->
                <div class="form-group">
                  <label for="boxTag">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                      <line x1="7" y1="7" x2="7.01" y2="7"/>
                    </svg>
                    Box Tag (Auto-generated)
                  </label>
                  <input
                    id="boxTag"
                    type="text"
                    formControlName="boxTag"
                    class="form-control"
                    readonly
                    placeholder="Auto-generated from fields below"
                    style="background-color: #f5f5f5; cursor: not-allowed;"
                  />
                  <small style="color: #666; font-size: 12px;">Format: Project-Building-Floor-Type-SubType-Letter</small>
                </div>

                <!-- Box Name -->
                <div class="form-group">
                  <label for="boxName">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M12 16v-4"/>
                      <path d="M12 8h.01"/>
                    </svg>
                    Box Name
                  </label>
                  <input
                    id="boxName"
                    type="text"
                    formControlName="boxName"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('boxName')"
                    placeholder="e.g., Living Room 01"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('boxName')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('boxName') }}
                  </div>
                </div>

                <!-- Box Type -->
                <div class="form-group">
                  <label for="boxTypeId">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="7" height="7"/>
                      <rect x="14" y="3" width="7" height="7"/>
                      <rect x="14" y="14" width="7" height="7"/>
                      <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Box Type
                    <span class="required">*</span>
                  </label>
                  <select
                    id="boxTypeId"
                    formControlName="boxTypeId"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('boxTypeId')"
                    (change)="onBoxTypeChange($event)"
                  >
                    <option [ngValue]="null">Select Box Type</option>
                    <option *ngFor="let type of boxTypes" [value]="type.boxTypeId">{{ type.boxTypeName }}</option>
                  </select>
                  <div class="loading-text" *ngIf="loadingBoxTypes">Loading box types for {{ projectCategoryName || 'project category' }}...</div>
                  <small *ngIf="!loadingBoxTypes && boxTypes.length > 0 && projectCategoryName" style="color: #10b981; font-size: 12px; display: block; margin-top: 4px;">
                    üìÇ Showing {{ boxTypes.length }} box type(s) for category: <strong>{{ projectCategoryName }}</strong>
                  </small>
                  <div class="error-text" *ngIf="isFieldInvalid('boxTypeId')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('boxTypeId') }}
                  </div>
                </div>

                <!-- Box Sub Type (shown only if selected box type has subtypes) -->
                <div class="form-group" *ngIf="selectedBoxType?.hasSubTypes">
                  <label for="boxSubTypeId">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="7" height="7"/>
                      <rect x="14" y="3" width="7" height="7"/>
                      <rect x="14" y="14" width="7" height="7"/>
                      <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Box Sub Type
                  </label>
                  <select
                    id="boxSubTypeId"
                    formControlName="boxSubTypeId"
                    class="form-control"
                    [disabled]="loadingBoxSubTypes"
                  >
                    <option [ngValue]="null">{{ loadingBoxSubTypes ? 'Loading sub types...' : 'Select Sub Type' }}</option>
                    <option *ngFor="let subType of boxSubTypes" [ngValue]="subType.boxSubTypeId">{{ subType.boxSubTypeName }}</option>
                  </select>
                  <div class="loading-text" *ngIf="loadingBoxSubTypes">Loading box sub types...</div>
                  <small *ngIf="!loadingBoxSubTypes && boxSubTypes.length > 0" style="color: #10b981; font-size: 12px; display: block; margin-top: 4px;">
                    üì¶ {{ boxSubTypes.length }} sub type(s) available
                  </small>
                  <small *ngIf="!loadingBoxSubTypes && boxSubTypes.length === 0" style="color: #f59e0b; font-size: 12px; display: block; margin-top: 4px;">
                    ‚ö†Ô∏è No sub types configured for this box type
                  </small>
                </div>

                <!-- Building Number -->
                <div class="form-group">
                  <label for="buildingNumber">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                      <path d="M9 22v-4h6v4"/>
                      <path d="M8 6h.01"/>
                      <path d="M16 6h.01"/>
                      <path d="M12 6h.01"/>
                    </svg>
                    Building Number
                    <span class="required">*</span>
                  </label>
                  <select
                    id="buildingNumber"
                    formControlName="buildingNumber"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('buildingNumber')"
                    (change)="onBuildingOrFloorChange()"
                  >
                    <option value="">Select Building Number</option>
                    <option *ngFor="let bNum of buildingNumbers" [value]="bNum">{{ bNum }}</option>
                  </select>
                  <div class="error-text" *ngIf="isFieldInvalid('buildingNumber')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('buildingNumber') }}
                  </div>
                </div>

                <!-- Floor -->
                <div class="form-group">
                  <label for="floor">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    </svg>
                    Floor / Level
                    <span class="required">*</span>
                  </label>
                  <select
                    id="floor"
                    formControlName="floor"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('floor')"
                    (change)="onBuildingOrFloorChange()"
                  >
                    <option *ngFor="let floor of floors" [value]="floor">{{ floor }}</option>
                  </select>
                  <div class="error-text" *ngIf="isFieldInvalid('floor')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('floor') }}
                  </div>
                </div>

                <!-- Box Letter -->
                <div class="form-group">
                  <label for="boxLetter">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
                    </svg>
                    Box Letter
                    <span class="required">*</span>
                  </label>
                  <select
                    id="boxLetter"
                    formControlName="boxLetter"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('boxLetter')"
                    [disabled]="loadingBoxLetters || availableBoxLetters.length === 0"
                  >
                    <option value="">Select Box Letter</option>
                    <option *ngFor="let letter of availableBoxLetters" [value]="letter">{{ letter }}</option>
                  </select>
                  <div class="loading-text" *ngIf="loadingBoxLetters">Loading available letters...</div>
                  <div class="info-text" *ngIf="!loadingBoxLetters && availableBoxLetters.length === 0" style="color: #f59e0b; font-size: 12px; margin-top: 4px;">
                    No available letters for this combination
                  </div>
                  <div class="error-text" *ngIf="isFieldInvalid('boxLetter')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('boxLetter') }}
                  </div>
                </div>

                <!-- Zone -->
                <div class="form-group">
                  <label for="zone">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="10" r="3"/>
                      <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
                    </svg>
                    Zone
                  </label>
                  <select
                    id="zone"
                    formControlName="zone"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('zone')"
                    [disabled]="loadingZones"
                  >
                    <option value="">Select Zone</option>
                    <option *ngFor="let zone of zones" [value]="zone.value">
                      {{ zone.displayName }}
                    </option>
                  </select>
                  <div class="helper-text" *ngIf="loadingZones">
                    Loading zones...
                  </div>
                  <div class="error-text" *ngIf="isFieldInvalid('zone')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('zone') }}
                  </div>
                </div>

                <!-- Factory -->
                <div class="form-group">
                  <label for="factoryId">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M2 20h.01"/><path d="M7 20h.01"/><path d="M12 20h.01"/><path d="M17 20h.01"/><path d="M22 20h.01"/><path d="M2 15h.01"/><path d="M7 15h.01"/><path d="M12 15h.01"/><path d="M17 15h.01"/><path d="M22 15h.01"/><path d="M2 10h.01"/><path d="M7 10h.01"/><path d="M12 10h.01"/><path d="M17 10h.01"/><path d="M22 10h.01"/><path d="M2 5h.01"/><path d="M7 5h.01"/><path d="M12 5h.01"/><path d="M17 5h.01"/><path d="M22 5h.01"/>
                    </svg>
                    Factory
                  </label>
                  <select
                    id="factoryId"
                    formControlName="factoryId"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('factoryId')"
                    [disabled]="loadingFactories"
                  >
                    <option [ngValue]="null">Select Factory</option>
                    <option *ngFor="let factory of factories" [ngValue]="factory.factoryId">
                      {{ factory.factoryCode }} - {{ factory.factoryName }}
                      <span *ngIf="factory.isFull"> (Full)</span>
                      <span *ngIf="!factory.isFull && factory.capacity"> ({{ factory.availableCapacity }} available)</span>
                    </option>
                  </select>
                  <div class="helper-text" *ngIf="loadingFactories">
                    Loading factories for {{ projectLocation }}...
                  </div>
                  <small *ngIf="!loadingFactories && factories.length === 0 && projectLocation" style="color: #f59e0b; font-size: 12px; display: block; margin-top: 4px;">
                    ‚ö†Ô∏è No factories available for location: {{ projectLocation }}
                  </small>
                  <small *ngIf="!loadingFactories && factories.length > 0 && projectLocation" style="color: #10b981; font-size: 12px; display: block; margin-top: 4px;">
                    üìç Showing {{ factories.length }} factory(ies) for location: <strong>{{ projectLocation }}</strong>
                  </small>
                  <div class="error-text" *ngIf="isFieldInvalid('factoryId')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('factoryId') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Dimensions -->
            <div class="form-section">
              <div class="section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                <div>
                  <h3 class="section-title">Dimensions</h3>
                  <p class="section-description">Specify the physical dimensions in millimeters</p>
                </div>
              </div>

              <div class="form-grid-3">
                <!-- Length -->
                <div class="form-group">
                  <label for="length">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="5" y1="12" x2="19" y2="12"/>
                      <polyline points="12 5 19 12 12 19"/>
                    </svg>
                    Length (mm)
                  </label>
                  <input
                    id="length"
                    type="number"
                    formControlName="length"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('length')"
                    placeholder="e.g., 6000"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('length')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('length') }}
                  </div>
                </div>

                <!-- Width -->
                <div class="form-group">
                  <label for="width">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <polyline points="5 12 12 19 19 12"/>
                    </svg>
                    Width (mm)
                  </label>
                  <input
                    id="width"
                    type="number"
                    formControlName="width"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('width')"
                    placeholder="e.g., 3000"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('width')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('width') }}
                  </div>
                </div>

                <!-- Height -->
                <div class="form-group">
                  <label for="height">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="18 15 12 9 6 15"/>
                    </svg>
                    Height (mm)
                  </label>
                  <input
                    id="height"
                    type="number"
                    formControlName="height"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('height')"
                    placeholder="e.g., 2800"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('height')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('height') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Schedule -->
            <div class="form-section">
              <div class="section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <div>
                  <h3 class="section-title">Schedule</h3>
                  <p class="section-description">Plan the construction timeline for this box</p>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="boxPlannedStartDate">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Box Planned Start Date
                  </label>
                  <input
                    id="boxPlannedStartDate"
                    type="date"
                    formControlName="boxPlannedStartDate"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('boxPlannedStartDate')"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('boxPlannedStartDate')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('boxPlannedStartDate') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="boxDuration">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Box Duration (days)
                  </label>
                  <input
                    id="boxDuration"
                    type="number"
                    formControlName="boxDuration"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('boxDuration')"
                    min="1"
                    placeholder="e.g., 45"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('boxDuration')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('boxDuration') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- BIM Information -->
            <div class="form-section">
              <div class="section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="16 18 22 12 16 6"/>
                  <polyline points="8 6 2 12 8 18"/>
                </svg>
                <div>
                  <h3 class="section-title">BIM Information</h3>
                  <p class="section-description">Link to BIM model and Revit elements (optional)</p>
                </div>
              </div>

              <div class="form-grid">
                <!-- BIM Model Reference -->
                <div class="form-group">
                  <label for="bimModelReference">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    BIM Model Reference
                  </label>
                  <input
                    id="bimModelReference"
                    type="text"
                    formControlName="bimModelReference"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('bimModelReference')"
                    placeholder="e.g., REV-2024-001"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('bimModelReference')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('bimModelReference') }}
                  </div>
                </div>

                <!-- Revit Element ID -->
                <div class="form-group">
                  <label for="revitElementId">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="4 17 10 11 4 5"/>
                      <line x1="12" y1="19" x2="20" y2="19"/>
                    </svg>
                    Revit Element ID
                  </label>
                  <input
                    id="revitElementId"
                    type="text"
                    formControlName="revitElementId"
                    class="form-control"
                    [class.invalid]="isFieldInvalid('revitElementId')"
                    placeholder="e.g., 123456"
                  />
                  <div class="error-text" *ngIf="isFieldInvalid('revitElementId')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="8" x2="12" y2="12"/>
                      <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    {{ getFieldError('revitElementId') }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Add Assets -->
          <div class="step-content" *ngIf="currentStep === 2">
            <div class="form-section">
              <div class="section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                <div>
                  <h3 class="section-title">Assets</h3>
                  <p class="section-description">Add equipment, materials, or MEP components for this box</p>
                </div>
              </div>

              <button type="button" class="btn btn-primary" (click)="openAssetModal()" style="margin-bottom: 20px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Asset
              </button>

              <div class="empty-assets" *ngIf="assets.length === 0">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 12px; opacity: 0.4;">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                No assets added yet. Click "Add Asset" to include equipment or materials for this box.
              </div>

              <div class="assets-table" *ngIf="assets.length > 0">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Asset Type</th>
                      <th>Asset Code</th>
                      <th>Asset Name</th>
                      <th>Quantity</th>
                      <th>Unit</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let asset of assets.controls; let i = index">
                      <td>{{ i + 1 }}</td>
                      <td>{{ asset.value.assetType }}</td>
                      <td>{{ asset.value.assetCode || '-' }}</td>
                      <td>{{ asset.value.assetName || '-' }}</td>
                      <td>{{ asset.value.quantity || 1 }}</td>
                      <td>{{ asset.value.unit || '-' }}</td>
                      <td>
                        <button type="button" class="btn-icon btn-edit" (click)="editAsset(i)" title="Edit">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                          </svg>
                        </button>
                        <button type="button" class="btn-icon btn-delete" (click)="removeAsset(i)" title="Delete">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          </svg>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="loading">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Cancel
            </button>
            <div class="step-actions">
              <button type="button" class="btn btn-secondary" *ngIf="currentStep > 1" (click)="previousStep()" [disabled]="loading">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"/>
                </svg>
                Previous
              </button>
              <button type="button" class="btn btn-primary" *ngIf="currentStep < totalSteps" (click)="nextStep()" [disabled]="loading">
                Next
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </button>
              <button type="submit" class="btn btn-primary" *ngIf="currentStep === totalSteps" [disabled]="loading">
                <span class="spinner" *ngIf="loading"></span>
                <span *ngIf="!loading">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                  Create Box
                </span>
                <span *ngIf="loading">Creating...</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Asset Modal -->
<div class="modal-backdrop" *ngIf="isAssetModalOpen" (click)="closeAssetModal()">
  <div class="asset-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingAssetIndex !== null ? 'Edit Asset' : 'Add Asset' }}</h3>
      <button class="icon-button" (click)="closeAssetModal()" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <form [formGroup]="assetForm" (ngSubmit)="saveAsset()" class="modal-body">
      <div class="form-group">
        <label for="assetType">Asset Type <span class="required">*</span></label>
        <input
          id="assetType"
          type="text"
          formControlName="assetType"
          class="form-control"
          [class.invalid]="assetForm.get('assetType')?.invalid && (assetForm.get('assetType')?.dirty || assetForm.get('assetType')?.touched)"
          placeholder="e.g., MEP, Furniture"
        />
        <div class="error-message" *ngIf="assetForm.get('assetType')?.invalid && (assetForm.get('assetType')?.dirty || assetForm.get('assetType')?.touched)">
          Asset type is required
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="assetCode">Asset Code</label>
          <input
            id="assetCode"
            type="text"
            formControlName="assetCode"
            class="form-control"
            placeholder="e.g., AST-001"
          />
        </div>

        <div class="form-group">
          <label for="assetName">Asset Name</label>
          <input
            id="assetName"
            type="text"
            formControlName="assetName"
            class="form-control"
            placeholder="e.g., HVAC Unit"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="quantity">Quantity <span class="required">*</span></label>
          <input
            id="quantity"
            type="number"
            formControlName="quantity"
            class="form-control"
            min="1"
            [class.invalid]="assetForm.get('quantity')?.invalid && (assetForm.get('quantity')?.dirty || assetForm.get('quantity')?.touched)"
            placeholder="1"
          />
          <div class="error-message" *ngIf="assetForm.get('quantity')?.invalid && (assetForm.get('quantity')?.dirty || assetForm.get('quantity')?.touched)">
            Quantity must be at least 1
          </div>
        </div>

        <div class="form-group">
          <label for="unit">Unit</label>
          <input
            id="unit"
            type="text"
            formControlName="unit"
            class="form-control"
            placeholder="e.g., pcs"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="specifications">Specifications</label>
        <textarea
          id="specifications"
          formControlName="specifications"
          class="form-control"
          rows="3"
          placeholder="Add specs or technical details"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="notes">Notes</label>
        <textarea
          id="notes"
          formControlName="notes"
          class="form-control"
          rows="3"
          placeholder="Add any additional notes"
        ></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeAssetModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          {{ editingAssetIndex !== null ? 'Update' : 'Add' }} Asset
        </button>
      </div>
    </form>
  </div>
</div>
