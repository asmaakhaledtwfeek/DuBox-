<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn-back" (click)="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          {{ fromContext === 'quality-control' ? 'Back to Quality Control' : 'Back to Box Details' }}
        </button>
        <h1 class="page-title" *ngIf="!qualityIssuesOnlyView">QA/QC Activity Approval Checklist</h1>
        <h1 class="page-title" *ngIf="qualityIssuesOnlyView">All Quality Issues</h1>
        <p class="page-subtitle" *ngIf="!qualityIssuesOnlyView && wirRecord">{{ wirRecord.wirCode }} - {{ wirRecord.activityName }}</p>
        <p class="page-subtitle" *ngIf="qualityIssuesOnlyView">
          Box-wide quality issues across every WIR checkpoint.
        </p>
      </div>
    </div>

    <div class="quality-list-only" *ngIf="qualityIssuesOnlyView">
      <div class="form-card aggregate-card">
        <div class="designer-headline">
          <div>
            <h3>All Quality Issues</h3>
            <p>List of every quality issue logged for this box.</p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ boxQualityIssues.length }}</strong> issue(s)</span>
            <button 
              type="button" 
              class="btn btn-primary btn-sm" 
              (click)="exportQualityIssuesToExcel()"
              [disabled]="boxIssuesLoading || boxQualityIssues.length === 0"
              title="Export quality issues to Excel"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Export to Excel
            </button>
          </div>
        </div>

        <div class="aggregated-table-wrapper">
          <div class="quality-issues-loading" *ngIf="boxIssuesLoading">
            <div class="spinner small"></div>
            <p>Loading quality issues...</p>
          </div>
          <div class="quality-issues-error" *ngIf="!boxIssuesLoading && boxIssuesError">
            <p>{{ boxIssuesError }}</p>
          </div>
          <ng-container *ngIf="!boxIssuesLoading && !boxIssuesError">
            <table class="designer-table" *ngIf="boxQualityIssues.length > 0; else noBoxIssuesForBox">
              <thead>
                <tr>
                  <th class="col-seq">Seq</th>
                  <th class="col-extra">Issue Type</th>
                  <th class="col-extra">Severity</th>
                  <th class="col-extra">Assigned To</th>
                  <th class="col-extra">Due Date</th>
                  <th class="col-extra">Reported By</th>
                  <th class="col-extra">Issue Date</th>
                  <th class="col-extra">Status</th>
                  <th class="col-extra">WIR</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let issue of boxQualityIssues; let i = index">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ issue.issueType || '‚Äî' }}</td>
                  <td>{{ issue.severity || '‚Äî' }}</td>
                  <td>{{ issue.assignedTo || '‚Äî' }}</td>
                  <td>{{ formatDate(issue.dueDate) }}</td>
                  <td>{{ issue.reportedBy || '‚Äî' }}</td>
                  <td>{{ formatDate(issue.issueDate) }}</td>
                  <td>{{ issue.status || 'Open' }}</td>
                  <td>{{ issue.wirNumber || issue.wirName || '‚Äî' }}</td>
                </tr>
              </tbody>
            </table>
            <ng-template #noBoxIssuesForBox>
              <div class="empty-checklist">
                <p>No quality issues logged for this box.</p>
                <small>Issues will appear here once created.</small>
              </div>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>

    <div *ngIf="!qualityIssuesOnlyView">
    <div class="stepper" *ngIf="!loading">
      <button
        type="button"
        class="step"
        *ngFor="let step of stepMeta"
        [class.completed]="isStepCompleted(step.id)"
        [class.active]="isStepActive(step.id)"
        [class.disabled]="!canNavigateToStep(step.id)"
        [disabled]="!canNavigateToStep(step.id)"
        (click)="handleStepClick(step.id)"
        [title]="!canNavigateToStep(step.id) ? 'Please complete previous steps first' : ''"
      >
        <div class="step-index">{{ getStepNumber(step.id) }}</div>
        <div class="step-meta">
          <div class="step-title">{{ step.title }}</div>
          <div class="step-subtitle">{{ step.subtitle }}</div>
        </div>
      </button>
    </div>

    <div class="pending-action-banner" *ngIf="pendingActionLabel && showOverviewState">
      <div class="banner-text">
        <strong>Next step:</strong> {{ pendingActionLabel }}
      </div>
      <button class="btn btn-primary btn-sm" (click)="triggerPendingAction()">
        Continue
      </button>
    </div>

    <div class="checkpoint-overview" *ngIf="showOverviewState">
      <div class="info-card summary-card">
        <div class="summary-header">
          <div>
            <h2 class="card-title">Inspection Request</h2>
            <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
          </div>
          <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
            {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
          </span>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested Date</span>
            <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Inspector</span>
            <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <div class="checklist-card">
        <div class="overview-actions">
          <h3>Checklist Items</h3>
          <div class="action-buttons">
            <button 
              class="btn btn-secondary btn-sm" 
              (click)="startAddChecklistFlow()"
              [disabled]="isChecklistLocked"
              [title]="isChecklistLocked ? 'Checklist is locked after review' : null"
            >
              Add Checklist Item
            </button>
            <button class="btn btn-primary btn-sm" (click)="startReviewFlow()" [disabled]="!canStartReview">
              Review Checkpoint
            </button>
          </div>
        </div>

        <ng-container *ngIf="hasChecklistItems; else emptyChecklist">
          <div class="checklist-table-wrapper compact">
            <table class="checklist-table">
              <thead>
                <tr>
                  <th style="width: 50px;">#</th>
                  <th>Checkpoint Description</th>
                  <th style="width: 180px;">Last Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of displayChecklistItems; let i = index">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ item.checkpointDescription }}</td>
                  <td>
                    <span class="badge"
                      [class.badge-warning]="item.status === 'Pending'"
                      [class.badge-success]="item.status === 'Pass'"
                      [class.badge-danger]="item.status === 'Fail'">
                      {{ item.status || 'Pending' }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
        <ng-template #emptyChecklist>
          <div class="empty-checklist">
            <p>No checklist items yet.</p>
            <small>Add checklist items to move this checkpoint into review.</small>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading checklist...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadWIRRecord()">Retry</button>
    </div>

    <!-- Step 1: Create WIR Checkpoint -->
    <div *ngIf="currentStep === 'create-checkpoint' && wirRecord && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 1: Create WIR Checkpoint</h2>
        <p class="step-description" *ngIf="!wirCheckpoint">Create a new WIR checkpoint for this activity</p>
        <p class="step-description" *ngIf="wirCheckpoint">Update WIR checkpoint information for this activity</p>
      </div>

      <form [formGroup]="createCheckpointForm" (ngSubmit)="onCreateCheckpoint()">
        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>

          <!-- Auto-filled information (read-only) -->
          <div class="info-section" *ngIf="wirRecord">
            <h3 class="info-section-title">Checkpoint Information</h3>
            <div class="info-grid-readonly">
              <div class="info-item">
                <span class="label">Box Tag</span>
                <span class="value">{{ wirRecord.boxTag }}</span>
              </div>
              <div class="info-item">
                <span class="label">WIR Number</span>
                <span class="value">{{ wirRecord.wirCode }}</span>
              </div>
              <div class="info-item">
                <span class="label">Activity Name</span>
                <span class="value">{{ wirRecord.activityName }}</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="wirName">WIR Name</label>
            <input 
              id="wirName" 
              type="text" 
              formControlName="wirName" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched"
              placeholder="e.g., Release from Assembly - WIR-1"
            >
            <div *ngIf="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched" class="error-text">
              WIR Name max 200 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="wirDescription">WIR Description</label>
            <textarea 
              id="wirDescription" 
              formControlName="wirDescription" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched"
              rows="3"
              placeholder="Description of the WIR checkpoint"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched" class="error-text">
              WIR Description max 500 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="attachmentPath">Attachment Path</label>
            <input 
              id="attachmentPath" 
              type="text" 
              formControlName="attachmentPath" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('attachmentPath')?.invalid && createCheckpointForm.get('attachmentPath')?.touched"
              placeholder="e.g., /attachments/wir-1-drawing.pdf"
            >
            <div *ngIf="createCheckpointForm.get('attachmentPath')?.invalid && createCheckpointForm.get('attachmentPath')?.touched" class="error-text">
              Attachment Path max 500 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="comments">Comments</label>
            <textarea 
              id="comments" 
              formControlName="comments" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched"
              rows="3"
              placeholder="Additional comments"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched" class="error-text">
              Comments max 1000 characters.
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="creatingCheckpoint || createCheckpointForm.invalid">
              <span *ngIf="creatingCheckpoint">Creating...</span>
              <span *ngIf="!creatingCheckpoint">Create Checkpoint</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 2: Add Checklist Items -->
    <div *ngIf="currentStep === 'add-items' && wirCheckpoint && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 2: Add Checklist Items</h2>
        <p class="step-description">Add checklist items to the WIR checkpoint</p>
      </div>

      <div class="info-card summary-card">
        <div class="summary-header">
          <div>
            <h2 class="card-title">Inspection Request</h2>
            <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
          </div>
          <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
            {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
          </span>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested Date</span>
            <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Inspector</span>
            <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <form [formGroup]="addChecklistItemsForm" (ngSubmit)="onAddChecklistItems()" class="checklist-designer">
        <div class="designer-headline">
          <div>
            <h3>Checklist Designer</h3>
            <p>Create or edit inspection checkpoints for this WIR.</p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ wirCheckpoint?.checklistItems?.length || 0 }}</strong> item(s)</span>
            <button 
              type="button" 
              class="btn btn-secondary btn-sm" 
              (click)="openAddPredefinedItemsModal()"
              [disabled]="isChecklistLocked || loadingPredefinedItems"
              [title]="isChecklistLocked ? 'Checklist is locked after review' : null"
            >
              + Add Predefined Items
            </button>
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              (click)="handleStepClick('review')"
              [disabled]="!canNavigateToStep('review')"
            >
              Review
            </button>
          </div>
        </div>

        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>
          <div class="checklist-table-wrapper" formArrayName="checklistItems">
            <table class="designer-table" *ngIf="addChecklistItemsArray.length > 0; else noChecklistPlaceholder">
              <thead>
                <tr>
                  <th class="col-seq">Seq</th>
                  <th>Description</th>
                  <th class="col-actions text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of addChecklistItemsArray.controls; let i = index" [formGroupName]="i">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ item.get('checkpointDescription')?.value }}</td>
                  <td class="text-right actions-cell">
                    <button 
                      type="button" 
                      class="icon-button" 
                      (click)="confirmRemoveChecklistItem(i)"
                      title="Delete item"
                    >
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noChecklistPlaceholder>
              <div class="empty-checklist">
                <p>No checklist items added yet.</p>
                <small>Click "Add Predefined Items" to select from the predefined checklist.</small>
              </div>
            </ng-template>
          </div>

          <div class="form-actions sticky-actions">
            <button type="button" class="btn btn-secondary" (click)="closeWorkflowStep()">Close</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 3: Review Checklist -->
    <form [formGroup]="checklistForm" *ngIf="currentStep === 'review' && wirCheckpoint && !loading && !error" class="review-form">
      <div class="review-layout">
        <div class="review-main">
      <!-- WIR Information Card -->
          <div class="info-card summary-card">
            <div class="summary-header">
              <div>
                <h2 class="card-title">Inspection Request</h2>
                <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
          </div>
              <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
                {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
              </span>
          </div>
            <div class="summary-grid">
              <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
              <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
              <div class="summary-item">
            <span class="label">Requested Date</span>
                <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Inspector</span>
                <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <!-- Inspector Notes and Photos -->
      <div class="notes-photos-grid">
        <!-- Inspection Notes -->
        <div class="notes-card">
          <h2 class="card-title">Inspector Notes</h2>
          <div class="form-group inline-input">
            <label for="inspectorRoleInput">Inspector Role</label>
            <input
              id="inspectorRoleInput"
              type="text"
              formControlName="inspectorRole"
              class="form-control"
              maxlength="100"
              placeholder="e.g., QC Engineer - MEP"
            >
            <small class="form-text text-muted">Optional, max 100 characters.</small>
          </div>
          <textarea 
            formControlName="inspectionNotes"
            class="form-control"
            rows="4"
            placeholder="Add general inspection notes, observations, or recommendations..."
          ></textarea>
          <small class="form-text">{{ checklistForm.value.inspectionNotes?.length || 0 }}/1000 characters</small>
        </div>

        <!-- Photo Upload -->
        <div class="photos-card">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            Inspection Photos
          </h2>
          
          <div class="photo-upload-zone">
            <input 
              type="file" 
              id="photoInput"
              accept="image/*"
              multiple
              (change)="onPhotosSelected($event)"
              style="display: none;"
            />
            <label for="photoInput" class="upload-label">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p>Click to upload inspection photos</p>
              <small>JPG, PNG (Max 5MB each)</small>
            </label>
          </div>

          <div class="photo-preview-grid" *ngIf="photoPreviewUrls.length > 0">
            <div class="photo-preview" *ngFor="let url of photoPreviewUrls; let i = index">
              <img [src]="url" alt="Inspection photo">
              <button type="button" class="remove-photo" (click)="removePhoto(i)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Checklist Items -->
      <div class="checklist-card">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
              Checklist Validation
        </h2>
        
        <div class="checklist-table-wrapper">
          <table class="checklist-table">
            <thead>
              <tr>
                <th style="width: 60px;">#</th>
                <th>Checkpoint Description</th>
                <th style="width: 150px;">Status</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody formArrayName="checklistItems">
              <tr *ngFor="let item of checklistItems.controls; let i = index" [formGroupName]="i">
                <td class="text-center">{{ i + 1 }}</td>
                <td class="checkpoint-desc">
                  <div class="checkpoint-description-text">
                    {{ item.get('checkpointDescription')?.value || '‚Äî' }}
                  </div>
                </td>
                <td class="status-display">
                  <span class="status-badge" [ngClass]="getStatusBadgeClass(item.value.status)">
                    {{ getStatusLabel(item.value.status) }}
                  </span>
                </td>
                <td class="text-right actions-cell">
                  <button 
                    type="button" 
                    class="btn btn-primary btn-sm btn-review" 
                    (click)="openItemReviewModal(i)"
                    [disabled]="isChecklistLocked"
                    title="Review item"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Review
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="checklistItems.length === 0" class="empty-checklist">
            <p>No checklist items available.</p>
            <small>Please add checklist items first.</small>
          </div>
        </div>
      </div>
      </div>

        <aside class="review-side">
          <div class="status-overview-card">
            <h3>Status Overview</h3>
            <ul class="status-timeline">
              <li>
                <span class="label">Requested</span>
                <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
              </li>
              <li>
                <span class="label">Inspection</span>
                <span class="value">{{ formatDateTime(wirCheckpoint!.inspectionDate) }}</span>
              </li>
              <li>
                <span class="label">Approval</span>
                <span class="value">{{ formatDateTime(wirCheckpoint!.approvalDate) }}</span>
              </li>
            </ul>
      </div>

          <!-- Rejection Reason -->
      <!-- Action Buttons -->
          <div class="decision-card side-card">
            <h3>Final Decision</h3>
            <div class="final-status-selector">
              <button 
                type="button" 
                class="status-chip-btn" 
                *ngFor="let option of finalStatusOptions"
                [class.active]="finalStatusControl.value === option.value"
                (click)="onFinalStatusSelect(option.value)"
              >
                {{ option.label }}
              </button>
            </div>
            <p>Select a status and submit after completing the checklist.</p>
            <div class="action-buttons vertical">
        <button 
          type="button" 
          class="btn btn-secondary"
                (click)="closeWorkflowStep()"
          [disabled]="submitting"
        >
                Close
        </button>
        
        <button 
          type="button" 
                class="btn btn-success"
                (click)="onSubmitReview()"
                [disabled]="!canSubmitReview() || submitting"
              >
                {{ submitting ? 'Submitting...' : 'Submit Decision' }}
              </button>
            </div>
          </div>
        </aside>
      </div>
    </form>

    <!-- Step 4: Quality Issues (Optional) -->
    <div *ngIf="currentStep === 'quality-issues' && wirCheckpoint && !loading && !error" class="step-container quality-issues-step">
      <div class="step-header">
        <h2>Step 4: Quality Issues (Optional)</h2>
        <p class="step-description">Log defects, non-conformances, or observations that need follow-up outside of the review workflow.</p>
      </div>

      <div class="quality-issues-summary">
        <div class="info-card summary-card">
          <div class="summary-header">
            <div>
              <h2 class="card-title">Inspection Request</h2>
              <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
            </div>
            <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
              {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
            </span>
          </div>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="label">Box Tag</span>
              <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Requested By</span>
              <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Requested Date</span>
              <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Inspector</span>
              <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="quality-issues-table-card" *ngIf="initialStepApplied && currentStep === 'quality-issues'">
        <div class="form-card aggregate-card">
          <div class="designer-headline">
            <div>
              <h3>All Quality Issues</h3>
              <p>List of every quality issue logged for this box.</p>
            </div>
            <div class="designer-meta">
              <span><strong>{{ boxQualityIssues.length }}</strong> total</span>
              <button 
                type="button" 
                class="btn btn-primary btn-sm" 
                (click)="exportQualityIssuesToExcel()"
                [disabled]="boxIssuesLoading || boxQualityIssues.length === 0"
                title="Export quality issues to Excel"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Export to Excel
              </button>
            </div>
          </div>

          <div class="aggregated-table-wrapper">
            <div *ngIf="boxIssuesLoading" class="quality-issues-loading">
              <div class="spinner small"></div>
              <p>Loading quality issues...</p>
            </div>
            <div *ngIf="!boxIssuesLoading && boxIssuesError" class="quality-issues-error">
              <p>{{ boxIssuesError }}</p>
            </div>
            <ng-container *ngIf="!boxIssuesLoading && !boxIssuesError">
              <table class="designer-table" *ngIf="boxQualityIssues.length > 0; else noBoxIssuesForBox">
                <thead>
                  <tr>
                    <th class="col-seq">Seq</th>
                    <th class="col-extra">Issue Type</th>
                    <th class="col-extra">Severity</th>
                    <th>Description</th>
                    <th class="col-extra">Assigned To</th>
                    <th class="col-extra">Due Date</th>
                    <th class="col-extra">Reported By</th>
                    <th class="col-extra">Issue Date</th>
                    <th class="col-extra">Status</th>
                    <th class="col-extra">WIR</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let issue of boxQualityIssues; let i = index">
                    <td class="text-center">{{ i + 1 }}</td>
                    <td>{{ issue.issueType || '‚Äî' }}</td>
                    <td>{{ issue.severity || '‚Äî' }}</td>
                    <td>{{ issue.issueDescription || '‚Äî' }}</td>
                    <td>{{ issue.assignedTo || '‚Äî' }}</td>
                    <td>{{ formatDate(issue.dueDate) }}</td>
                    <td>{{ issue.reportedBy || '‚Äî' }}</td>
                    <td>{{ formatDate(issue.issueDate) }}</td>
                    <td>{{ issue.status || 'Open' }}</td>
                    <td>{{ issue.wirNumber || issue.wirName || '‚Äî' }}</td>
                  </tr>
                </tbody>
              </table>
              <ng-template #noBoxIssuesForBox>
                <div class="empty-checklist">
                  <p>No quality issues logged for this box.</p>
                  <small>Issues will appear here once created.</small>
                </div>
              </ng-template>
            </ng-container>
          </div>
        </div>
      </div>

      <div class="quality-issues-table-card" [formGroup]="qualityIssuesForm">
        <div class="designer-headline">
          <div>
            <h3>Quality Issues</h3>
            <p>Manage outstanding inspection issues for this checkpoint.</p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ qualityIssuesArray.length }}</strong> issue(s)</span>
            <button type="button" class="btn btn-secondary btn-sm" (click)="openQualityIssueModal()">
              + Add Quality Issue
            </button>
          </div>
        </div>

        <div class="form-card">
          <div class="checklist-table-wrapper" formArrayName="issues">
            <table class="designer-table" *ngIf="qualityIssuesArray.length > 0; else noQualityIssues">
              <thead>
                <tr>
                  <th class="col-seq">Seq</th>
                  <th class="col-extra">Issue Type</th>
                  <th class="col-extra">Severity</th>
                  <th class="col-extra">Assigned To</th>
                  <th class="col-extra">Due Date</th>
                  <th class="col-extra">Attachment</th>
                  <th class="col-extra">Reported By</th>
                  <th class="col-extra">Issue Date</th>
                  <th class="col-actions text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let issue of qualityIssuesArray.controls; let i = index" [formGroupName]="i">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ issue.get('issueType')?.value }}</td>
                  <td>{{ issue.get('severity')?.value }}</td>
                  <td>{{ issue.get('assignedTo')?.value || '‚Äî' }}</td>
                  <td>{{ issue.get('dueDate')?.value || '‚Äî' }}</td>
                  <td>{{ issue.get('photoPath')?.value || '‚Äî' }}</td>
                  <td>{{ getExistingQualityIssue(i)?.reportedBy || 'Current User' }}</td>
                  <td>
                    {{ getExistingQualityIssue(i)?.issueDate ? formatDate(getExistingQualityIssue(i)?.issueDate) : (issue.get('dueDate')?.value || '‚Äî') }}
                  </td>
                  <td class="text-right actions-cell">
                    <button 
                      type="button" 
                      class="icon-button" 
                      (click)="removeQualityIssue(i)"
                      title="Delete issue"
                    >
                      üóëÔ∏è
        </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noQualityIssues>
              <div class="empty-checklist">
                <p>No quality issues added yet.</p>
                <small>Click ‚ÄúAdd Quality Issue‚Äù to create one.</small>
              </div>
            </ng-template>
          </div>

          <div class="form-actions sticky-actions">
            <button type="button" class="btn btn-secondary" (click)="closeWorkflowStep()">Close</button>
        <button 
          type="button" 
              class="btn btn-primary" 
              (click)="submitQualityIssues()" 
              [disabled]="qualityIssuesArray.length === 0 || qualityIssuesForm.invalid || savingQualityIssues"
            >
              <span *ngIf="savingQualityIssues">Saving...</span>
              <span *ngIf="!savingQualityIssues">Save Issues</span>
        </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Checklist Item Modal -->
<div class="modal-backdrop" *ngIf="isChecklistModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Add Checklist Item</h3>
      <button type="button" class="btn btn-secondary btn-sm" (click)="closeChecklistModal()">Close</button>
    </div>
    <form [formGroup]="newChecklistForm" (ngSubmit)="addChecklistItemFromModal()">
      <div class="form-group">
        <label>Description <span class="required">*</span></label>
        <textarea formControlName="checkpointDescription" class="form-control" rows="3" placeholder="Enter checkpoint description"></textarea>
      </div>
      <div class="form-group">
        <label>Reference Document</label>
        <input type="text" formControlName="referenceDocument" class="form-control" placeholder="e.g., Drawing No., Specification">
      </div>
      <small class="form-text">Sequence will auto-increment based on item order.</small>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">Add Item</button>
      </div>
    </form>
  </div>
</div>

<!-- Quality Issue Modal -->
<div class="modal-backdrop" *ngIf="isQualityIssueModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Add Quality Issue</h3>
      <button type="button" class="btn btn-secondary btn-sm" (click)="closeQualityIssueModal()">Close</button>
    </div>
    <form [formGroup]="newQualityIssueForm" (ngSubmit)="addQualityIssueFromModal()">
      <div class="form-group">
        <label>Description <span class="required">*</span></label>
        <textarea formControlName="issueDescription" class="form-control" rows="3" placeholder="Describe the quality issue"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Severity</label>
          <select formControlName="severity" class="form-control">
            <option *ngFor="let severity of severityLevels" [value]="severity">{{ severity }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Issue Type</label>
          <select formControlName="issueType" class="form-control">
            <option *ngFor="let type of issueTypes" [value]="type">{{ type }}</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Assigned To</label>
        <input type="text" formControlName="assignedTo" class="form-control" placeholder="Optional assignee">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Due Date</label>
          <input type="date" formControlName="dueDate" class="form-control">
        </div>
        <div class="form-group">
          <label>Attachment Path</label>
          <input type="text" formControlName="photoPath" class="form-control" placeholder="e.g., /files/photos/issue.jpg">
        </div>
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">Add Issue</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" *ngIf="isDeleteModalOpen">
  <div class="confirm-modal">
    <h3>Delete checklist item?</h3>
    <p>This action will permanently remove the selected checklist item.</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="cancelDeleteChecklistItem()">Cancel</button>
      <button type="button" class="btn btn-danger" (click)="confirmDeleteChecklistItem()">Delete</button>
    </div>
  </div>
</div>

<!-- Add Predefined Checklist Items Modal -->
<div class="modal-backdrop" *ngIf="isAddPredefinedItemsModalOpen" (click)="closeAddPredefinedItemsModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2>Add Predefined Checklist Items</h2>
        <p>Select items from the predefined checklist to add to this checkpoint.</p>
        <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length > 0" class="selection-info">
          <span *ngIf="selectedPredefinedItemIds.length > 0" class="selection-count">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            {{ selectedPredefinedItemIds.length }} of {{ availablePredefinedItems.length }} selected
          </span>
          <span *ngIf="selectedPredefinedItemIds.length === 0" class="selection-hint">
            Select items to add to the checkpoint
          </span>
          <div class="select-all-actions">
            <button 
              type="button" 
              class="btn-select-all" 
              (click)="areAllItemsSelected() ? deselectAllItems() : selectAllItems()"
              [disabled]="addingChecklistItems"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              {{ areAllItemsSelected() ? 'Deselect All' : 'Select All' }}
            </button>
          </div>
        </div>
      </div>
      <button class="icon-button" (click)="closeAddPredefinedItemsModal()" [disabled]="addingChecklistItems" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div *ngIf="loadingPredefinedItems" class="loading-state">
        <div class="spinner"></div>
        <p>Loading predefined items...</p>
      </div>
      <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length === 0" class="empty-state">
        <p>All predefined checklist items have been added to this checkpoint.</p>
        <p style="margin-top: 8px; font-size: 0.875rem; opacity: 0.7;">No additional items are available to add.</p>
      </div>
      <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length > 0" class="predefined-items-list">
        <div *ngFor="let group of getGroupedPredefinedItems()" class="predefined-items-group">
          <div class="group-header">
            <div class="group-header-left">
              <h3 class="group-title">{{ group.category }}</h3>
              <span class="group-count">{{ group.items.length }} item(s)</span>
            </div>
            <button 
              type="button" 
              class="btn-select-group" 
              (click)="areAllInGroupSelected(group.category) ? deselectAllInGroup(group.category) : selectAllInGroup(group.category)"
              [disabled]="addingChecklistItems"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              {{ areAllInGroupSelected(group.category) ? 'Deselect All' : 'Select All' }}
            </button>
          </div>
          <div class="group-items">
            <div 
              *ngFor="let item of group.items" 
              class="predefined-item-card"
              [class.selected]="isPredefinedItemSelected(item.predefinedItemId)"
              (click)="togglePredefinedItemSelection(item.predefinedItemId)"
              role="button"
              tabindex="0"
              (keydown.enter)="togglePredefinedItemSelection(item.predefinedItemId)"
              (keydown.space)="togglePredefinedItemSelection(item.predefinedItemId); $event.preventDefault()"
            >
              <div class="item-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="isPredefinedItemSelected(item.predefinedItemId)"
                  (change)="togglePredefinedItemSelection(item.predefinedItemId)"
                  (click)="$event.stopPropagation()"
                  [id]="'item-' + item.predefinedItemId"
                  [attr.aria-label]="'Select ' + item.checkpointDescription"
                />
              </div>
              <div class="item-content">
                <div class="item-main-line">
                  <span class="item-sequence">#{{ item.sequence }}</span>
                  <p class="item-description">{{ item.checkpointDescription }}</p>
                </div>
                <p class="item-reference" *ngIf="item.referenceDocument">
                  <strong>Reference:</strong> {{ item.referenceDocument }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="error" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>{{ error }}</span>
      </div>
    </div>
    <div class="modal-footer">
      <button 
        type="button" 
        class="btn btn-secondary" 
        (click)="closeAddPredefinedItemsModal()"
        [disabled]="addingChecklistItems"
      >
        Cancel
      </button>
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="onAddChecklistItems()"
        [disabled]="addingChecklistItems || selectedPredefinedItemIds.length === 0"
      >
        <span *ngIf="!addingChecklistItems">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Add Selected Items ({{ selectedPredefinedItemIds.length }})
        </span>
        <span *ngIf="addingChecklistItems">
          <span class="spinner-inline">
            <span class="spinner small"></span>
          </span>
          Adding...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Item Review Modal -->
<div class="modal-backdrop" *ngIf="isItemReviewModalOpen" (click)="closeItemReviewModal()">
  <div class="modal-container review-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2>Review Checklist Item</h2>
        <p *ngIf="selectedReviewItemIndex !== null" class="modal-subtitle">
          {{ checklistItems.at(selectedReviewItemIndex)?.get('checkpointDescription')?.value || 'Checklist Item' }}
        </p>
      </div>
      <button class="icon-button" (click)="closeItemReviewModal()" [disabled]="savingItemReview">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="itemReviewForm" *ngIf="selectedReviewItemIndex !== null">
        <div class="form-group">
          <label for="itemStatus">Status <span class="required">*</span></label>
          <div class="status-selector">
            <button
              type="button"
              class="status-option"
              [class.active]="itemReviewForm.get('status')?.value === CheckpointStatus.Pass"
              [class.pass]="itemReviewForm.get('status')?.value === CheckpointStatus.Pass"
              (click)="itemReviewForm.get('status')?.setValue(CheckpointStatus.Pass)"
              [disabled]="savingItemReview"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Pass
            </button>
            <button
              type="button"
              class="status-option"
              [class.active]="itemReviewForm.get('status')?.value === CheckpointStatus.Fail"
              [class.fail]="itemReviewForm.get('status')?.value === CheckpointStatus.Fail"
              (click)="itemReviewForm.get('status')?.setValue(CheckpointStatus.Fail)"
              [disabled]="savingItemReview"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Fail
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="itemReferenceDocument">Reference Document</label>
          <input
            id="itemReferenceDocument"
            type="text"
            formControlName="referenceDocument"
            class="form-control"
            placeholder="e.g., Drawing No., Specification"
            [disabled]="savingItemReview"
            maxlength="250"
          />
          <small class="form-text text-muted">Optional reference document or specification.</small>
        </div>

        <div class="form-group">
          <label for="itemRemarks">Remarks <span class="required" *ngIf="itemReviewForm.get('status')?.value === CheckpointStatus.Fail">*</span></label>
          <textarea
            id="itemRemarks"
            formControlName="remarks"
            class="form-control"
            rows="6"
            placeholder="Enter your review, observations, or remarks for this checklist item..."
            [disabled]="savingItemReview"
            maxlength="1000"
          ></textarea>
          <small class="form-text text-muted">
            Provide detailed feedback or observations. <span *ngIf="itemReviewForm.get('status')?.value === CheckpointStatus.Fail" class="text-danger">Remarks are required for failed items.</span>
          </small>
          <div *ngIf="itemReviewForm.get('remarks')?.invalid && itemReviewForm.get('remarks')?.touched" class="error-text">
            Remarks are required when status is Fail.
          </div>
        </div>
      </form>
      <div *ngIf="error" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>{{ error }}</span>
      </div>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="closeItemReviewModal()"
        [disabled]="savingItemReview"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="saveItemReview()"
        [disabled]="savingItemReview || isItemReviewFormInvalid()"
      >
        <span *ngIf="!savingItemReview">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          Save Review
        </span>
        <span *ngIf="savingItemReview">
          <span class="spinner-inline">
            <span class="spinner small"></span>
          </span>
          Saving...
        </span>
      </button>
    </div>
  </div>
</div>

