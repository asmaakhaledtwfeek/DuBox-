<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn-back" (click)="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          {{ fromContext === 'quality-control' ? 'Back to Quality Control' : 'Back to Box Details' }}
        </button>
        <h1 class="page-title" *ngIf="!qualityIssuesOnlyView">QA/QC Activity Approval Checklist</h1>
        <h1 class="page-title" *ngIf="qualityIssuesOnlyView">All Quality Issues</h1>
        <p class="page-subtitle" *ngIf="!qualityIssuesOnlyView && wirRecord">{{ wirRecord.wirCode }} - {{ wirRecord.activityName }}</p>
        <p class="page-subtitle" *ngIf="qualityIssuesOnlyView">
          Box-wide quality issues across every WIR checkpoint.
        </p>
      </div>
    </div>

    <div class="quality-list-only" *ngIf="qualityIssuesOnlyView">
      <div class="form-card aggregate-card">
        <div class="designer-headline">
          <div>
            <h3>All Quality Issues</h3>
            <p>List of every quality issue logged for this box.</p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ boxQualityIssues.length }}</strong> issue(s)</span>
            <button 
              type="button" 
              class="btn btn-primary btn-sm" 
              (click)="exportQualityIssuesToExcel()"
              [disabled]="boxIssuesLoading || boxQualityIssues.length === 0"
              title="Export quality issues to Excel"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Export to Excel
            </button>
          </div>
        </div>

        <div class="aggregated-table-wrapper">
          <div class="quality-issues-loading" *ngIf="boxIssuesLoading">
            <div class="spinner small"></div>
            <p>Loading quality issues...</p>
          </div>
          <div class="quality-issues-error" *ngIf="!boxIssuesLoading && boxIssuesError">
            <p>{{ boxIssuesError }}</p>
          </div>
          <ng-container *ngIf="!boxIssuesLoading && !boxIssuesError">
            <table class="designer-table" *ngIf="boxQualityIssues.length > 0; else noBoxIssuesForBox">
              <thead>
                <tr>
                  <th class="col-seq">Seq</th>
                  <th class="col-extra">Issue Type</th>
                  <th class="col-extra">Severity</th>
                  <th class="col-extra">Assigned To</th>
                  <th class="col-extra">Due Date</th>
                  <th class="col-extra">Reported By</th>
                  <th class="col-extra">Issue Date</th>
                  <th class="col-extra">Status</th>
                  <th class="col-extra">WIR</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let issue of boxQualityIssues; let i = index">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ issue.issueType || '‚Äî' }}</td>
                  <td>{{ issue.severity || '‚Äî' }}</td>
                  <td>{{ issue.assignedTo || '‚Äî' }}</td>
                  <td>{{ formatDate(issue.dueDate) }}</td>
                  <td>{{ issue.reportedBy || '‚Äî' }}</td>
                  <td>{{ formatDate(issue.issueDate) }}</td>
                  <td>{{ issue.status || 'Open' }}</td>
                  <td>{{ issue.wirNumber || issue.wirName || '‚Äî' }}</td>
                </tr>
              </tbody>
            </table>
            <ng-template #noBoxIssuesForBox>
              <div class="empty-checklist">
                <p>No quality issues logged for this box.</p>
                <small>Issues will appear here once created.</small>
              </div>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>

    <div *ngIf="!qualityIssuesOnlyView">
    <div class="stepper" *ngIf="!loading">
      <button
        type="button"
        class="step"
        *ngFor="let step of stepMeta"
        [class.completed]="isStepCompleted(step.id)"
        [class.active]="isStepActive(step.id)"
        [class.disabled]="!canNavigateToStep(step.id)"
        [disabled]="!canNavigateToStep(step.id)"
        (click)="handleStepClick(step.id)"
        [title]="!canNavigateToStep(step.id) ? 'Please complete previous steps first' : ''"
      >
        <div class="step-index">{{ getStepNumber(step.id) }}</div>
        <div class="step-meta">
          <div class="step-title">{{ step.title }}</div>
          <div class="step-subtitle">{{ step.subtitle }}</div>
        </div>
      </button>
    </div>

    <div class="pending-action-banner" *ngIf="pendingActionLabel && showOverviewState">
      <div class="banner-text">
        <strong>Next step:</strong> {{ pendingActionLabel }}
      </div>
      <button class="btn btn-primary btn-sm" (click)="triggerPendingAction()">
        Continue
      </button>
    </div>

    <div class="checkpoint-overview" *ngIf="showOverviewState">
      <div class="info-card summary-card">
        <div class="summary-header">
          <div>
            <h2 class="card-title">Inspection Request</h2>
            <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
          </div>
          <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
            {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
          </span>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested Date</span>
            <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Inspector</span>
            <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <div class="checklist-card">
        <div class="overview-actions">
          <h3>Checklist Items</h3>
          <div class="action-buttons">
            <button 
              class="btn btn-secondary btn-sm" 
              (click)="startAddChecklistFlow()"
              [disabled]="isChecklistLocked"
              [title]="isChecklistLocked ? 'Checklist is locked after review' : null"
            >
              Add Checklist Item
            </button>
            <button class="btn btn-primary btn-sm" (click)="startReviewFlow()" [disabled]="!canStartReview">
              Review Checkpoint
            </button>
          </div>
        </div>

        <ng-container *ngIf="hasChecklistItems; else emptyChecklist">
          <div class="checklist-table-wrapper compact">
            <table class="checklist-table">
              <thead>
                <tr>
                  <th style="width: 50px;">#</th>
                  <th>Checkpoint Description</th>
                  <th style="width: 180px;">Last Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of displayChecklistItems; let i = index">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ item.checkpointDescription }}</td>
                  <td>
                    <span class="badge"
                      [class.badge-warning]="item.status === 'Pending'"
                      [class.badge-success]="item.status === 'Pass'"
                      [class.badge-danger]="item.status === 'Fail'">
                      {{ item.status || 'Pending' }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
        <ng-template #emptyChecklist>
          <div class="empty-checklist">
            <p>No checklist items yet.</p>
            <small>Add checklist items to move this checkpoint into review.</small>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading checklist...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadWIRRecord()">Retry</button>
    </div>

    <!-- Step 1: Create WIR Checkpoint -->
    <div *ngIf="currentStep === 'create-checkpoint' && wirRecord && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 1: Create WIR Checkpoint</h2>
        <p class="step-description" *ngIf="!wirCheckpoint">Create a new WIR checkpoint for this activity</p>
        <p class="step-description" *ngIf="wirCheckpoint">Update WIR checkpoint information for this activity</p>
      </div>

      <form [formGroup]="createCheckpointForm" (ngSubmit)="onCreateCheckpoint()">
        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>

          <!-- Auto-filled information (read-only) -->
          <div class="info-section" *ngIf="wirRecord">
            <h3 class="info-section-title">Checkpoint Information</h3>
            <div class="info-grid-readonly">
              <div class="info-item">
                <span class="label">Box Tag</span>
                <span class="value">{{ wirRecord.boxTag }}</span>
              </div>
              <div class="info-item">
                <span class="label">WIR Number</span>
                <span class="value">{{ wirRecord.wirCode }}</span>
              </div>
              <div class="info-item">
                <span class="label">Activity Name</span>
                <span class="value">{{ wirRecord.activityName }}</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="wirName">WIR Name</label>
            <input 
              id="wirName" 
              type="text" 
              formControlName="wirName" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched"
              placeholder="e.g., Release from Assembly - WIR-1"
            >
            <div *ngIf="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched" class="error-text">
              WIR Name max 200 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="wirDescription">WIR Description</label>
            <textarea 
              id="wirDescription" 
              formControlName="wirDescription" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched"
              rows="3"
              placeholder="Description of the WIR checkpoint"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched" class="error-text">
              WIR Description max 500 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="attachmentPath">Attachment Path</label>
            <input 
              id="attachmentPath" 
              type="text" 
              formControlName="attachmentPath" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('attachmentPath')?.invalid && createCheckpointForm.get('attachmentPath')?.touched"
              placeholder="e.g., /attachments/wir-1-drawing.pdf"
            >
            <div *ngIf="createCheckpointForm.get('attachmentPath')?.invalid && createCheckpointForm.get('attachmentPath')?.touched" class="error-text">
              Attachment Path max 500 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="comments">Comments</label>
            <textarea 
              id="comments" 
              formControlName="comments" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched"
              rows="3"
              placeholder="Additional comments"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched" class="error-text">
              Comments max 1000 characters.
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="creatingCheckpoint || createCheckpointForm.invalid">
              <span *ngIf="creatingCheckpoint">Creating...</span>
              <span *ngIf="!creatingCheckpoint">Create Checkpoint</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 2: Add Checklist Items -->
    <div *ngIf="currentStep === 'add-items' && wirCheckpoint && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 2: Add Checklist Items</h2>
        <p class="step-description">Add checklist items to the WIR checkpoint</p>
      </div>

      <div class="info-card summary-card">
        <div class="summary-header">
          <div>
            <h2 class="card-title">Inspection Request</h2>
            <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
          </div>
          <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
            {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
          </span>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested Date</span>
            <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Inspector</span>
            <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <form [formGroup]="addChecklistItemsForm" (ngSubmit)="onAddChecklistItems()" class="checklist-designer">
        <div class="designer-headline">
          <div>
            <h3>Checklist Designer</h3>
            <p>Create or edit inspection checkpoints for this WIR.</p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ wirCheckpoint?.checklistItems?.length || 0 }}</strong> item(s)</span>
            <button 
              type="button" 
              class="btn btn-secondary btn-sm" 
              (click)="openAddPredefinedItemsModal()"
              [disabled]="isChecklistLocked || loadingPredefinedItems"
              [title]="isChecklistLocked ? 'Checklist is locked after review' : null"
            >
              + Add Predefined Items
            </button>
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              (click)="handleStepClick('review')"
              [disabled]="!canNavigateToStep('review')"
            >
              Review
            </button>
          </div>
        </div>

        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>
          <div class="checklist-table-wrapper" formArrayName="checklistItems">
            <div *ngIf="addChecklistItemsArray.length > 0; else noChecklistPlaceholder" class="grouped-checklist-table">
              <ng-container *ngFor="let group of getGroupedChecklistItems()">
                <div class="checklist-category-group" *ngIf="group.items.length > 0">
                  <div class="category-header">
                    <h4 class="category-title">{{ group.categoryName }}</h4>
                    <span class="category-count">{{ group.items.length }} item(s)</span>
                  </div>
                  <table class="designer-table">
                   
                    <tbody>
                      <tr *ngFor="let itemData of group.items" [formGroupName]="itemData.index">
                        <td class="text-center">{{ itemData.index + 1 }}</td>
                        <td>{{ itemData.control.get('checkpointDescription')?.value }}</td>
                        <td class="text-right actions-cell">
                          <button 
                            type="button" 
                            class="icon-button" 
                            (click)="confirmRemoveChecklistItem(itemData.index)"
                            title="Delete item"
                          >
                            üóëÔ∏è
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </ng-container>
            </div>
            <ng-template #noChecklistPlaceholder>
              <div class="empty-checklist">
                <p>No checklist items added yet.</p>
                <small>Click "Add Predefined Items" to select from the predefined checklist.</small>
              </div>
            </ng-template>
          </div>

          <div class="form-actions sticky-actions">
            <button type="button" class="btn btn-secondary" (click)="closeWorkflowStep()">Close</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 3: Review Checklist -->
    <form [formGroup]="checklistForm" *ngIf="currentStep === 'review' && wirCheckpoint && !loading && !error" class="review-form">
      <div class="review-layout">
        <div class="review-main">
      <!-- WIR Information Card -->
          <div class="info-card summary-card">
            <div class="summary-header">
              <div>
                <h2 class="card-title">Inspection Request</h2>
                <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
          </div>
              <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
                {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
              </span>
          </div>
            <div class="summary-grid">
              <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
              <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
              <div class="summary-item">
            <span class="label">Requested Date</span>
                <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Inspector</span>
                <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <!-- Inspector Notes and Photos -->
      <div class="notes-photos-layout">
        <!-- Photo Upload -->
        <!-- Existing Images Section -->
        <div class="photos-card existing-images-card" *ngIf="getCheckpointImageUrls().length > 0">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            Existing Inspection Photos
            <span class="image-count-badge">{{ getCheckpointImageUrls().length }}</span>
          </h2>
          
          <div class="existing-images-grid">
            <div class="existing-image-item" *ngFor="let imageUrl of getCheckpointImageUrls(); let i = index">
              <div class="existing-image-wrapper">
                <img 
                  [src]="imageUrl" 
                  [alt]="'Inspection photo ' + (i + 1)"
                  class="existing-image-thumbnail"
                  (click)="openCheckpointImageInNewTab(imageUrl)"
                  (error)="onCheckpointImageError($event)"
                  loading="lazy"
                />
                <div class="existing-image-overlay">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </div>
                <div class="existing-image-number">{{ i + 1 }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="photos-card">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            Inspection Photos
            <span class="image-count-badge" *ngIf="selectedImages.length > 0">{{ selectedImages.length }}</span>
          </h2>
          
          <p class="photo-upload-hint">Upload multiple images, enter URLs, or use your camera</p>
          
          <!-- Selected Images Preview List -->
          <div class="selected-images-list" *ngIf="selectedImages.length > 0">
            <div class="image-preview-item" *ngFor="let image of selectedImages; let i = index">
              <div class="image-preview-wrapper">
                <img [src]="image.preview || image.url" [alt]="image.name || 'Image preview'" />
                <button 
                  type="button" 
                  class="remove-image-btn" 
                  (click)="removeImage(image.id)" 
                  [disabled]="isUploadingPhoto || submitting"
                  title="Remove image"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
                <div class="image-type-badge" [class.type-file]="image.type === 'file' || image.type === 'camera'" [class.type-url]="image.type === 'url'">
                  {{ image.type === 'file' || image.type === 'camera' ? 'File' : 'URL' }}
                </div>
              </div>
              <div class="image-info" *ngIf="image.name || image.url">
                <p class="image-name" *ngIf="image.name">{{ image.name }}</p>
                <p class="image-url" *ngIf="image.url">{{ image.url }}</p>
                <p class="image-size" *ngIf="image.file">{{ (image.file.size / 1024).toFixed(1) }} KB</p>
              </div>
            </div>
            <button 
              type="button" 
              class="btn-clear-all" 
              (click)="clearAllImages()" 
              [disabled]="isUploadingPhoto || submitting"
              *ngIf="selectedImages.length > 1"
            >
              Clear All
            </button>
          </div>
          
          <!-- Tabs for different input methods -->
          <div class="photo-input-tabs" *ngIf="!showCamera">
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'url'"
              (click)="photoInputMethod = 'url'; showCamera = false"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
              </svg>
              URL
            </button>
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'upload'"
              (click)="openFileInput(); photoInputMethod = 'upload'"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Upload
            </button>
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'camera'"
              (click)="openCamera()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
              Camera
            </button>
          </div>

          <!-- URL Input -->
          <div *ngIf="photoInputMethod === 'url' && !showCamera" class="photo-input-content">
            <div class="url-input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Enter photo URL (e.g., https://example.com/photo.jpg)"
                [(ngModel)]="currentUrlInput"
                [ngModelOptions]="{standalone: true}"
                [disabled]="isUploadingPhoto || submitting"
                (keydown.enter)="addImageFromUrl(); $event.preventDefault()"
              />
              <button 
                type="button" 
                class="btn-add-url" 
                (click)="addImageFromUrl()"
                [disabled]="isUploadingPhoto || submitting || !currentUrlInput?.trim()"
              >
                Add URL
              </button>
            </div>
          </div>

          <!-- File Upload Input (hidden, supports multiple) -->
          <input
            id="wir-photo-file-input"
            type="file"
            accept="image/*"
            multiple
            style="display: none"
            (change)="onPhotosSelected($event)"
            [disabled]="isUploadingPhoto || submitting"
          />

          <!-- Camera Preview -->
          <div *ngIf="showCamera" id="camera-preview-container" class="camera-preview-container">
            <video 
              id="wir-camera-preview" 
              autoplay 
              playsinline 
              muted
              style="display: block; visibility: visible; opacity: 1;"
            ></video>
            <div class="camera-controls">
              <button type="button" class="btn btn-secondary btn-sm" (click)="stopCamera()">
                Cancel
              </button>
              <button type="button" class="btn btn-primary btn-sm" (click)="capturePhoto()" [disabled]="submitting">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                Capture
              </button>
            </div>
          </div>

          <!-- Upload Progress -->
          <div *ngIf="isUploadingPhoto" class="upload-progress">
            <div class="spinner-small"></div>
            <span>Uploading photos...</span>
          </div>

          <!-- Errors -->
          <p class="form-text text-danger" *ngIf="photoUploadError">{{ photoUploadError }}</p>
          <small class="form-text" *ngIf="!photoUploadError && selectedImages.length === 0">JPG, PNG (Max 5MB each)</small>
        </div>
      </div>

      <!-- Checklist Items -->
      <div class="checklist-card">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
              Checklist Validation
        </h2>
        
        <div class="checklist-table-wrapper">
          <table class="checklist-table">
            <thead>
              <tr>
                <th style="width: 60px;">#</th>
                <th>Checkpoint Description</th>
                <th style="width: 150px;">Status</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody formArrayName="checklistItems">
              <tr *ngFor="let item of checklistItems.controls; let i = index" [formGroupName]="i">
                <td class="text-center">{{ i + 1 }}</td>
                <td class="checkpoint-desc">
                  <div class="checkpoint-description-text">
                    {{ item.get('checkpointDescription')?.value || '‚Äî' }}
                  </div>
                </td>
                <td class="status-display">
                  <span class="status-badge" [ngClass]="getStatusBadgeClass(item.value.status)">
                    {{ getStatusLabel(item.value.status) }}
                  </span>
                </td>
                <td class="text-right actions-cell">
                  <button 
                    type="button" 
                    class="btn btn-primary btn-sm btn-review" 
                    (click)="openItemReviewModal(i)"
                    [disabled]="isChecklistLocked || !canReviewItem(item.value.status)"
                    [title]="getReviewButtonTitle(item.value.status, isChecklistLocked)"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Review
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="checklistItems.length === 0" class="empty-checklist">
            <p>No checklist items available.</p>
            <small>Please add checklist items first.</small>
          </div>
        </div>
      </div>
      </div>

        <aside class="review-side">
          <div class="status-overview-card">
            <h3>Status Overview</h3>
            <ul class="status-timeline">
              <li>
                <span class="label">Requested</span>
                <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
              </li>
              <li>
                <span class="label">Inspection</span>
                <span class="value">{{ formatDateTime(wirCheckpoint!.inspectionDate) }}</span>
              </li>
              <li>
                <span class="label">Approval</span>
                <span class="value">{{ formatDateTime(wirCheckpoint!.approvalDate) }}</span>
              </li>
            </ul>
      </div>
          <!-- Inspection Notes -->
          <div class="notes-card">
            <h2 class="card-title">Inspector Notes</h2>
            <div class="notes-inputs-grid">
              <div class="form-group">
                <label for="inspectorRoleInput">Inspector Role</label>
                <input
                  id="inspectorRoleInput"
                  type="text"
                  formControlName="inspectorRole"
                  class="form-control"
                  maxlength="100"
                  placeholder="e.g., QC Engineer - MEP"
                >
                <small class="form-text text-muted">Optional, max 100 characters.</small>
              </div>
              <div class="form-group">
                <label for="inspectionNotesInput">Comments</label>
                <textarea 
                  id="inspectionNotesInput"
                  formControlName="inspectionNotes"
                  class="form-control"
                  rows="4"
                  placeholder="Add general inspection notes, observations, or recommendations..."
                ></textarea>
                <small class="form-text">{{ checklistForm.value.inspectionNotes?.length || 0 }}/1000 characters</small>
              </div>
            </div>
          </div>

         

          <!-- Rejection Reason -->
      <!-- Action Buttons -->
          <div class="decision-card side-card">
            <h3>Final Decision</h3>
            <div class="final-status-selector">
              <button 
                type="button" 
                class="status-chip-btn" 
                *ngFor="let option of finalStatusOptions"
                [class.active]="finalStatusControl.value === option.value"
                (click)="onFinalStatusSelect(option.value)"
              >
                {{ option.label }}
              </button>
            </div>
            <p>Select a status and submit after completing the checklist.</p>
            <div class="action-buttons vertical">
        <button 
          type="button" 
          class="btn btn-secondary"
                (click)="closeWorkflowStep()"
          [disabled]="submitting"
        >
                Close
        </button>
        
        <button 
          type="button" 
                class="btn btn-success"
                (click)="onSubmitReview()"
                [disabled]="!canSubmitReview() || submitting"
              >
                {{ submitting ? 'Submitting...' : 'Submit Decision' }}
              </button>
            </div>
          </div>
        </aside>
      </div>
    </form>

    <!-- Step 4: Quality Issues (Optional) -->
    <div *ngIf="currentStep === 'quality-issues' && wirCheckpoint && !loading && !error" class="step-container quality-issues-step">
      <div class="step-header">
        <h2>Step 4: Quality Issues (Optional)</h2>
        <p class="step-description">Log defects, non-conformances, or observations that need follow-up outside of the review workflow.</p>
      </div>

      <div class="quality-issues-summary">
        <div class="info-card summary-card">
          <div class="summary-header">
            <div>
              <h2 class="card-title">Inspection Request</h2>
              <p class="card-subtitle">{{ wirRecord?.wirCode }} ‚Ä¢ {{ wirRecord?.activityName }}</p>
            </div>
            <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
              {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
            </span>
          </div>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="label">Box Tag</span>
              <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Requested By</span>
              <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Requested Date</span>
              <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Inspector</span>
              <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="quality-issues-table-card" [formGroup]="qualityIssuesForm">
        <div class="designer-headline">
          <div>
            <h3>Quality Issues</h3>
            <p>Manage outstanding inspection issues for this checkpoint.</p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ qualityIssuesArray.length }}</strong> issue(s)</span>
            <button type="button" class="btn btn-primary btn-sm" (click)="openQualityIssueModal()">
              + Add Quality Issue
            </button>
          </div>
        </div>

        <div class="form-card">
          <div class="checklist-table-wrapper" formArrayName="issues">
            <table class="designer-table" *ngIf="qualityIssuesArray.length > 0; else noQualityIssues">
              <thead>
                <tr>
                  <th class="col-seq">Seq</th>
                  <th class="col-extra">Issue Type</th>
                  <th class="col-extra">Severity</th>
                  <th class="col-extra">Assigned To</th>
                  <th class="col-extra">Due Date</th>
                  <th class="col-extra">Reported By</th>
                  <th class="col-extra">Issue Date</th>
                  <th class="col-actions text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let issue of qualityIssuesArray.controls; let i = index" [formGroupName]="i">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ issue.get('issueType')?.value }}</td>
                  <td>{{ issue.get('severity')?.value }}</td>
                  <td>{{ issue.get('assignedTo')?.value || '‚Äî' }}</td>
                  <td>{{ issue.get('dueDate')?.value || '‚Äî' }}</td>
                  <td>{{ getExistingQualityIssue(i)?.reportedBy || 'Current User' }}</td>
                  <td>
                    {{ getExistingQualityIssue(i)?.issueDate ? formatDate(getExistingQualityIssue(i)?.issueDate) : (issue.get('dueDate')?.value || '‚Äî') }}
                  </td>
                  <td class="text-right actions-cell">
                    <div class="action-buttons-group">
                      <button 
                        type="button" 
                        class="icon-button btn-icon-primary" 
                        (click)="viewQualityIssueDetails(i)"
                        title="View issue details"
                        aria-label="View issue details"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                          <circle cx="12" cy="12" r="3"/>
                        </svg>
                      </button>
                      <button 
                        type="button" 
                        class="icon-button btn-icon-danger" 
                        (click)="removeQualityIssue(i)"
                        title="Delete issue"
                        aria-label="Delete issue"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noQualityIssues>
              <div class="empty-checklist">
                <p>No quality issues added yet.</p>
                <small>Click ‚ÄúAdd Quality Issue‚Äù to create one.</small>
              </div>
            </ng-template>
          </div>

          <div class="form-actions sticky-actions">
            <button type="button" class="btn btn-primary" (click)="closeWorkflowStep()">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Checklist Item Modal -->
<div class="modal-backdrop" *ngIf="isChecklistModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Add Checklist Item</h3>
      <button type="button" class="btn btn-secondary btn-sm" (click)="closeChecklistModal()">Close</button>
    </div>
    <form [formGroup]="newChecklistForm" (ngSubmit)="addChecklistItemFromModal()">
      <div class="form-group">
        <label>Description <span class="required">*</span></label>
        <textarea formControlName="checkpointDescription" class="form-control" rows="3" placeholder="Enter checkpoint description"></textarea>
      </div>
      <div class="form-group">
        <label>Reference Document</label>
        <input type="text" formControlName="referenceDocument" class="form-control" placeholder="e.g., Drawing No., Specification">
      </div>
      <small class="form-text">Sequence will auto-increment based on item order.</small>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">Add Item</button>
      </div>
    </form>
  </div>
</div>

<!-- Quality Issue Modal -->
<div class="modal-backdrop quality-issue-modal-backdrop" *ngIf="isQualityIssueModalOpen" (click)="closeQualityIssueModal()">
  <div class="modal-card quality-issue-modal" (click)="$event.stopPropagation()">
    <div class="modal-header quality-issue-modal-header">
      <div class="header-content">
        <div class="header-title-section">
          <h3 class="modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 12px;">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Add Quality Issue
          </h3>
          <p class="modal-subtitle">Log a new quality issue for this inspection checkpoint</p>
        </div>
      </div>
      <button type="button" class="icon-button" (click)="closeQualityIssueModal()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <form [formGroup]="newQualityIssueForm" (ngSubmit)="addQualityIssueFromModal()" class="quality-issue-form-content">
      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          Description
          <span class="required">*</span>
        </label>
        <textarea 
          formControlName="issueDescription" 
          class="form-control form-textarea" 
          rows="4" 
          placeholder="Describe the quality issue in detail..."
          [class.error]="newQualityIssueForm.get('issueDescription')?.invalid && newQualityIssueForm.get('issueDescription')?.touched"
        ></textarea>
        <small class="form-hint" *ngIf="!newQualityIssueForm.get('issueDescription')?.invalid || !newQualityIssueForm.get('issueDescription')?.touched">
          Provide a clear and detailed description of the quality issue
        </small>
        <small class="form-error" *ngIf="newQualityIssueForm.get('issueDescription')?.invalid && newQualityIssueForm.get('issueDescription')?.touched">
          Description is required
        </small>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Severity
          </label>
          <select formControlName="severity" class="form-control form-select">
            <option *ngFor="let severity of severityLevels" [value]="severity">{{ severity }}</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            Issue Type
          </label>
          <select formControlName="issueType" class="form-control form-select">
            <option *ngFor="let type of issueTypes" [value]="type">{{ type }}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Assigned To
        </label>
        <input 
          type="text" 
          formControlName="assignedTo" 
          class="form-control" 
          placeholder="Enter assignee name (optional)"
        >
        <small class="form-hint">Optional: Assign this issue to a specific team member</small>
      </div>

      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          Due Date
        </label>
        <input 
          type="date" 
          formControlName="dueDate" 
          class="form-control form-date"
        >
        <small class="form-hint">Optional: Set a target resolution date</small>
      </div>

      <!-- Quality Issue Images -->
      <div class="form-group quality-issue-images-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          Attachments
          <span class="image-count-badge" *ngIf="qualityIssueImages.length > 0" style="margin-left: 8px;">{{ qualityIssueImages.length }}</span>
        </label>
        <small class="form-hint" style="margin-bottom: 12px;">Upload images, enter URLs, or use your camera</small>

        <!-- Selected Images Grid -->
        <div class="selected-images-list quality-issue-images-list" *ngIf="qualityIssueImages.length > 0">
          <div class="image-preview-item" *ngFor="let image of qualityIssueImages">
            <div class="image-preview-wrapper">
              <img [src]="image.preview" [alt]="image.name || 'Quality issue image'" />
              <button 
                type="button" 
                class="remove-image-btn" 
                (click)="removeQualityIssueImage(image.id)"
                title="Remove image"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
              <div class="image-type-badge" [class.type-file]="image.type === 'file' || image.type === 'camera'" [class.type-url]="image.type === 'url'">
                {{ image.type === 'file' || image.type === 'camera' ? 'File' : 'URL' }}
              </div>
            </div>
            <div class="image-info" *ngIf="image.name || image.url">
              <p class="image-name" *ngIf="image.name">{{ image.name }}</p>
              <p class="image-url" *ngIf="image.url">{{ image.url }}</p>
              <p class="image-size" *ngIf="image.file">{{ (image.file.size / 1024).toFixed(1) }} KB</p>
            </div>
          </div>
          <button 
            type="button" 
            class="btn-clear-all" 
            (click)="clearAllQualityIssueImages()" 
            *ngIf="qualityIssueImages.length > 1"
          >
            Clear All
          </button>
        </div>

        <!-- Input Method Tabs -->
        <div class="photo-input-tabs" *ngIf="!showQualityIssueCamera">
          <button 
            type="button"
            class="tab-button"
            [class.active]="qualityIssuePhotoInputMethod === 'url'"
            (click)="qualityIssuePhotoInputMethod = 'url'; showQualityIssueCamera = false"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            URL
          </button>
          <button 
            type="button"
            class="tab-button"
            [class.active]="qualityIssuePhotoInputMethod === 'upload'"
            (click)="openQualityIssueFileInput(); qualityIssuePhotoInputMethod = 'upload'"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Upload
          </button>
          <button 
            type="button"
            class="tab-button"
            [class.active]="qualityIssuePhotoInputMethod === 'camera'"
            (click)="openQualityIssueCamera()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Camera
          </button>
        </div>

        <!-- URL Input -->
        <div *ngIf="qualityIssuePhotoInputMethod === 'url' && !showQualityIssueCamera" class="photo-input-content">
          <div class="url-input-group">
            <input
              type="text"
              class="form-control"
              placeholder="Enter image URL (e.g., https://example.com/photo.jpg)"
              [(ngModel)]="qualityIssueCurrentUrlInput"
              [ngModelOptions]="{standalone: true}"
              (keydown.enter)="addQualityIssueImageFromUrl(); $event.preventDefault()"
            />
            <button 
              type="button" 
              class="btn-add-url" 
              (click)="addQualityIssueImageFromUrl()"
              [disabled]="!qualityIssueCurrentUrlInput?.trim()"
            >
              Add URL
            </button>
          </div>
        </div>

        <!-- File Upload Input (hidden, supports multiple) -->
        <input
          id="quality-issue-photo-file-input"
          type="file"
          accept="image/*"
          multiple
          style="display: none"
          (change)="onQualityIssuePhotosSelected($event)"
        />

        <!-- Camera Preview -->
        <div *ngIf="showQualityIssueCamera" class="camera-preview-container quality-issue-camera">
          <video
            id="quality-issue-video"
            autoplay
            playsinline
            class="camera-video"
          ></video>
          <div class="camera-controls">
            <button 
              type="button" 
              class="btn btn-secondary btn-sm" 
              (click)="stopQualityIssueCamera()"
            >
              Cancel
            </button>
            <button 
              type="button" 
              class="btn btn-primary btn-sm" 
              (click)="captureQualityIssuePhoto()"
            >
              Capture
            </button>
          </div>
        </div>
      </div>

      <div class="modal-footer quality-issue-modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="closeQualityIssueModal()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="newQualityIssueForm.invalid || savingQualityIssue"
        >
          <span *ngIf="savingQualityIssue" class="spinner small" style="display: inline-block; margin-right: 8px;"></span>
          <svg *ngIf="!savingQualityIssue" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          <span *ngIf="savingQualityIssue">Adding Issue...</span>
          <span *ngIf="!savingQualityIssue">Add Issue</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" *ngIf="isDeleteModalOpen">
  <div class="confirm-modal">
    <h3>Delete checklist item?</h3>
    <p>This action will permanently remove the selected checklist item.</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="cancelDeleteChecklistItem()">Cancel</button>
      <button type="button" class="btn btn-danger" (click)="confirmDeleteChecklistItem()">Delete</button>
    </div>
  </div>
</div>

<!-- Add Predefined Checklist Items Modal -->
<div class="modal-backdrop" *ngIf="isAddPredefinedItemsModalOpen" (click)="closeAddPredefinedItemsModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2>Add Predefined Checklist Items</h2>
        <p>Select items from the predefined checklist to add to this checkpoint.</p>
        <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length > 0" class="selection-info">
          <span *ngIf="selectedPredefinedItemIds.length > 0" class="selection-count">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            {{ selectedPredefinedItemIds.length }} of {{ availablePredefinedItems.length }} selected
          </span>
          <span *ngIf="selectedPredefinedItemIds.length === 0" class="selection-hint">
            Select items to add to the checkpoint
          </span>
          <div class="select-all-actions">
            <button 
              type="button" 
              class="btn-select-all" 
              (click)="areAllItemsSelected() ? deselectAllItems() : selectAllItems()"
              [disabled]="addingChecklistItems"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              {{ areAllItemsSelected() ? 'Deselect All' : 'Select All' }}
            </button>
          </div>
        </div>
      </div>
      <button class="icon-button" (click)="closeAddPredefinedItemsModal()" [disabled]="addingChecklistItems" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div *ngIf="loadingPredefinedItems" class="loading-state">
        <div class="spinner"></div>
        <p>Loading predefined items...</p>
      </div>
      <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length === 0" class="empty-state">
        <p>All predefined checklist items have been added to this checkpoint.</p>
        <p style="margin-top: 8px; font-size: 0.875rem; opacity: 0.7;">No additional items are available to add.</p>
      </div>
      <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length > 0" class="predefined-items-list">
        <div *ngFor="let group of getGroupedPredefinedItems()" class="predefined-items-group">
          <div class="group-header">
            <div class="group-header-left">
              <h3 class="group-title">{{ group.category }}</h3>
              <span class="group-count">{{ group.items.length }} item(s)</span>
            </div>
            <button 
              type="button" 
              class="btn-select-group" 
              (click)="areAllInGroupSelected(group.category) ? deselectAllInGroup(group.category) : selectAllInGroup(group.category)"
              [disabled]="addingChecklistItems"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              {{ areAllInGroupSelected(group.category) ? 'Deselect All' : 'Select All' }}
            </button>
          </div>
          <div class="group-items">
            <div 
              *ngFor="let item of group.items" 
              class="predefined-item-card"
              [class.selected]="isPredefinedItemSelected(item.predefinedItemId)"
              (click)="togglePredefinedItemSelection(item.predefinedItemId)"
              role="button"
              tabindex="0"
              (keydown.enter)="togglePredefinedItemSelection(item.predefinedItemId)"
              (keydown.space)="togglePredefinedItemSelection(item.predefinedItemId); $event.preventDefault()"
            >
              <div class="item-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="isPredefinedItemSelected(item.predefinedItemId)"
                  (change)="togglePredefinedItemSelection(item.predefinedItemId)"
                  (click)="$event.stopPropagation()"
                  [id]="'item-' + item.predefinedItemId"
                  [attr.aria-label]="'Select ' + item.checkpointDescription"
                />
              </div>
              <div class="item-content">
                <div class="item-main-line">
                  <span class="item-sequence">#{{ item.sequence }}</span>
                  <p class="item-description">{{ item.checkpointDescription }}</p>
                </div>
                <p class="item-reference" *ngIf="item.referenceDocument">
                  <strong>Reference:</strong> {{ item.referenceDocument }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="error" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>{{ error }}</span>
      </div>
    </div>
    <div class="modal-footer">
      <button 
        type="button" 
        class="btn btn-secondary" 
        (click)="closeAddPredefinedItemsModal()"
        [disabled]="addingChecklistItems"
      >
        Cancel
      </button>
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="onAddChecklistItems()"
        [disabled]="addingChecklistItems || selectedPredefinedItemIds.length === 0"
      >
        <span *ngIf="!addingChecklistItems">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Add Selected Items ({{ selectedPredefinedItemIds.length }})
        </span>
        <span *ngIf="addingChecklistItems">
          <span class="spinner-inline">
            <span class="spinner small"></span>
          </span>
          Adding...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Item Review Modal -->
<div class="modal-backdrop" *ngIf="isItemReviewModalOpen" (click)="closeItemReviewModal()">
  <div class="modal-container review-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2>Review Checklist Item</h2>
        <p *ngIf="selectedReviewItemIndex !== null" class="modal-subtitle">
          {{ checklistItems.at(selectedReviewItemIndex)?.get('checkpointDescription')?.value || 'Checklist Item' }}
        </p>
      </div>
      <button class="icon-button" (click)="closeItemReviewModal()" [disabled]="savingItemReview">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="itemReviewForm" *ngIf="selectedReviewItemIndex !== null">
        <div class="form-group">
          <label for="itemStatus">Status <span class="required">*</span></label>
          <div class="status-selector">
            <button
              type="button"
              class="status-option"
              [class.active]="itemReviewForm.get('status')?.value === CheckpointStatus.Pass"
              [class.pass]="itemReviewForm.get('status')?.value === CheckpointStatus.Pass"
              (click)="itemReviewForm.get('status')?.setValue(CheckpointStatus.Pass)"
              [disabled]="savingItemReview"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Pass
            </button>
            <button
              type="button"
              class="status-option"
              [class.active]="itemReviewForm.get('status')?.value === CheckpointStatus.Fail"
              [class.fail]="itemReviewForm.get('status')?.value === CheckpointStatus.Fail"
              (click)="itemReviewForm.get('status')?.setValue(CheckpointStatus.Fail)"
              [disabled]="savingItemReview"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Fail
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="itemReferenceDocument">Reference Document</label>
          <input
            id="itemReferenceDocument"
            type="text"
            formControlName="referenceDocument"
            class="form-control"
            placeholder="e.g., Drawing No., Specification"
            [disabled]="savingItemReview"
            maxlength="250"
          />
          <small class="form-text text-muted">Optional reference document or specification.</small>
        </div>

        <div class="form-group">
          <label for="itemRemarks">Remarks <span class="required" *ngIf="itemReviewForm.get('status')?.value === CheckpointStatus.Fail">*</span></label>
          <textarea
            id="itemRemarks"
            formControlName="remarks"
            class="form-control"
            rows="6"
            placeholder="Enter your review, observations, or remarks for this checklist item..."
            [disabled]="savingItemReview"
            maxlength="1000"
          ></textarea>
          <small class="form-text text-muted">
            Provide detailed feedback or observations. <span *ngIf="itemReviewForm.get('status')?.value === CheckpointStatus.Fail" class="text-danger">Remarks are required for failed items.</span>
          </small>
          <div *ngIf="itemReviewForm.get('remarks')?.invalid && itemReviewForm.get('remarks')?.touched" class="error-text">
            Remarks are required when status is Fail.
          </div>
        </div>
      </form>
      <div *ngIf="error" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>{{ error }}</span>
      </div>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="closeItemReviewModal()"
        [disabled]="savingItemReview"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="saveItemReview()"
        [disabled]="savingItemReview || isItemReviewFormInvalid()"
      >
        <span *ngIf="!savingItemReview">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          Save Review
        </span>
        <span *ngIf="savingItemReview">
          <span class="spinner-inline">
            <span class="spinner small"></span>
          </span>
          Saving...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Quality Issue Details Modal -->
<div class="status-modal-backdrop" *ngIf="isQualityIssueDetailsModalOpen && selectedQualityIssueDetails" (click)="closeQualityIssueDetailsModal()">
  <div class="details-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <div class="header-main">
        <h2 class="modal-title">Quality Issue Details</h2>
        <div class="header-badges">
          <span class="issue-type-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
              <path d="M2 12l10 5 10-5"/>
            </svg>
            {{ getQualityIssueDetail('issueType') || 'Issue' }}
          </span>
          <span class="severity-badge" [ngClass]="'severity-' + (getQualityIssueDetail('severity')?.toLowerCase() || '')">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="getQualityIssueDetail('severity')?.toLowerCase() === 'critical'">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
              <path d="M2 12l10 5 10-5"/>
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="getQualityIssueDetail('severity')?.toLowerCase() === 'major'">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="getQualityIssueDetail('severity')?.toLowerCase() === 'minor'">
              <circle cx="12" cy="12" r="10"/>
            </svg>
            {{ getQualityIssueDetail('severity') || '‚Äî' }}
          </span>
        </div>
      </div>
      <button class="icon-button" (click)="closeQualityIssueDetailsModal()" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="header-divider"></div>

    <!-- Content -->
    <div class="modal-body">
      <div class="modal-columns">
        <!-- Left Column -->
        <div class="column-left">
          <!-- Details Section -->
          <div class="content-section">
            <h3 class="section-label">DETAILS</h3>
            <div class="section-content">
              <div class="field-group" *ngIf="getQualityIssueDetail('status')">
                <label class="field-label">STATUS</label>
                <div class="field-value">
                  <span class="status-pill" [ngClass]="getQualityIssueStatusClass(getQualityIssueDetail('status'))">
                    {{ getQualityIssueStatusLabel(getQualityIssueDetail('status')) }}
                  </span>
                </div>
              </div>
              <div class="field-group" *ngIf="getQualityIssueDetail('issueDate')">
                <label class="field-label">ISSUE DATE</label>
                <div class="field-value">{{ formatIssueDate(getQualityIssueDetail('issueDate')) }}</div>
              </div>
              <div class="field-group" *ngIf="getQualityIssueDetail('dueDate')">
                <label class="field-label">DUE DATE</label>
                <div class="field-value">{{ formatIssueDate(getQualityIssueDetail('dueDate')) }}</div>
              </div>
            </div>
          </div>

          <!-- Description Section -->
          <div class="content-section" *ngIf="getQualityIssueDetail('issueDescription')">
            <h3 class="section-label">DESCRIPTION</h3>
            <div class="section-content">
              <div class="description-text">{{ getQualityIssueDetail('issueDescription') }}</div>
            </div>
          </div>
        </div>

        <!-- Column Separator -->
        <div class="column-separator"></div>

        <!-- Right Column -->
        <div class="column-right">
          <!-- Assigned Section -->
          <div class="content-section">
            <h3 class="section-label">ASSIGNED</h3>
            <div class="section-content">
              <div class="field-group">
                <label class="field-label">REPORTED BY</label>
                <div class="field-value">{{ selectedQualityIssueDetails.issue?.reportedBy || '‚Äî' }}</div>
              </div>
              <div class="field-group">
                <label class="field-label">ASSIGNED TO</label>
                <div class="field-value">{{ getQualityIssueDetail('assignedTo') || '‚Äî' }}</div>
              </div>
            </div>
          </div>

          <!-- Box Info Section -->
          <div class="content-section" *ngIf="wirCheckpoint">
            <h3 class="section-label">BOX INFO</h3>
            <div class="section-content">
              <div class="field-group" *ngIf="wirCheckpoint.box">
                <label class="field-label">BOX</label>
                <div class="field-value">{{ wirCheckpoint.box.boxTag || wirCheckpoint.box.boxName || '‚Äî' }}</div>
              </div>
              <div class="field-group" *ngIf="wirCheckpoint.wirNumber">
                <label class="field-label">WIR</label>
                <div class="field-value">
                  {{ wirCheckpoint.wirNumber || '‚Äî' }}
                  <span class="wir-status" *ngIf="wirCheckpoint.status"> ‚Ä¢ {{ wirCheckpoint.status }}</span>
                </div>
              </div>
              <div class="field-group" *ngIf="wirCheckpoint.requestedDate">
                <label class="field-label">WIR REQUESTED</label>
                <div class="field-value">{{ formatIssueDate(wirCheckpoint.requestedDate) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Images Section (Full Width) -->
      <div class="content-section images-section" *ngIf="getQualityIssueImageUrls().length > 0">
        <div class="images-header">
          <h3 class="section-label">IMAGES</h3>
          <span class="images-count">({{ getQualityIssueImageUrls().length }})</span>
        </div>
        <div class="images-container">
          <div class="images-scroll" [class.has-many]="getQualityIssueImageUrls().length > 4">
            <div class="image-card" *ngFor="let imageUrl of getQualityIssueImageUrls(); let i = index" (click)="openLightbox(imageUrl, getQualityIssueImageUrls())">
              <div class="image-card-inner">
                <img [src]="imageUrl" 
                     [alt]="'Quality issue image ' + (i + 1)"
                     class="image-thumbnail"
                     (error)="onImageError($event)"
                     loading="lazy" />
                <div class="image-number-badge">{{ i + 1 }}</div>
                <div class="image-hover-overlay">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>
          <button class="view-all-images-btn" *ngIf="getQualityIssueImageUrls().length > 4" (click)="openLightbox(getQualityIssueImageUrls()[0], getQualityIssueImageUrls())">
            View All Images
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox Modal -->
<div class="lightbox-overlay" *ngIf="lightboxOpen" (click)="closeLightbox()">
  <div class="lightbox-container" (click)="$event.stopPropagation()">
    <button class="lightbox-close" (click)="closeLightbox()" aria-label="Close lightbox">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <button class="lightbox-nav lightbox-prev" *ngIf="lightboxImages.length > 1" (click)="previousImage()" aria-label="Previous image">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
    <img [src]="getCurrentLightboxImage()" 
         [alt]="'Quality issue image ' + (lightboxImageIndex + 1)"
         class="lightbox-image"
         (error)="onImageError($event)" />
    <button class="lightbox-nav lightbox-next" *ngIf="lightboxImages.length > 1" (click)="nextImage()" aria-label="Next image">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </button>
    <div class="lightbox-counter" *ngIf="lightboxImages.length > 1">
      {{ lightboxImageIndex + 1 }} / {{ lightboxImages.length }}
    </div>
  </div>
</div>

