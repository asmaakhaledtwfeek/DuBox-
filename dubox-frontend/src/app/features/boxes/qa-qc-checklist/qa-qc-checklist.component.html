<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn-back" (click)="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Back to Box Details
        </button>
        <h1 class="page-title">QA/QC Activity Approval Checklist</h1>
        <p class="page-subtitle" *ngIf="wirRecord">{{ wirRecord.wirCode }} - {{ wirRecord.activityName }}</p>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading checklist...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadWIRRecord()">Retry</button>
    </div>

    <!-- Step 1: Create WIR Checkpoint -->
    <div *ngIf="currentStep === 'create-checkpoint' && wirRecord && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 1: Create WIR Checkpoint</h2>
        <p class="step-description">Create a new WIR checkpoint for this activity</p>
      </div>

      <form [formGroup]="createCheckpointForm" (ngSubmit)="onCreateCheckpoint()">
        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>

          <!-- Auto-filled information (read-only) -->
          <div class="info-section" *ngIf="wirRecord">
            <h3 class="info-section-title">Checkpoint Information</h3>
            <div class="info-grid-readonly">
              <div class="info-item">
                <span class="label">WIR Number</span>
                <span class="value">{{ wirRecord.wirCode }}</span>
              </div>
              <div class="info-item">
                <span class="label">Box Activity ID</span>
                <span class="value">{{ activityId }}</span>
              </div>
              <div class="info-item">
                <span class="label">Activity Name</span>
                <span class="value">{{ wirRecord.activityName }}</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="wirName">WIR Name</label>
            <input 
              id="wirName" 
              type="text" 
              formControlName="wirName" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched"
              placeholder="e.g., Release from Assembly - WIR-1"
            >
            <div *ngIf="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched" class="error-text">
              WIR Name max 200 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="wirDescription">WIR Description</label>
            <textarea 
              id="wirDescription" 
              formControlName="wirDescription" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched"
              rows="3"
              placeholder="Description of the WIR checkpoint"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched" class="error-text">
              WIR Description max 500 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="attachmentPath">Attachment Path</label>
            <input 
              id="attachmentPath" 
              type="text" 
              formControlName="attachmentPath" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('attachmentPath')?.invalid && createCheckpointForm.get('attachmentPath')?.touched"
              placeholder="e.g., /attachments/wir-1-drawing.pdf"
            >
            <div *ngIf="createCheckpointForm.get('attachmentPath')?.invalid && createCheckpointForm.get('attachmentPath')?.touched" class="error-text">
              Attachment Path max 500 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="comments">Comments</label>
            <textarea 
              id="comments" 
              formControlName="comments" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched"
              rows="3"
              placeholder="Additional comments"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched" class="error-text">
              Comments max 1000 characters.
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="creatingCheckpoint || createCheckpointForm.invalid">
              <span *ngIf="creatingCheckpoint">Creating...</span>
              <span *ngIf="!creatingCheckpoint">Create Checkpoint</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 2: Add Checklist Items -->
    <div *ngIf="currentStep === 'add-items' && wirCheckpoint && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 2: Add Checklist Items</h2>
        <p class="step-description">Add checklist items to the WIR checkpoint</p>
      </div>

      <form [formGroup]="addChecklistItemsForm" (ngSubmit)="onAddChecklistItems()">
        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>

          <div class="checklist-items-container">
            <div *ngFor="let item of addChecklistItemsArray.controls; let i = index" [formGroupName]="i" class="checklist-item-form">
              <div class="item-header">
                <span class="item-sequence">Item {{ i + 1 }}</span>
              </div>
              
              <div class="form-group">
                <label>Checkpoint Description <span class="required">*</span></label>
                <textarea 
                  formControlName="checkpointDescription" 
                  class="form-control"
                  [class.invalid]="item.get('checkpointDescription')?.invalid && item.get('checkpointDescription')?.touched"
                  rows="2"
                  placeholder="Enter checkpoint description"
                ></textarea>
                <div *ngIf="item.get('checkpointDescription')?.invalid && item.get('checkpointDescription')?.touched" class="error-text">
                  Checkpoint description is required.
                </div>
              </div>

              <div class="form-group">
                <label>Reference Document</label>
                <input 
                  type="text" 
                  formControlName="referenceDocument" 
                  class="form-control"
                  placeholder="e.g., Drawing No., Specification"
                >
              </div>

              <div class="form-group">
                <label>Sequence <span class="required">*</span></label>
                <input 
                  type="number" 
                  formControlName="sequence" 
                  class="form-control"
                  [class.invalid]="item.get('sequence')?.invalid && item.get('sequence')?.touched"
                  min="1"
                >
                <div *ngIf="item.get('sequence')?.invalid && item.get('sequence')?.touched" class="error-text">
                  Sequence is required.
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="addingChecklistItems || addChecklistItemsForm.invalid">
              <span *ngIf="addingChecklistItems">Adding Items...</span>
              <span *ngIf="!addingChecklistItems">Add Checklist Items</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 3: Review Checklist -->
    <form [formGroup]="checklistForm" *ngIf="currentStep === 'review' && wirCheckpoint && !loading && !error">
      <!-- WIR Information Card -->
      <div class="info-card">
        <h2 class="card-title">Inspection Request Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">WIR Code</span>
            <span class="value">{{ wirRecord?.wirCode || '-' }}</span>
          </div>
          <div class="info-item" *ngIf="wirCheckpoint">
            <span class="label">WIR Checkpoint ID</span>
            <span class="value">{{ wirCheckpoint.wirId }}</span>
          </div>
          <div class="info-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Activity</span>
            <span class="value">{{ wirRecord?.activityName || '-' }}</span>
          </div>
          <div class="info-item" *ngIf="wirCheckpoint">
            <span class="label">Checkpoint Status</span>
            <span class="value badge" [class.pending]="wirCheckpoint.status === 'Pending'" 
                  [class.approved]="wirCheckpoint.status === 'Approved'" 
                  [class.rejected]="wirCheckpoint.status === 'Rejected'">
              {{ wirCheckpoint.status }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Status</span>
            <span class="badge" [class.badge-warning]="wirRecord?.status === 'Pending'" [class.badge-success]="wirRecord?.status === 'Approved'" [class.badge-danger]="wirRecord?.status === 'Rejected'">
              {{ wirRecord?.status || '-' }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Requested Date</span>
            <span class="value">{{ wirRecord?.requestedDate ? (wirRecord?.requestedDate | date:'MMM d, yyyy h:mm a') : '-' }}</span>
          </div>
        </div>
      </div>

      <!-- Checklist Items -->
      <div class="checklist-card">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          Checkpoint Validation
        </h2>
        
        <div class="checklist-table-wrapper">
          <table class="checklist-table">
            <thead>
              <tr>
                <th style="width: 50px;">#</th>
                <th>Checkpoint Description</th>
                <th style="width: 200px;">Reference Document</th>
                <th style="width: 180px;">Status</th>
                <th style="width: 250px;">Remarks</th>
              </tr>
            </thead>
            <tbody formArrayName="checklistItems">
              <tr *ngFor="let item of checklistItems.controls; let i = index" [formGroupName]="i">
                <td class="text-center">{{ i + 1 }}</td>
                <td class="checkpoint-desc">
                  {{ item.value.checkpointDescription }}
                </td>
                <td class="reference-doc">
                  <span class="doc-badge">{{ item.value.referenceDocument }}</span>
                </td>
                <td class="status-buttons">
                  <button 
                    type="button" 
                    class="status-btn"
                    [class.active]="item.value.status === CheckpointStatus.Pass"
                    [class.btn-pass]="item.value.status === CheckpointStatus.Pass"
                    (click)="onCheckpointStatusChange(i, CheckpointStatus.Pass)"
                  >
                    ✓ Pass
                  </button>
                  <button 
                    type="button" 
                    class="status-btn"
                    [class.active]="item.value.status === CheckpointStatus.Fail"
                    [class.btn-fail]="item.value.status === CheckpointStatus.Fail"
                    (click)="onCheckpointStatusChange(i, CheckpointStatus.Fail)"
                  >
                    ✗ Fail
                  </button>
                  <button 
                    type="button" 
                    class="status-btn"
                    [class.active]="item.value.status === CheckpointStatus.NA"
                    [class.btn-na]="item.value.status === CheckpointStatus.NA"
                    (click)="onCheckpointStatusChange(i, CheckpointStatus.NA)"
                  >
                    N/A
                  </button>
                </td>
                <td>
                  <input 
                    type="text" 
                    formControlName="remarks"
                    class="form-control form-control-sm"
                    placeholder="Add remarks..."
                    [class.required]="item.value.status === CheckpointStatus.Fail"
                  />
                  <span class="error-text" *ngIf="item.value.status === CheckpointStatus.Fail && !item.value.remarks">
                    Required for failed items
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Inspection Notes -->
      <div class="notes-card">
        <h2 class="card-title">Inspector Notes</h2>
        <textarea 
          formControlName="inspectionNotes"
          class="form-control"
          rows="4"
          placeholder="Add general inspection notes, observations, or recommendations..."
        ></textarea>
        <small class="form-text">{{ checklistForm.value.inspectionNotes?.length || 0 }}/1000 characters</small>
      </div>

      <!-- Photo Upload -->
      <div class="photos-card">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          Inspection Photos
        </h2>
        
        <div class="photo-upload-zone">
          <input 
            type="file" 
            id="photoInput"
            accept="image/*"
            multiple
            (change)="onPhotosSelected($event)"
            style="display: none;"
          />
          <label for="photoInput" class="upload-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <p>Click to upload inspection photos</p>
            <small>JPG, PNG (Max 5MB each)</small>
          </label>
        </div>

        <div class="photo-preview-grid" *ngIf="photoPreviewUrls.length > 0">
          <div class="photo-preview" *ngFor="let url of photoPreviewUrls; let i = index">
            <img [src]="url" alt="Inspection photo">
            <button type="button" class="remove-photo" (click)="removePhoto(i)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Signature Pad -->
      <div class="signature-card">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19l7-7 3 3-7 7-3-3z"/>
            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
            <path d="M2 2l7.586 7.586"/>
            <circle cx="11" cy="11" r="2"/>
          </svg>
          Inspector Signature <span class="required-badge">*Required</span>
        </h2>
        
        <div class="signature-pad-container">
          <canvas 
            id="signatureCanvas"
            width="600"
            height="200"
            (mousedown)="startDrawing($event)"
            (mousemove)="draw($event)"
            (mouseup)="stopDrawing()"
            (mouseleave)="stopDrawing()"
            (touchstart)="startDrawing($event)"
            (touchmove)="draw($event)"
            (touchend)="stopDrawing()"
          ></canvas>
          <button type="button" class="btn-clear-signature" (click)="clearSignature()">
            Clear Signature
          </button>
        </div>
        <small class="form-text">Please sign above to approve or reject this inspection</small>
        <span class="error-text" *ngIf="!checklistForm.value.signature">
          Signature is required
        </span>
      </div>

      <!-- Rejection Reason (shown when rejecting) -->
      <div class="rejection-card" *ngIf="hasFailedItems()">
        <h2 class="card-title error-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          Rejection Reason <span class="required-badge">*Required for rejection</span>
        </h2>
        <textarea 
          formControlName="rejectionReason"
          class="form-control"
          rows="3"
          placeholder="Provide detailed reason for rejection and required corrective actions..."
        ></textarea>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="goBack()"
          [disabled]="submitting"
        >
          Cancel
        </button>
        
        <button 
          type="button" 
          class="btn btn-danger"
          (click)="onReject()"
          [disabled]="!canReject() || submitting"
          *ngIf="hasFailedItems()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          {{ submitting ? 'Rejecting...' : 'Reject WIR' }}
        </button>

        <button 
          type="button" 
          class="btn btn-success"
          (click)="onApprove()"
          [disabled]="!canApprove() || submitting"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          {{ submitting ? 'Approving...' : 'Approve WIR' }}
        </button>
      </div>
    </form>
  </div>
</div>
