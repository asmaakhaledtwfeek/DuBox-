<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn-back" (click)="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          {{ fromContext === 'quality-control' ? 'Back to Quality Control' : 'Back to Box Details' }}
        </button>
        <h1 class="page-title" *ngIf="!qualityIssuesOnlyView">QA/QC Activity Approval Checklist</h1>
        <h1 class="page-title" *ngIf="qualityIssuesOnlyView">All Quality Issues</h1>
        <p class="page-subtitle" *ngIf="!qualityIssuesOnlyView && wirRecord">
          {{ wirRecord.wirCode }} - 
          <span *ngIf="wirRecord && wirRecord.activityNames && wirRecord.activityNames.length > 0">
            {{ wirRecord.activityCount }} {{ wirRecord.activityCount === 1 ? 'Activity' : 'Activities' }}
          </span>
          <span *ngIf="!wirRecord || !wirRecord.activityNames || wirRecord.activityNames.length === 0">
            {{ wirRecord?.activityName }}
          </span>
        </p>
        <p class="page-subtitle" *ngIf="qualityIssuesOnlyView">
          Box-wide quality issues across every Stage checkpoint.
        </p>
      </div>
    </div>

    <div class="quality-list-only" *ngIf="qualityIssuesOnlyView">
      <div class="form-card aggregate-card">
        <div class="designer-headline">
          <div>
            <h3>All Quality Issues</h3>
            <p>List of every quality issue logged for this box.</p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ boxQualityIssues.length }}</strong> issue(s)</span>
            <button 
              type="button" 
              class="btn btn-primary btn-sm" 
              (click)="exportQualityIssuesToExcel()"
              [disabled]="boxIssuesLoading || boxQualityIssues.length === 0"
              title="Export quality issues to Excel"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Export to Excel
            </button>
          </div>
        </div>

        <div class="aggregated-table-wrapper">
          <div class="quality-issues-loading" *ngIf="boxIssuesLoading">
            <div class="spinner small"></div>
            <p>Loading quality issues...</p>
          </div>
          <div class="quality-issues-error" *ngIf="!boxIssuesLoading && boxIssuesError">
            <p>{{ boxIssuesError }}</p>
          </div>
          <ng-container *ngIf="!boxIssuesLoading && !boxIssuesError">
            <table class="designer-table" *ngIf="boxQualityIssues.length > 0; else noBoxIssuesForBox">
              <thead>
                <tr>
                  <th class="col-seq">Seq</th>
                  <th class="col-extra">Issue Number</th>
                  <th class="col-extra">Issue Type</th>
                  <th class="col-extra">Severity</th>
                  <th class="col-extra">Assigned To</th>
                  <th class="col-extra">CC User</th>
                  <th class="col-extra">Due Date</th>
                  <th class="col-extra">Reported By</th>
                  <th class="col-extra">Issue Date</th>
                  <th class="col-extra">Status</th>
                  <th class="col-extra">Stage</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let issue of boxQualityIssues; let i = index">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>
                    <span *ngIf="issue.issueNumber" style="font-weight: 500; color: #3b82f6;">#{{ issue.issueNumber }}</span>
                    <span *ngIf="!issue.issueNumber">‚Äî</span>
                  </td>
                  <td>{{ issue.issueType || '‚Äî' }}</td>
                  <td>{{ issue.severity || '‚Äî' }}</td>
                  <td>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                      <span style="font-weight: 500;">{{ issue.assignedTeamName || issue.assignedTo || '‚Äî' }}</span>
                      <span *ngIf="issue.assignedToUserName" style="font-size: 12px; color: #64748b;">{{ issue.assignedToUserName }}</span>
                    </div>
                  </td>
                  <td>{{ issue.ccUserName || '‚Äî' }}</td>
                  <td>{{ formatDate(issue.dueDate) }}</td>
                  <td>{{ issue.reportedBy || '‚Äî' }}</td>
                  <td>{{ formatDate(issue.issueDate) }}</td>
                  <td>{{ issue.status || 'Open' }}</td>
                  <td>{{ issue.wirNumber || issue.wirName || '‚Äî' }}</td>
                </tr>
              </tbody>
            </table>
            <ng-template #noBoxIssuesForBox>
              <div class="empty-checklist">
                <p>No quality issues logged for this box.</p>
                <small>Issues will appear here once created.</small>
              </div>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>

    <div *ngIf="!qualityIssuesOnlyView">
    <div class="stepper" *ngIf="!loading">
      <button
        type="button"
        class="step"
        *ngFor="let step of stepMeta"
        [class.completed]="isStepCompleted(step.id)"
        [class.active]="isStepActive(step.id)"
        [class.disabled]="!canNavigateToStep(step.id)"
        [disabled]="!canNavigateToStep(step.id)"
        (click)="handleStepClick(step.id)"
        [title]="!canNavigateToStep(step.id) ? 'Please complete previous steps first' : ''"
      >
        <div class="step-index">{{ getStepNumber(step.id) }}</div>
        <div class="step-meta">
          <div class="step-title">{{ step.title }}</div>
          <div class="step-subtitle">{{ step.subtitle }}</div>
        </div>
      </button>
    </div>

    <div class="pending-action-banner" *ngIf="pendingActionLabel && showOverviewState">
      <div class="banner-text">
        <strong>Next step:</strong> {{ pendingActionLabel }}
      </div>
      <button class="btn btn-primary btn-sm" (click)="triggerPendingAction()">
        Continue
      </button>
    </div>

    <div class="checkpoint-overview" *ngIf="showOverviewState">
      <div class="info-card summary-card">
        <div class="summary-header">
          <div>
            <h2 class="card-title">Inspection Request</h2>
            <p class="card-subtitle">
              {{ wirRecord?.wirCode }} ‚Ä¢ 
              <span *ngIf="wirRecord && wirRecord.activityNames && wirRecord.activityNames.length > 0">
                {{ wirRecord.activityCount }} {{ wirRecord.activityCount === 1 ? 'Activity' : 'Activities' }}
              </span>
              <span *ngIf="!wirRecord || !wirRecord.activityNames || wirRecord.activityNames.length === 0">
                {{ wirRecord?.activityName }}
              </span>
            </p>
          </div>
          <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
            {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
          </span>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested Date</span>
            <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Inspector</span>
            <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <div class="checklist-card">
        <div class="overview-actions">
          <h3>Checklist Items</h3>
          <div class="action-buttons">
            <button 
              class="btn btn-secondary btn-sm" 
              (click)="startAddChecklistFlow()"
              [disabled]="isChecklistLocked"
              [title]="isChecklistLocked ? 'Checklist is locked after review' : null"
            >
              Add Checklist Item
            </button>
            <button class="btn btn-primary btn-sm" (click)="startReviewFlow()" [disabled]="!canStartReview">
              Review Checkpoint
            </button>
          </div>
        </div>

        <ng-container *ngIf="hasChecklistItems; else emptyChecklist">
          <div class="checklist-table-wrapper compact">
            <table class="checklist-table">
              <thead>
                <tr>
                  <th style="width: 50px;">#</th>
                  <th>Checkpoint Description</th>
                  <th style="width: 180px;">Last Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of displayChecklistItems; let i = index">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ item.checkpointDescription }}</td>
                  <td>
                    <span class="badge"
                      [class.badge-warning]="item.status === 'Pending'"
                      [class.badge-success]="item.status === 'Pass'"
                      [class.badge-danger]="item.status === 'Fail'">
                      {{ item.status || 'Pending' }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
        <ng-template #emptyChecklist>
          <div class="empty-checklist">
            <p>No checklist items yet.</p>
            <small>Add checklist items to move this checkpoint into review.</small>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading checklist...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !loading">
      <p class="error-message">{{ error }}</p>
      <button class="btn btn-primary" (click)="loadWIRRecord()">Retry</button>
    </div>

    <!-- Step 1: Create Stage Checkpoint -->
    <div *ngIf="currentStep === 'create-checkpoint' && wirRecord && (!wirCheckpoint || wirCheckpoint.status === 'Pending') && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 1: {{ wirCheckpoint ? 'Update' : 'Create' }} Stage Checkpoint</h2>
        <p class="step-description" *ngIf="!wirCheckpoint">Create a new Stage checkpoint for this activity</p>
        <p class="step-description" *ngIf="wirCheckpoint">Update Stage checkpoint information for this activity</p>
      </div>
      
      <form [formGroup]="createCheckpointForm" (ngSubmit)="onCreateCheckpoint()">
        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>

          <!-- Auto-filled information (read-only) -->
          <div class="info-section" *ngIf="wirRecord">
            <h3 class="info-section-title">Checkpoint Information</h3>
            <div class="info-grid-readonly">
              <div class="info-item">
                <span class="label">Box Tag</span>
                <span class="value">{{ wirRecord.boxTag }}</span>
              </div>
              <div class="info-item">
                <span class="label">Stage Number</span>
                <span class="value">{{ wirRecord.wirCode }}</span>
              </div>
              <div class="info-item" style="grid-column: span 3;">
                <span class="label">Activities Included</span>
                <span class="value" *ngIf="wirRecord && wirRecord.activityNames && wirRecord.activityNames.length > 0">
                  <strong>({{ wirRecord.activityCount }} {{ wirRecord.activityCount === 1 ? 'Activity' : 'Activities' }})</strong><br/>
                  <span style="display: block; margin-top: 4px;">{{ wirRecord.activityNames.join(', ') }}</span>
                </span>
                <span class="value" *ngIf="!wirRecord || !wirRecord.activityNames || wirRecord.activityNames.length === 0">
                  {{ wirRecord?.activityName || 'Loading...' }}
                </span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="wirName">Stage Name</label>
            <input 
              id="wirName" 
              type="text" 
              formControlName="wirName" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched"
              placeholder="e.g., Release from Assembly - Stage-1"
            >
            <div *ngIf="createCheckpointForm.get('wirName')?.invalid && createCheckpointForm.get('wirName')?.touched" class="error-text">
              Stage Name max 200 characters.
            </div>
          </div>

          <div class="form-group">
            <label for="wirDescription">Stage Description</label>
            <textarea 
              id="wirDescription" 
              formControlName="wirDescription" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched"
              rows="3"
              placeholder="Description of the Stage checkpoint"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('wirDescription')?.invalid && createCheckpointForm.get('wirDescription')?.touched" class="error-text">
              Stage Description max 500 characters.
            </div>
          </div>

          <!-- Attachment/Image Upload Section -->
          <div class="form-group">
            <label>Attachment <span class="image-count-badge" *ngIf="attachmentImages.length > 0">{{ attachmentImages.length }}</span></label>
            <p class="photo-upload-hint">Add images from upload, camera, or URL</p>
            
            <!-- Selected Images Preview List -->
            <div class="selected-images-list" *ngIf="attachmentImages.length > 0">
              <div class="image-preview-item" *ngFor="let image of attachmentImages; let i = index">
                <div class="image-preview-wrapper">
                  <img [src]="image.preview || image.url" [alt]="image.name || 'Image preview'" />
                  <button 
                    type="button" 
                    class="remove-image-btn" 
                    (click)="removeAttachmentImage(i)"
                    [disabled]="creatingCheckpoint"
                    title="Remove image"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                  <div class="image-type-badge" [class.type-file]="image.type === 'file' || image.type === 'camera'" [class.type-url]="image.type === 'url'">
                    {{ image.type === 'file' || image.type === 'camera' ? 'File' : 'URL' }}
                  </div>
                </div>
                <div class="image-info" *ngIf="image.name || image.url">
                  <p class="image-name" *ngIf="image.name">{{ image.name }}</p>
                  <p class="image-url" *ngIf="image.url">{{ image.url }}</p>
                  <p class="image-size" *ngIf="image.file">{{ (image.file.size / 1024).toFixed(1) }} KB</p>
                </div>
              </div>
              <button 
                type="button" 
                class="btn-clear-all" 
                (click)="clearAllAttachmentImages()" 
                [disabled]="creatingCheckpoint"
                *ngIf="attachmentImages.length > 1"
              >
                Clear All
              </button>
            </div>
            
            <!-- Tabs for different input methods -->
            <div class="photo-input-tabs" *ngIf="!showAttachmentCamera">
              <button 
                type="button"
                class="tab-button"
                [class.active]="attachmentInputMethod === 'url'"
                (click)="attachmentInputMethod = 'url'; showAttachmentCamera = false"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                URL
              </button>
              <button 
                type="button"
                class="tab-button"
                [class.active]="attachmentInputMethod === 'upload'"
                (click)="openAttachmentFileInput(); attachmentInputMethod = 'upload'"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Upload
              </button>
              <button 
                type="button"
                class="tab-button"
                [class.active]="attachmentInputMethod === 'camera'"
                (click)="openAttachmentCamera()"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                  <circle cx="12" cy="13" r="4"/>
                </svg>
                Camera
              </button>
            </div>

            <!-- URL Input -->
            <div *ngIf="attachmentInputMethod === 'url' && !showAttachmentCamera" class="photo-input-content">
              <div class="url-input-group">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Enter image URL (e.g., https://example.com/photo.jpg)"
                  [(ngModel)]="attachmentPhotoUrl"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="creatingCheckpoint"
                  (keydown.enter)="addAttachmentImageUrl(attachmentPhotoUrl); $event.preventDefault()"
                />
                <button 
                  type="button" 
                  class="btn-add-url" 
                  (click)="addAttachmentImageUrl(attachmentPhotoUrl)"
                  [disabled]="creatingCheckpoint || !attachmentPhotoUrl?.trim()"
                >
                  Add URL
                </button>
              </div>
            </div>

            <!-- File Upload Input (hidden, supports multiple) -->
            <input
              id="checkpoint-attachment-file-input"
              type="file"
              accept="image/*"
              multiple
              style="display: none"
              (change)="onAttachmentFileSelected($event)"
              [disabled]="creatingCheckpoint"
            />

            <!-- Camera Preview -->
            <div *ngIf="showAttachmentCamera" id="checkpoint-attachment-camera-container" class="camera-preview-container">
              <video 
                id="checkpoint-attachment-camera-preview" 
                autoplay 
                playsinline 
                muted
                style="display: block; visibility: visible; opacity: 1;"
              ></video>
              <div class="camera-controls">
                <button type="button" class="btn btn-secondary btn-sm" (click)="stopAttachmentCamera()">
                  Cancel
                </button>
                <button type="button" class="btn btn-primary btn-sm" (click)="captureAttachmentPhoto()" [disabled]="creatingCheckpoint">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                  Capture
                </button>
              </div>
            </div>

            <!-- Errors -->
            <p class="form-text text-danger" *ngIf="attachmentUploadError">{{ attachmentUploadError }}</p>
          </div>

          <div class="form-group">
            <label for="comments">Comments</label>
            <textarea 
              id="comments" 
              formControlName="comments" 
              class="form-control"
              [class.invalid]="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched"
              rows="3"
              placeholder="Additional comments"
            ></textarea>
            <div *ngIf="createCheckpointForm.get('comments')?.invalid && createCheckpointForm.get('comments')?.touched" class="error-text">
              Comments max 1000 characters.
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="creatingCheckpoint || createCheckpointForm.invalid">
              <span *ngIf="creatingCheckpoint">{{ wirCheckpoint ? 'Updating...' : 'Creating...' }}</span>
              <span *ngIf="!creatingCheckpoint">{{ wirCheckpoint ? 'Update Checkpoint' : 'Create Checkpoint' }}</span>
            </button>
            
          </div>
        </div>
      </form>
    </div>

    <!-- Step 2: Add Checklist Items -->
    <div *ngIf="currentStep === 'add-items' && wirCheckpoint && !loading && !error" class="step-container">
      <div class="step-header">
        <h2>Step 2: Add Checklist Items</h2>
        <p class="step-description">Add checklist items to the Stage checkpoint</p>
      </div>

      <div class="info-card summary-card">
        <div class="summary-header">
          <div>
            <h2 class="card-title">Inspection Request</h2>
            <p class="card-subtitle">
              {{ wirRecord?.wirCode }} ‚Ä¢ 
              <span *ngIf="wirRecord && wirRecord.activityNames && wirRecord.activityNames.length > 0">
                {{ wirRecord.activityCount }} {{ wirRecord.activityCount === 1 ? 'Activity' : 'Activities' }}
              </span>
              <span *ngIf="!wirRecord || !wirRecord.activityNames || wirRecord.activityNames.length === 0">
                {{ wirRecord?.activityName }}
              </span>
            </p>
          </div>
          <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
            {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
          </span>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Requested Date</span>
            <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Inspector</span>
            <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <form [formGroup]="addChecklistItemsForm" (ngSubmit)="onAddChecklistItems()" class="checklist-designer">
        <div class="designer-headline">
          <div>
            <h3>Checklist Designer</h3>
            <p *ngIf="selectedPredefinedItemIds.length === 0">Create or edit inspection checkpoints for this Stage.</p>
            <p *ngIf="selectedPredefinedItemIds.length > 0" class="preview-message">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              Previewing {{ selectedPredefinedItemIds.length }} selected item(s). Review and click "Save Selected Items" to add them.
            </p>
          </div>
          <div class="designer-meta">
            <span><strong>{{ wirCheckpoint?.checklistItems?.length || 0 }}</strong> existing item(s)</span>
            <button 
              type="button" 
              class="btn btn-secondary btn-sm" 
              (click)="openAddPredefinedItemsModal()"
              [disabled]="isChecklistLocked || loadingPredefinedItems"
              [title]="isChecklistLocked ? 'Checklist is locked after review' : null"
            >
              + Add Predefined Items
            </button>
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              (click)="handleStepClick('review')"
              [disabled]="!canNavigateToStep('review')"
            >
              Review
            </button>
          </div>
        </div>

        <div class="form-card">
          <div *ngIf="error" class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ error }}</span>
          </div>
          <div class="checklist-table-wrapper" formArrayName="checklistItems">
            <div *ngIf="addChecklistItemsArray.length > 0; else noChecklistPlaceholder" class="grouped-checklist-table">
              <ng-container *ngFor="let group of getGroupedChecklistItems()">
                <div class="checklist-category-group" *ngIf="group.sections.length > 0">
                  <div class="category-header">
                    <h4 class="category-title">{{ group.checklistName }}</h4>
                    <span class="category-count">
                      {{ getTotalItemsCount(group.sections) }} item(s)
                    </span>
                  </div>
                  
                  <!-- Sections within Category -->
                  <ng-container *ngFor="let section of group.sections">
                    <div class="section-subgroup" *ngIf="section.items.length > 0">
                      <div class="section-subheader">
                        <div class="section-header-left">
                          <button 
                            type="button" 
                            class="btn-collapse" 
                            (click)="toggleSectionCollapse(section.sectionName)"
                            [class.collapsed]="isSectionCollapsed(section.sectionName)"
                            title="{{ isSectionCollapsed(section.sectionName) ? 'Expand section' : 'Collapse section' }}"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <polyline points="6 9 12 15 18 9"/>
                            </svg>
                          </button>
                          <h5 class="section-subtitle">{{ section.sectionName }}</h5>
                          <span class="section-subcount">{{ section.items.length }} item(s)</span>
                        </div>
                        <button 
                          type="button" 
                          class="btn-delete-section" 
                          (click)="confirmRemoveSection(section)"
                          title="Delete entire section"
                          [disabled]="isChecklistLocked"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          </svg>
                          Delete Section
                        </button>
                      </div>
                      <table class="designer-table" *ngIf="!isSectionCollapsed(section.sectionName)">
                        <thead>
                          <tr>
                            <th style="width: 60px; text-align: center;">Seq</th>
                            <th>Checkpoint Description</th>
                            <th style="width: 80px; text-align: center;">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let itemData of section.items; let i = index" [formGroupName]="itemData.index">
                            <td class="text-center">{{ i + 1 }}</td>
                            <td>{{ itemData.control.get('checkpointDescription')?.value }}</td>
                            <td class="text-center actions-cell">
                              <button 
                                type="button" 
                                class="icon-button" 
                                (click)="confirmRemoveChecklistItem(itemData.index)"
                                title="Delete item"
                              >
                                üóëÔ∏è
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
            </div>
            <ng-template #noChecklistPlaceholder>
              <div class="empty-checklist">
                <p>No checklist items added yet.</p>
                <small>Click "Add Predefined Items" to select from the predefined checklist.</small>
              </div>
            </ng-template>
          </div>

          <div class="form-actions sticky-actions">
            <button type="button" class="btn btn-secondary" (click)="closeWorkflowStep()">Close</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 3: Review Checklist -->
    <form [formGroup]="checklistForm" *ngIf="currentStep === 'review' && wirCheckpoint && !loading && !error" class="review-form">
      <div class="review-layout">
        <div class="review-main">
      <!-- Stage Information Card -->
          <div class="info-card summary-card">
            <div class="summary-header">
              <div>
                <h2 class="card-title">Inspection Request</h2>
                <p class="card-subtitle">
              {{ wirRecord?.wirCode }} ‚Ä¢ 
              <span *ngIf="wirRecord && wirRecord.activityNames && wirRecord.activityNames.length > 0">
                {{ wirRecord.activityCount }} {{ wirRecord.activityCount === 1 ? 'Activity' : 'Activities' }}
              </span>
              <span *ngIf="!wirRecord || !wirRecord.activityNames || wirRecord.activityNames.length === 0">
                {{ wirRecord?.activityName }}
              </span>
            </p>
          </div>
              <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
                {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
              </span>
          </div>
            <div class="summary-grid">
              <div class="summary-item">
            <span class="label">Box Tag</span>
            <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
          </div>
              <div class="summary-item">
            <span class="label">Requested By</span>
            <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
          </div>
              <div class="summary-item">
            <span class="label">Requested Date</span>
                <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Inspector</span>
                <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
          </div>
        </div>
      </div>

      <!-- Inspector Notes and Photos -->
      <div class="notes-photos-layout">
        <!-- Photo Upload -->
        <!-- Existing Images Section -->
        <div class="photos-card existing-images-card" *ngIf="getCheckpointImageUrls().length > 0">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            Existing Inspection Photos
            <span class="image-count-badge">{{ getCheckpointImageUrls().length }}</span>
          </h2>
          
          <div class="existing-images-grid">
            <div class="existing-image-item" *ngFor="let imageUrl of getCheckpointImageUrls(); let i = index">
              <div class="existing-image-wrapper" (click)="openCheckpointImageInNewTab(imageUrl)">
                <img 
                  [src]="imageUrl" 
                  [alt]="'Inspection photo ' + (i + 1)"
                  class="existing-image-thumbnail"
                  (error)="onCheckpointImageError($event)"
                  loading="lazy"
                />
                <div class="existing-image-overlay">
                  <div class="overlay-actions">
                    <button class="overlay-btn view-btn" (click)="openCheckpointImageInNewTab(imageUrl); $event.stopPropagation()" title="View full size">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                    </button>
                    <button class="overlay-btn download-btn" (click)="downloadCheckpointImage(imageUrl); $event.stopPropagation()" title="Download image">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="existing-image-number">{{ i + 1 }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="photos-card">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            Inspection Photos
            <span class="image-count-badge" *ngIf="selectedImages.length > 0">{{ selectedImages.length }}</span>
          </h2>
          
          <p class="photo-upload-hint">Upload multiple images, enter URLs, or use your camera</p>
          
          <!-- Selected Images Preview List -->
          <div class="selected-images-list" *ngIf="selectedImages.length > 0">
            <div class="image-preview-item" *ngFor="let image of selectedImages; let i = index">
              <div class="image-preview-wrapper">
                <img [src]="image.preview || image.url" [alt]="image.name || 'Image preview'" />
                <button 
                  type="button" 
                  class="remove-image-btn" 
                  (click)="removeImage(image.id)" 
                  [disabled]="isUploadingPhoto || submitting"
                  title="Remove image"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
                <div class="image-type-badge" [class.type-file]="image.type === 'file' || image.type === 'camera'" [class.type-url]="image.type === 'url'">
                  {{ image.type === 'file' || image.type === 'camera' ? 'File' : 'URL' }}
                </div>
              </div>
              <div class="image-info" *ngIf="image.name || image.url">
                <p class="image-name" *ngIf="image.name">{{ image.name }}</p>
                <p class="image-url" *ngIf="image.url">{{ image.url }}</p>
                <p class="image-size" *ngIf="image.file">{{ (image.file.size / 1024).toFixed(1) }} KB</p>
              </div>
            </div>
            <button 
              type="button" 
              class="btn-clear-all" 
              (click)="clearAllImages()" 
              [disabled]="isUploadingPhoto || submitting"
              *ngIf="selectedImages.length > 1"
            >
              Clear All
            </button>
          </div>
          
          <!-- Tabs for different input methods -->
          <div class="photo-input-tabs" *ngIf="!showCamera">
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'url'"
              (click)="photoInputMethod = 'url'; showCamera = false"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
              </svg>
              URL
            </button>
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'upload'"
              (click)="openFileInput(); photoInputMethod = 'upload'"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Upload
            </button>
            <button 
              type="button"
              class="tab-button"
              [class.active]="photoInputMethod === 'camera'"
              (click)="openCamera()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
              Camera
            </button>
          </div>

          <!-- URL Input -->
          <div *ngIf="photoInputMethod === 'url' && !showCamera" class="photo-input-content">
            <div class="url-input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Enter photo URL (e.g., https://example.com/photo.jpg)"
                [(ngModel)]="currentUrlInput"
                [ngModelOptions]="{standalone: true}"
                [disabled]="isUploadingPhoto || submitting"
                (keydown.enter)="addImageFromUrl(); $event.preventDefault()"
              />
              <button 
                type="button" 
                class="btn-add-url" 
                (click)="addImageFromUrl()"
                [disabled]="isUploadingPhoto || submitting || !currentUrlInput?.trim()"
              >
                Add URL
              </button>
            </div>
          </div>

          <!-- File Upload Input (hidden, supports multiple) -->
          <input
            id="wir-photo-file-input"
            type="file"
            accept="image/*"
            multiple
            style="display: none"
            (change)="onPhotosSelected($event)"
            [disabled]="isUploadingPhoto || submitting"
          />

          <!-- Camera Preview -->
          <div *ngIf="showCamera" id="camera-preview-container" class="camera-preview-container">
            <video 
              id="wir-camera-preview" 
              autoplay 
              playsinline 
              muted
              style="display: block; visibility: visible; opacity: 1;"
            ></video>
            <div class="camera-controls">
              <button type="button" class="btn btn-secondary btn-sm" (click)="stopCamera()">
                Cancel
              </button>
              <button type="button" class="btn btn-primary btn-sm" (click)="capturePhoto()" [disabled]="submitting">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                Capture
              </button>
            </div>
          </div>

          <!-- Upload Progress -->
          <div *ngIf="isUploadingPhoto" class="upload-progress">
            <div class="spinner-small"></div>
            <span>Uploading photos...</span>
          </div>

          <!-- Errors -->
          <p class="form-text text-danger" *ngIf="photoUploadError">{{ photoUploadError }}</p>
          <small class="form-text" *ngIf="!photoUploadError && selectedImages.length === 0">JPG, PNG (Max 5MB each)</small>
        </div>
      </div>

      <!-- Checklist Items -->
      <div class="checklist-card">
        <div class="validation-header">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            Checklist Validation
          </h2>
          <div class="validation-actions">
            <button 
              type="button" 
              class="btn btn-success btn-sm"
              (click)="passAllItems()"
              [disabled]="checklistItems.length === 0"
              title="Mark all checklist items as PASS and save to database"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Approve All ({{ checklistItems.length }})
            </button>
            <button 
              type="button" 
              class="btn btn-danger btn-sm"
              (click)="rejectAllItems()"
              [disabled]="checklistItems.length === 0"
              title="Mark all checklist items as FAIL with reason and save to database"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
              Reject All ({{ checklistItems.length }})
            </button>
          </div>
        </div>
        
        <div class="checklist-table-wrapper" formArrayName="checklistItems">
          <div *ngIf="checklistItems.length > 0; else noChecklistItems" class="grouped-checklist-table">
            <ng-container *ngFor="let group of getGroupedReviewChecklistItems()">
              <div class="checklist-category-group" *ngIf="group.sections.length > 0">
                <div class="category-header">
                  <h4 class="category-title">
                    {{ group.checklistName }}
                    <span *ngIf="areAllItemsPassInGroup(group.sections)" class="auto-approved-badge">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                      </svg>
                      APPROVED
                    </span>
                  </h4>
                  <span class="category-count">
                    {{ getTotalItemsCount(group.sections) }} item(s)
                  </span>
                </div>
                
                <!-- Sections within Checklist -->
                <ng-container *ngFor="let section of group.sections">
                  <div class="section-subgroup" *ngIf="section.items.length > 0">
                    <div class="section-subheader">
                      <button 
                        type="button" 
                        class="btn-collapse" 
                        (click)="toggleSectionCollapse(section.sectionName)"
                        [class.collapsed]="isSectionCollapsed(section.sectionName)"
                        title="{{ isSectionCollapsed(section.sectionName) ? 'Expand section' : 'Collapse section' }}"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="6 9 12 15 18 9"/>
                        </svg>
                      </button>
                      <h5 class="section-subtitle">{{ section.sectionName }}</h5>
                      <span class="section-subcount">{{ section.items.length }} item(s)</span>
                    </div>
                    <table class="checklist-table" *ngIf="!isSectionCollapsed(section.sectionName)">
                      <thead>
                        <tr>
                          <th style="width: 60px; text-align: center;">Seq</th>
                          <th>Checkpoint Description</th>
                          <th style="width: 150px; text-align: center;">Status</th>
                          <th style="width: 120px; text-align: center;">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let itemData of section.items; let i = index" [formGroupName]="itemData.index">
                          <td class="text-center">{{ i + 1 }}</td>
                          <td class="checkpoint-desc">
                            <div class="checkpoint-description-text">
                              {{ itemData.control.get('checkpointDescription')?.value || '‚Äî' }}
                            </div>
                          </td>
                          <td class="status-display text-center">
                            <span class="status-badge" [ngClass]="getStatusBadgeClass(itemData.control.value.status)">
                              {{ getStatusLabel(itemData.control.value.status) }}
                            </span>
                          </td>
                          <td class="text-center actions-cell">
                            <button 
                              type="button" 
                              class="btn btn-primary btn-sm btn-review" 
                              (click)="openItemReviewModal(itemData.index)"
                              [disabled]="false"
                              [title]="getReviewButtonTitle(itemData.control.value.status, isChecklistLocked)"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                              </svg>
                              Review
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </ng-container>
              </div>
            </ng-container>
          </div>
          <ng-template #noChecklistItems>
            <div class="empty-checklist">
              <p>No checklist items available.</p>
              <small>Please add checklist items first.</small>
            </div>
          </ng-template>
        </div>
      </div>
      </div>

        <aside class="review-side">
          <div class="status-overview-card">
            <h3>Status Overview</h3>
            <ul class="status-timeline">
              <li>
                <span class="label">Requested</span>
                <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
              </li>
              <li>
                <span class="label">Inspection</span>
                <span class="value">{{ formatDateTime(wirCheckpoint!.inspectionDate) }}</span>
              </li>
              <li>
                <span class="label">Approval</span>
                <span class="value">{{ formatDateTime(wirCheckpoint!.approvalDate) }}</span>
              </li>
            </ul>
      </div>
          <!-- Inspection Notes -->
          <div class="notes-card">
            <h2 class="card-title">Inspector Notes</h2>
            <div class="notes-inputs-grid">
              <div class="form-group">
                <label for="inspectorRoleInput">Inspector Role</label>
                <input
                  id="inspectorRoleInput"
                  type="text"
                  formControlName="inspectorRole"
                  class="form-control"
                  maxlength="100"
                  placeholder="e.g., QC Engineer - MEP"
                >
                <small class="form-text text-muted">Optional, max 100 characters.</small>
              </div>
              <div class="form-group">
                <label for="inspectionNotesInput">Comments</label>
                <textarea 
                  id="inspectionNotesInput"
                  formControlName="inspectionNotes"
                  class="form-control"
                  rows="4"
                  placeholder="Add general inspection notes, observations, or recommendations..."
                ></textarea>
                <small class="form-text">{{ checklistForm.value.inspectionNotes?.length || 0 }}/1000 characters</small>
              </div>
            </div>
          </div>

         

          <!-- Rejection Reason -->
      <!-- Action Buttons -->
          <div class="decision-card side-card">
            <h3>Final Decision</h3>
            <div class="final-status-selector">
              <button 
                type="button" 
                class="status-chip-btn" 
                *ngFor="let option of availableFinalStatusOptions"
                [class.active]="finalStatusControl.value === option.value"
                [disabled]="submitting"
                (click)="onFinalStatusSelect(option.value)"
              >
                {{ option.label }}
              </button>
            </div>
            <p>Select a status and submit after completing the checklist.</p>
            <div class="action-buttons vertical">
        <button 
          type="button" 
          class="btn btn-secondary"
                (click)="closeWorkflowStep()"
          [disabled]="submitting"
        >
                Close
        </button>
        
        <button 
          type="button" 
                class="btn btn-success"
                (click)="onSubmitReview()"
                [disabled]="!canSubmitReview() || submitting"
              >
                {{ submitting ? 'Submitting...' : 'Submit Decision' }}
              </button>
            </div>
          </div>
        </aside>
      </div>
    </form>

    <!-- Step 4: Quality Issues (Optional) -->
    <div *ngIf="currentStep === 'quality-issues' && wirCheckpoint && !loading && !error" class="step-container quality-issues-step">
      <div class="step-header">
        <h2>Step 4: Quality Issues (Optional)</h2>
        <p class="step-description">Log defects, non-conformances, or observations that need follow-up outside of the review workflow.</p>
      </div>

      <div class="quality-issues-summary">
        <div class="info-card summary-card">
          <div class="summary-header">
            <div>
              <h2 class="card-title">Inspection Request</h2>
              <p class="card-subtitle">
              {{ wirRecord?.wirCode }} ‚Ä¢ 
              <span *ngIf="wirRecord && wirRecord.activityNames && wirRecord.activityNames.length > 0">
                {{ wirRecord.activityCount }} {{ wirRecord.activityCount === 1 ? 'Activity' : 'Activities' }}
              </span>
              <span *ngIf="!wirRecord || !wirRecord.activityNames || wirRecord.activityNames.length === 0">
                {{ wirRecord?.activityName }}
              </span>
            </p>
            </div>
            <span class="status-chip" [ngClass]="getCheckpointStatusClass(wirCheckpoint!.status)">
              {{ getCheckpointStatusLabel(wirCheckpoint!.status) }}
            </span>
          </div>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="label">Box Tag</span>
              <span class="value">{{ wirRecord?.boxTag || '-' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Requested By</span>
              <span class="value">{{ wirRecord?.requestedByName || '-' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Requested Date</span>
              <span class="value">{{ formatDateTime(wirRecord?.requestedDate) }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Inspector</span>
              <span class="value">{{ wirCheckpoint!.inspectorName || 'Pending assignment' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="quality-issues-table-card" [formGroup]="qualityIssuesForm">
        <div class="quality-issues-header">
          <div class="header-content">
            <div class="header-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
            </div>
            <div class="header-text">
              <h3>Quality Issues</h3>
              <p>Track and manage inspection defects, non-conformances, and observations</p>
            </div>
          </div>
          <div class="header-actions">
            <div class="issues-count-badge">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <span class="count">{{ qualityIssuesArray.length }}</span>
              <span class="label">Issue{{ qualityIssuesArray.length !== 1 ? 's' : '' }}</span>
            </div>
            <button type="button" class="btn-add-quality-issue" (click)="openQualityIssueModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              <span>Add Quality Issue</span>
            </button>
          </div>
        </div>

        <div class="quality-issues-content">
          <div class="quality-issues-table-container" formArrayName="issues">
            <table class="modern-quality-table" *ngIf="qualityIssuesArray.length > 0; else noQualityIssues">
              <thead>
                <tr>
                  <th class="col-index">#</th>
                  <th class="col-issue-number">Issue Number</th>
                  <th class="col-type">Issue Type</th>
                  <th class="col-severity">Severity</th>
                  <th class="col-description">Description</th>
                  <th class="col-assigned">Assigned To</th>
                  <th class="col-cc-user">CC User</th>
                  <th class="col-due">Due Date</th>
                  <th class="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let issue of qualityIssuesArray.controls; let i = index" [formGroupName]="i" class="quality-issue-row">
                  <td class="col-index">
                    <span class="index-badge">{{ i + 1 }}</span>
                  </td>
                  <td class="col-issue-number">
                    <div  class="issue-number-badge">
                      <span>
                        #{{ getExistingQualityIssue(i)?.issueNumber }}
                      </span>
                      <ng-template #noIssueNumber>
                        <span class="no-data">‚Äî</span>
                      </ng-template>
                    </div>
                  </td>
                  <td class="col-type">
                    <div class="issue-type-cell">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                      </svg>
                      <span>{{ issue.get('issueType')?.value }}</span>
                    </div>
                  </td>
                  <td class="col-severity">
                    <span class="severity-tag" [ngClass]="'severity-' + (issue.get('severity')?.value?.toLowerCase() || 'minor')">
                      <span class="severity-dot"></span>
                      {{ issue.get('severity')?.value }}
                    </span>
                  </td>
                  <td class="col-description">
                    <div class="description-preview">
                      {{ issue.get('issueDescription')?.value || '‚Äî' }}
                    </div>
                  </td>
                  <td class="col-assigned">
                    <div class="assigned-cell" *ngIf="issue.get('assignedTeam')?.value || issue.get('assignedTo')?.value || getExistingQualityIssue(i)?.assignedTeam; else noAssignee">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                      </svg>
                      <span class="assigned-text">
                        {{ issue.get('assignedTeam')?.value || getExistingQualityIssue(i)?.assignedTeam || 'Unassigned' }}<span *ngIf="getExistingQualityIssue(i)?.assignedToUserName"> / {{ getExistingQualityIssue(i)?.assignedToUserName }}</span>
                      </span>
                    </div>
                    <ng-template #noAssignee>
                      <span class="no-data">Unassigned</span>
                    </ng-template>
                  </td>
                  <td class="col-cc-user">
                    <div class="cc-user-cell" *ngIf="getExistingQualityIssue(i)?.ccUserName; else noCCUser">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <path d="M20 8v6M23 11h-6"/>
                      </svg>
                      <span>{{ getExistingQualityIssue(i)?.ccUserName }}</span>
                    </div>
                    <ng-template #noCCUser>
                      <span class="no-data">‚Äî</span>
                    </ng-template>
                  </td>
                  <td class="col-due">
                    <div class="due-date-cell" *ngIf="issue.get('dueDate')?.value; else noDueDate">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      <span>{{ formatShortDate(issue.get('dueDate')?.value) }}</span>
                    </div>
                    <ng-template #noDueDate>
                      <span class="no-data">‚Äî</span>
                    </ng-template>
                  </td>
                  <td class="col-actions">
                    <div class="action-buttons-modern">
                      <button 
                        type="button" 
                        class="action-btn action-btn-view" 
                        (click)="viewQualityIssueDetails(i)"
                        title="View Details"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                          <circle cx="12" cy="12" r="3"/>
                        </svg>
                      </button>
                      <button 
                        type="button" 
                        class="action-btn action-btn-delete" 
                        (click)="removeQualityIssue(i)"
                        title="Delete Issue"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          <line x1="10" y1="11" x2="10" y2="17"/>
                          <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noQualityIssues>
              <div class="empty-quality-issues">
                <div class="empty-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                  </svg>
                </div>
                <h4>No Quality Issues Logged</h4>
                <p>Start by adding quality issues to track defects and observations</p>
                <button type="button" class="btn-empty-add" (click)="openQualityIssueModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Add Your First Issue
                </button>
              </div>
            </ng-template>
          </div>

          <div class="quality-issues-footer">
            <button type="button" class="btn btn-close-step" (click)="closeWorkflowStep()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Checklist Item Modal -->
<div class="modal-backdrop" *ngIf="isChecklistModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Add Checklist Item</h3>
      <button type="button" class="btn btn-secondary btn-sm" (click)="closeChecklistModal()">Close</button>
    </div>
    <form [formGroup]="newChecklistForm" (ngSubmit)="addChecklistItemFromModal()">
      <div class="form-group">
        <label>Description <span class="required">*</span></label>
        <textarea formControlName="checkpointDescription" class="form-control" rows="3" placeholder="Enter checkpoint description"></textarea>
      </div>
      <div class="form-group">
        <label>Reference Document</label>
        <input type="text" formControlName="referenceDocument" class="form-control" placeholder="e.g., Drawing No., Specification">
      </div>
      <small class="form-text">Sequence will auto-increment based on item order.</small>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">Add Item</button>
      </div>
    </form>
  </div>
</div>

<!-- Quality Issue Modal -->
<div class="modal-backdrop quality-issue-modal-backdrop" *ngIf="isQualityIssueModalOpen" (click)="closeQualityIssueModal()">
  <div class="modal-card quality-issue-modal" (click)="$event.stopPropagation()">
    <div class="modal-header quality-issue-modal-header">
      <div class="header-content">
        <div class="header-title-section">
          <h3 class="modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 12px;">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Add Quality Issue
          </h3>
          <p class="modal-subtitle">Log a new quality issue for this inspection checkpoint</p>
        </div>
      </div>
      <button type="button" class="icon-button" (click)="closeQualityIssueModal()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <form [formGroup]="newQualityIssueForm" (ngSubmit)="addQualityIssueFromModal()" class="quality-issue-form-content">
      <!-- Form-level error message -->
      <div class="form-error-alert" *ngIf="qualityIssueFormError" style="background-color: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-bottom: 20px; color: #991b1b; font-size: 14px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>{{ qualityIssueFormError }}</span>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          Description
          <span class="required">*</span>
        </label>
        <textarea 
          formControlName="issueDescription" 
          class="form-control form-textarea" 
          rows="4" 
          placeholder="Describe the quality issue in detail..."
          [class.error]="newQualityIssueForm.get('issueDescription')?.invalid && newQualityIssueForm.get('issueDescription')?.touched"
        ></textarea>
        <small class="form-hint" *ngIf="!newQualityIssueForm.get('issueDescription')?.invalid || !newQualityIssueForm.get('issueDescription')?.touched">
          Provide a clear and detailed description of the quality issue
        </small>
        <small class="form-error" *ngIf="newQualityIssueForm.get('issueDescription')?.invalid && newQualityIssueForm.get('issueDescription')?.touched">
          Description is required
        </small>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Severity
          </label>
          <select formControlName="severity" class="form-control form-select">
            <option *ngFor="let severity of severityLevels" [value]="severity">{{ severity }}</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            Issue Type
          </label>
          <select formControlName="issueType" class="form-control form-select">
            <option *ngFor="let type of issueTypes" [value]="type">{{ type }}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Assigned To Team
        </label>
        <select 
          formControlName="assignedTo" 
          class="form-control form-select"
          [disabled]="loadingTeams || savingQualityIssue"
          (change)="onQualityIssueTeamChange()"
        >
          <option [value]="''">Select Team (Optional)</option>
          <option *ngFor="let team of availableTeams" [value]="team.teamId">
            {{ team.teamName }} ({{ team.teamCode }})
          </option>
        </select>
        <div *ngIf="loadingTeams" class="loading-text" style="font-size: 12px; color: #64748b; margin-top: 4px;">
          Loading teams...
        </div>
        <small class="form-hint" *ngIf="!loadingTeams">Optional: Assign this issue to a team</small>
      </div>

      <div class="form-group" *ngIf="newQualityIssueForm.get('assignedTo')?.value">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Assigned To User
        </label>
        <select 
          formControlName="assignedToUserId" 
          class="form-control form-select"
          [disabled]="loadingTeamUsers || savingQualityIssue"
        >
          <option [value]="''">Select User (Optional)</option>
          <option *ngFor="let user of availableTeamUsers" [value]="user.userId">
            {{ user.userName }} <span *ngIf="user.userEmail">({{ user.userEmail }})</span>
          </option>
        </select>
        <div *ngIf="loadingTeamUsers" class="loading-text" style="font-size: 12px; color: #64748b; margin-top: 4px;">
          Loading team members...
        </div>
        <small class="form-hint" *ngIf="!loadingTeamUsers">Optional: Assign to a specific team member</small>
      </div>

      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <path d="M20 8v6M23 11h-6"/>
          </svg>
          CC User
        </label>
        <select 
          formControlName="ccUserId" 
          class="form-control form-select"
          [disabled]="loadingCCUsers || savingQualityIssue"
        >
          <option [value]="''">Select User (Optional)</option>
          <option *ngFor="let user of availableCCUsers" [value]="user.userId">
           {{ user.userName }} <span *ngIf="user.userEmail">({{ user.userEmail }})</span>
          </option>
        </select>
        <div *ngIf="loadingCCUsers" class="loading-text" style="font-size: 12px; color: #64748b; margin-top: 4px;">
          Loading users...
        </div>
        <small class="form-hint" *ngIf="!loadingCCUsers">Optional: CC this issue to notify another user</small>
      </div>

      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          Due Date
        </label>
        <input 
          type="date" 
          formControlName="dueDate" 
          class="form-control form-date"
        >
        <small class="form-hint">Optional: Set a target resolution date</small>
      </div>

      <!-- Quality Issue Images -->
      <div class="form-group quality-issue-images-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          Attachments
          <span class="image-count-badge" *ngIf="qualityIssueImages.length > 0" style="margin-left: 8px;">{{ qualityIssueImages.length }}</span>
        </label>
        <small class="form-hint" style="margin-bottom: 12px;">Upload images, enter URLs, or use your camera</small>

        <!-- Selected Images Grid -->
        <div class="selected-images-list quality-issue-images-list" *ngIf="qualityIssueImages.length > 0">
          <div class="image-preview-item" *ngFor="let image of qualityIssueImages">
            <div class="image-preview-wrapper">
              <img [src]="image.preview" [alt]="image.name || 'Quality issue image'" />
              <button 
                type="button" 
                class="remove-image-btn" 
                (click)="removeQualityIssueImage(image.id)"
                title="Remove image"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
              <div class="image-type-badge" [class.type-file]="image.type === 'file' || image.type === 'camera'" [class.type-url]="image.type === 'url'">
                {{ image.type === 'file' || image.type === 'camera' ? 'File' : 'URL' }}
              </div>
            </div>
            <div class="image-info" *ngIf="image.name || image.url">
              <p class="image-name" *ngIf="image.name">{{ image.name }}</p>
              <p class="image-url" *ngIf="image.url">{{ image.url }}</p>
              <p class="image-size" *ngIf="image.file">{{ (image.file.size / 1024).toFixed(1) }} KB</p>
            </div>
          </div>
          <button 
            type="button" 
            class="btn-clear-all" 
            (click)="clearAllQualityIssueImages()" 
            *ngIf="qualityIssueImages.length > 1"
          >
            Clear All
          </button>
        </div>

        <!-- Input Method Tabs -->
        <div class="photo-input-tabs" *ngIf="!showQualityIssueCamera">
          <button 
            type="button"
            class="tab-button"
            [class.active]="qualityIssuePhotoInputMethod === 'url'"
            (click)="qualityIssuePhotoInputMethod = 'url'; showQualityIssueCamera = false"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            URL
          </button>
          <button 
            type="button"
            class="tab-button"
            [class.active]="qualityIssuePhotoInputMethod === 'upload'"
            (click)="openQualityIssueFileInput(); qualityIssuePhotoInputMethod = 'upload'"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Upload
          </button>
          <button 
            type="button"
            class="tab-button"
            [class.active]="qualityIssuePhotoInputMethod === 'camera'"
            (click)="openQualityIssueCamera()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Camera
          </button>
        </div>

        <!-- URL Input -->
        <div *ngIf="qualityIssuePhotoInputMethod === 'url' && !showQualityIssueCamera" class="photo-input-content">
          <div class="url-input-group">
            <input
              type="text"
              class="form-control"
              placeholder="Enter image URL (e.g., https://example.com/photo.jpg)"
              [(ngModel)]="qualityIssueCurrentUrlInput"
              [ngModelOptions]="{standalone: true}"
              (keydown.enter)="addQualityIssueImageFromUrl(); $event.preventDefault()"
            />
            <button 
              type="button" 
              class="btn-add-url" 
              (click)="addQualityIssueImageFromUrl()"
              [disabled]="!qualityIssueCurrentUrlInput?.trim()"
            >
              Add URL
            </button>
          </div>
        </div>

        <!-- File Upload Input (hidden, supports multiple) -->
        <input
          id="quality-issue-photo-file-input"
          type="file"
          accept="image/*"
          multiple
          style="display: none"
          (change)="onQualityIssuePhotosSelected($event)"
        />

        <!-- Camera Preview -->
        <div *ngIf="showQualityIssueCamera" class="camera-preview-container quality-issue-camera">
          <video
            id="quality-issue-video"
            autoplay
            playsinline
            class="camera-video"
          ></video>
          <div class="camera-controls">
            <button 
              type="button" 
              class="btn btn-secondary btn-sm" 
              (click)="stopQualityIssueCamera()"
            >
              Cancel
            </button>
            <button 
              type="button" 
              class="btn btn-primary btn-sm" 
              (click)="captureQualityIssuePhoto()"
            >
              Capture
            </button>
          </div>
        </div>
      </div>

      <div class="modal-footer quality-issue-modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="closeQualityIssueModal()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="newQualityIssueForm.invalid || savingQualityIssue"
        >
          <span *ngIf="savingQualityIssue" class="spinner small" style="display: inline-block; margin-right: 8px;"></span>
          <svg *ngIf="!savingQualityIssue" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          <span *ngIf="savingQualityIssue">Adding Issue...</span>
          <span *ngIf="!savingQualityIssue">Add Issue</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" *ngIf="isDeleteModalOpen">
  <div class="confirm-modal">
    <h3>Delete checklist item?</h3>
    <p>This action will permanently remove the selected checklist item.</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="cancelDeleteChecklistItem()">Cancel</button>
      <button type="button" class="btn btn-danger" (click)="confirmDeleteChecklistItem()">Delete</button>
    </div>
  </div>
</div>

<!-- Delete Section Confirmation Modal -->
<div class="modal-backdrop" *ngIf="isDeleteSectionModalOpen" (click)="cancelDeleteSection()">
  <div class="delete-section-modal" (click)="$event.stopPropagation()">
    <div class="modal-header-custom">
      <div class="header-icon warning">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>
      <h3>Delete Entire Section?</h3>
    </div>
    <div class="modal-body-custom">
      <p class="section-info">
        Are you sure you want to delete the entire 
        <strong>"{{ pendingDeleteSection?.sectionName }}"</strong> section with 
        <strong>{{ pendingDeleteSection?.items?.length }} item(s)</strong>?
      </p>
      <div class="warning-message">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>This action cannot be undone.</span>
      </div>
    </div>
    <div class="modal-footer-custom">
      <button type="button" class="btn-modal btn-cancel" (click)="cancelDeleteSection()">
        Cancel
      </button>
      <button type="button" class="btn-modal btn-delete" (click)="executeDeleteSection()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
        Delete Section
      </button>
    </div>
  </div>
</div>

<!-- Add Predefined Checklist Items Modal -->
<div class="modal-backdrop" *ngIf="isAddPredefinedItemsModalOpen" (click)="closeAddPredefinedItemsModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2>Add Predefined Checklist Items</h2>
        <p>Select items from the predefined checklist to add to this checkpoint.</p>
        <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length > 0" class="selection-info">
          <span *ngIf="selectedPredefinedItemIds.length > 0" class="selection-count">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            {{ selectedPredefinedItemIds.length }} of {{ availablePredefinedItems.length }} selected
          </span>
          <span *ngIf="selectedPredefinedItemIds.length === 0" class="selection-hint">
            Select items to add to the checkpoint
          </span>
          <div class="select-all-actions">
            <button 
              type="button" 
              class="btn-select-all" 
              (click)="areAllItemsSelected() ? deselectAllItems() : selectAllItems()"
              [disabled]="addingChecklistItems"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              {{ areAllItemsSelected() ? 'Deselect All' : 'Select All' }}
            </button>
          </div>
        </div>
      </div>
      <button class="icon-button" (click)="closeAddPredefinedItemsModal()" [disabled]="addingChecklistItems" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div *ngIf="loadingPredefinedItems" class="loading-state">
        <div class="spinner"></div>
        <p>Loading predefined items...</p>
      </div>
      <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length === 0" class="empty-state">
        <p>All predefined checklist items have been added to this checkpoint.</p>
        <p style="margin-top: 8px; font-size: 0.875rem; opacity: 0.7;">No additional items are available to add.</p>
      </div>
      <div *ngIf="!loadingPredefinedItems && availablePredefinedItems.length > 0" class="predefined-items-list">
        <div *ngFor="let group of getGroupedPredefinedItems()" class="predefined-items-group">
          <div class="group-header">
            <div class="group-header-left">
              <h3 class="group-title">{{ group.category }}</h3>
              <span class="group-count">{{ group.items.length }} item(s)</span>
            </div>
            <button 
              type="button" 
              class="btn-select-group" 
              (click)="areAllInGroupSelected(group.category) ? deselectAllInGroup(group.category) : selectAllInGroup(group.category)"
              [disabled]="addingChecklistItems"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              {{ areAllInGroupSelected(group.category) ? 'Deselect All' : 'Select All' }}
            </button>
          </div>
          <div class="group-items">
            <div 
              *ngFor="let item of group.items" 
              class="predefined-item-card"
              [class.selected]="isPredefinedItemSelected(item.predefinedItemId)"
              (click)="togglePredefinedItemSelection(item.predefinedItemId)"
              role="button"
              tabindex="0"
              (keydown.enter)="togglePredefinedItemSelection(item.predefinedItemId)"
              (keydown.space)="togglePredefinedItemSelection(item.predefinedItemId); $event.preventDefault()"
            >
              <div class="item-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="isPredefinedItemSelected(item.predefinedItemId)"
                  (change)="togglePredefinedItemSelection(item.predefinedItemId)"
                  (click)="$event.stopPropagation()"
                  [id]="'item-' + item.predefinedItemId"
                  [attr.aria-label]="'Select ' + item.checkpointDescription"
                />
              </div>
              <div class="item-content">
                <div class="item-main-line">
                  <span class="item-sequence">#{{ item.sequence }}</span>
                  <p class="item-description">{{ item.checkpointDescription }}</p>
                </div>
                <p class="item-reference" *ngIf="item.referenceDocument">
                  <strong>Reference:</strong> {{ item.referenceDocument }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="error" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>{{ error }}</span>
      </div>
    </div>
    <div class="modal-footer">
      <button 
        type="button" 
        class="btn btn-secondary" 
        (click)="closeAddPredefinedItemsModal()"
        [disabled]="addingChecklistItems"
      >
        Cancel
      </button>
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="onAddChecklistItems()"
        [disabled]="addingChecklistItems || selectedPredefinedItemIds.length === 0"
      >
        <span *ngIf="!addingChecklistItems">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Add Selected Items ({{ selectedPredefinedItemIds.length }})
        </span>
        <span *ngIf="addingChecklistItems">
          <span class="spinner-inline">
            <span class="spinner small"></span>
          </span>
          Adding...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Item Review Modal -->
<div class="modal-backdrop" *ngIf="isItemReviewModalOpen" (click)="closeItemReviewModal()">
  <div class="modal-container review-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2>Review Checklist Item</h2>
        <p *ngIf="selectedReviewItemIndex !== null" class="modal-subtitle">
          {{ checklistItems.at(selectedReviewItemIndex)?.get('checkpointDescription')?.value || 'Checklist Item' }}
        </p>
      </div>
      <button class="icon-button" (click)="closeItemReviewModal()" [disabled]="savingItemReview">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="itemReviewForm" *ngIf="selectedReviewItemIndex !== null">
        <div class="form-group">
          <label for="itemStatus">Status <span class="required">*</span></label>
          <div class="status-selector">
            <button
              type="button"
              class="status-option"
              [class.active]="itemReviewForm.get('status')?.value === CheckpointStatus.Pass"
              [class.pass]="itemReviewForm.get('status')?.value === CheckpointStatus.Pass"
              (click)="itemReviewForm.get('status')?.setValue(CheckpointStatus.Pass)"
              [disabled]="savingItemReview"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Pass
            </button>
            <button
              type="button"
              class="status-option"
              [class.active]="itemReviewForm.get('status')?.value === CheckpointStatus.Fail"
              [class.fail]="itemReviewForm.get('status')?.value === CheckpointStatus.Fail"
              (click)="itemReviewForm.get('status')?.setValue(CheckpointStatus.Fail)"
              [disabled]="savingItemReview"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Fail
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="itemReferenceDocument">Reference Document</label>
          <input
            id="itemReferenceDocument"
            type="text"
            formControlName="referenceDocument"
            class="form-control"
            placeholder="e.g., Drawing No., Specification"
            [disabled]="savingItemReview"
            maxlength="250"
          />
          <small class="form-text text-muted">Optional reference document or specification.</small>
        </div>

        <div class="form-group">
          <label for="itemRemarks">Remarks <span class="required" *ngIf="itemReviewForm.get('status')?.value === CheckpointStatus.Fail">*</span></label>
          <textarea
            id="itemRemarks"
            formControlName="remarks"
            class="form-control"
            rows="6"
            placeholder="Enter your review, observations, or remarks for this checklist item..."
            [disabled]="savingItemReview"
            maxlength="1000"
          ></textarea>
          <small class="form-text text-muted">
            Provide detailed feedback or observations. <span *ngIf="itemReviewForm.get('status')?.value === CheckpointStatus.Fail" class="text-danger">Remarks are required for failed items.</span>
          </small>
          <div *ngIf="itemReviewForm.get('remarks')?.invalid && itemReviewForm.get('remarks')?.touched" class="error-text">
            Remarks are required when status is Fail.
          </div>
        </div>
      </form>
      <div *ngIf="error" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <span>{{ error }}</span>
      </div>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="closeItemReviewModal()"
        [disabled]="savingItemReview"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="saveItemReview()"
        [disabled]="savingItemReview || isItemReviewFormInvalid()"
      >
        <span *ngIf="!savingItemReview">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          Save Review
        </span>
        <span *ngIf="savingItemReview">
          <span class="spinner-inline">
            <span class="spinner small"></span>
          </span>
          Saving...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Quality Issue Details Modal -->
<app-quality-issue-details-modal
  *ngIf="isQualityIssueDetailsModalOpen"
  [issue]="getQualityIssueDetailsForModal()"
  [wirCheckpoints]="getWirCheckpointsForModal()"
  [isOpen]="isQualityIssueDetailsModalOpen"
  (close)="closeQualityIssueDetailsModal()"
></app-quality-issue-details-modal>

<!-- Pass All Confirmation Modal -->
<div class="modal-backdrop" *ngIf="isBulkPassModalOpen" (click)="closeBulkPassModal()">
  <div class="bulk-action-modal approve-modal" (click)="$event.stopPropagation()">
    <div class="bulk-modal-header">
      <div class="header-icon-circle success">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <h3 class="bulk-modal-title">Approve All Checklist Items</h3>
      <p class="bulk-modal-description">
        This will mark all <strong>{{ checklistItems.length }} checklist items</strong> as <span class="status-badge pass">PASS</span> and save them to the database.
      </p>
      <button class="bulk-close-btn" (click)="closeBulkPassModal()" [disabled]="submitting" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="bulk-modal-body">
      <div class="form-group-modern">
        <label for="bulkPassReason" class="form-label-modern">
          Optional Note
          <span class="label-badge optional">Optional</span>
        </label>
        <textarea 
          id="bulkPassReason"
          [formControl]="bulkReasonControl"
          rows="3"
          placeholder="Add an optional note for passing all items..."
          class="form-control-modern"
          [disabled]="submitting"
        ></textarea>
        <div class="form-hint">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4"/>
            <path d="M12 8h.01"/>
          </svg>
          <span>This note is optional. Any existing remarks will be cleared.</span>
        </div>
      </div>
      <div class="warning-banner amber">
        <div class="warning-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>
        <div class="warning-content">
          <div class="warning-title">Warning</div>
          <div class="warning-text">
            This action will overwrite the status and remarks of <strong>all {{ checklistItems.length }} items</strong>. This cannot be undone.
          </div>
        </div>
      </div>
    </div>
    <div class="bulk-modal-footer">
      <button 
        type="button" 
        class="bulk-btn bulk-btn-cancel" 
        (click)="closeBulkPassModal()"
        [disabled]="submitting"
      >
        Cancel
      </button>
      <button 
        type="button" 
        class="bulk-btn bulk-btn-success" 
        (click)="onBulkPass()"
        [disabled]="submitting"
      >
        <span class="spinner small" *ngIf="submitting"></span>
        <svg *ngIf="!submitting" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        <span>{{ submitting ? 'Saving...' : 'Pass All Items' }}</span>
      </button>
    </div>
  </div>
</div>

<!-- Reject All Modal -->
<div class="modal-backdrop" *ngIf="isBulkRejectModalOpen" (click)="closeBulkRejectModal()">
  <div class="bulk-action-modal reject-modal" (click)="$event.stopPropagation()">
    <div class="bulk-modal-header">
      <div class="header-icon-circle danger">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
      </div>
      <h3 class="bulk-modal-title">Reject All Checklist Items</h3>
      <p class="bulk-modal-description">
        This will mark all <strong>{{ checklistItems.length }} checklist items</strong> as <span class="status-badge fail">FAIL</span> and save them to the database.
      </p>
      <button class="bulk-close-btn" (click)="closeBulkRejectModal()" [disabled]="submitting" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="bulk-modal-body">
      <div class="form-group-modern">
        <label for="bulkRejectReason" class="form-label-modern">
          Rejection Reason
          <span class="label-badge required">Required</span>
        </label>
        <textarea 
          id="bulkRejectReason"
          [formControl]="bulkReasonControl"
          rows="4"
          placeholder="Enter the reason for rejecting all items..."
          class="form-control-modern"
          [disabled]="submitting"
          [class.error]="bulkReasonControl.touched && !bulkReasonControl.value?.trim()"
        ></textarea>
        <div class="form-hint">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4"/>
            <path d="M12 8h.01"/>
          </svg>
          <span>A rejection reason is required for all items.</span>
        </div>
        <div class="form-error" *ngIf="bulkReasonControl.touched && !bulkReasonControl.value?.trim()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>Please provide a reason for the rejection</span>
        </div>
      </div>
      <div class="warning-banner danger">
        <div class="warning-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>
        <div class="warning-content">
          <div class="warning-title">Critical Action</div>
          <div class="warning-text">
            This will mark <strong>all {{ checklistItems.length }} items</strong> as FAILED with the same reason. This cannot be undone.
          </div>
        </div>
      </div>
    </div>
    <div class="bulk-modal-footer">
      <button 
        type="button" 
        class="bulk-btn bulk-btn-cancel" 
        (click)="closeBulkRejectModal()"
        [disabled]="submitting"
      >
        Cancel
      </button>
      <button 
        type="button" 
        class="bulk-btn bulk-btn-danger" 
        (click)="onBulkReject()"
        [disabled]="submitting || !bulkReasonControl.value?.trim()"
      >
        <span class="spinner small" *ngIf="submitting"></span>
        <svg *ngIf="!submitting" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>{{ submitting ? 'Saving...' : 'Reject All Items' }}</span>
      </button>
    </div>
  </div>
</div>

<!-- Lightbox Modal -->
<div class="lightbox-overlay" *ngIf="lightboxOpen" (click)="closeLightbox()">
  <div class="lightbox-container" (click)="$event.stopPropagation()">
    <button class="lightbox-close" (click)="closeLightbox()" aria-label="Close lightbox">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <button class="lightbox-nav lightbox-prev" *ngIf="lightboxImages.length > 1" (click)="previousImage()" aria-label="Previous image">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
    <img [src]="getCurrentLightboxImage()" 
         [alt]="'Quality issue image ' + (lightboxImageIndex + 1)"
         class="lightbox-image"
         (error)="onImageError($event)" />
    <button class="lightbox-nav lightbox-next" *ngIf="lightboxImages.length > 1" (click)="nextImage()" aria-label="Next image">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </button>
    <div class="lightbox-counter" *ngIf="lightboxImages.length > 1">
      {{ lightboxImageIndex + 1 }} / {{ lightboxImages.length }}
    </div>
  </div>
</div>

