<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="header-left">
        <h2 class="modal-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
          </svg>
          Box Quick View
        </h2>
        <div class="box-code" *ngIf="box">
          {{ box.code }}
        </div>
      </div>
      <button class="btn-close" (click)="closeModal()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading box details...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="error-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h3>Error Loading Box</h3>
        <p>{{ error }}</p>
      </div>

      <!-- Content -->
      <div *ngIf="!loading && !error && box" class="modal-content">
        <!-- Activity Progress and Delivery Info Section - Side by Side -->
        <div class="activity-delivery-layout">
          <!-- Activity Progress Overview Card -->
          <div class="info-card chart-card">
            <h3 class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"/>
                <line x1="18" y1="20" x2="18" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="16"/>
              </svg>
              Activity Progress Overview
            </h3>
            <div class="chart-container">
              <!-- Visual Chart Section -->
              <div class="visual-chart-section">
                <!-- Donut Chart -->
                <div class="donut-chart-wrapper">
                  <svg class="donut-chart" viewBox="0 0 200 200">
                    <!-- Background circle -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#e2e8f0" 
                      stroke-width="30"/>
                    
                    <!-- Completed segment (green) -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#22c55e" 
                      stroke-width="30"
                      [attr.stroke-dasharray]="getCircleSegment('Completed')"
                      [attr.stroke-dashoffset]="0"
                      transform="rotate(-90 100 100)"
                      class="segment completed-segment"/>
                    
                    <!-- In Progress segment (blue) -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#3b82f6" 
                      stroke-width="30"
                      [attr.stroke-dasharray]="getCircleSegment('InProgress')"
                      [attr.stroke-dashoffset]="getCircleOffset('InProgress')"
                      transform="rotate(-90 100 100)"
                      class="segment in-progress-segment"/>
                    
                    <!-- Not Started segment (gray) -->
                    <circle 
                      cx="100" 
                      cy="100" 
                      r="80" 
                      fill="none" 
                      stroke="#94a3b8" 
                      stroke-width="30"
                      [attr.stroke-dasharray]="getCircleSegment('NotStarted')"
                      [attr.stroke-dashoffset]="getCircleOffset('NotStarted')"
                      transform="rotate(-90 100 100)"
                      class="segment not-started-segment"/>
                    
                    <!-- Center text -->
                    <text x="100" y="95" text-anchor="middle" class="chart-center-value">
                      {{ box.activitiesCount || box.activities?.length || 0 }}
                    </text>
                    <text x="100" y="115" text-anchor="middle" class="chart-center-label">
                      Activities
                    </text>
                  </svg>
                  
                  <!-- Chart Legend -->
                  <div class="chart-legend">
                    <div class="legend-item">
                      <div class="legend-color completed-color"></div>
                      <span class="legend-text">Completed ({{ getActivityPercentage('Completed') }}%)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color in-progress-color"></div>
                      <span class="legend-text">In Progress ({{ getActivityPercentage('InProgress') }}%)</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color not-started-color"></div>
                      <span class="legend-text">Not Started ({{ getActivityPercentage('NotStarted') }}%)</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="activity-stats">
                <div class="stat-item">
                  <div class="stat-icon not-started">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ getActivityCountByStatus('NotStarted') }}</div>
                    <div class="stat-label">Not Started</div>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="stat-icon in-progress">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ getActivityCountByStatus('InProgress') }}</div>
                    <div class="stat-label">In Progress</div>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="stat-icon completed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                      <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ getActivityCountByStatus('Completed') }}</div>
                    <div class="stat-label">Completed</div>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="stat-icon total">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <line x1="3" y1="9" x2="21" y2="9"/>
                      <line x1="9" y1="21" x2="9" y2="9"/>
                    </svg>
                  </div>
                  <div class="stat-content">
                    <div class="stat-value">{{ box.activitiesCount || box.activities?.length || 0 }}</div>
                    <div class="stat-label">Total Activities</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Delivery Information Section -->
          <div class="delivery-info-wrapper">
            <!-- Concrete Panel Delivery Card -->
            <div class="info-card delivery-card concrete-panel-card">
              <div class="card-header-with-icon">
                <div class="icon-wrapper concrete-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                  </svg>
                </div>
                <div class="card-title-section">
                  <h3 class="card-title">Concrete Panel Delivery</h3>
                  <!-- Status Legend -->
                  <div class="panel-status-legend" *ngIf="boxPanels.length > 0">
                    <button class="legend-toggle" (click)="toggleLegend()" [attr.aria-expanded]="showLegend">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                      </svg>
                      Status Legend
                    </button>
                    <div class="legend-content" *ngIf="showLegend">
                      <div class="legend-item">
                        <div class="legend-color panel-status-not-started"></div>
                        <span>Not Started (Gray)</span>
                      </div>
                      <div class="legend-item">
                        <div class="legend-color panel-status-first-approval-approved"></div>
                        <span>First Approval Approved (Yellow)</span>
                      </div>
                      <div class="legend-item">
                        <div class="legend-color panel-status-second-approval-approved"></div>
                        <span>Second Approval Approved (Green)</span>
                      </div>
                      <div class="legend-item">
                        <div class="legend-color panel-status-second-approval-rejected"></div>
                        <span>Second Approval Rejected (Red)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="delivery-grid concrete-grid">
                <!-- Dynamic Panels -->
                <div class="delivery-item panel-item" 
                     *ngFor="let panel of boxPanels"
                     [class.panel-status-not-started]="isPanelStatus(panel.panelStatus, PanelStatus.NotStarted)"
                     [class.panel-status-first-approval-approved]="isPanelStatus(panel.panelStatus, PanelStatus.FirstApprovalApproved)"
                     [class.panel-status-second-approval-approved]="isPanelStatus(panel.panelStatus, PanelStatus.SecondApprovalApproved)"
                     [class.panel-status-second-approval-rejected]="isPanelStatus(panel.panelStatus, PanelStatus.SecondApprovalRejected)">
                  <div class="panel-status-controls">
                    <div class="panel-name-section">
                      <span class="panel-name">{{ panel.panelName }}</span>
                      <span class="panel-status-text" [ngClass]="getPanelStatusTextClass(panel.panelStatus)">
                        {{ getPanelStatusLabel(panel.panelStatus) }}
                      </span>
                    </div>
                    <div class="panel-status-indicator"
                         [class.status-not-started]="panel.panelStatus === PanelStatus.NotStarted"
                         [class.status-yellow]="panel.panelStatus === PanelStatus.FirstApprovalApproved"
                         [class.status-green]="panel.panelStatus === PanelStatus.SecondApprovalApproved"
                         [class.status-red]="panel.panelStatus === PanelStatus.SecondApprovalRejected"
                         [title]="getPanelStatusLabel(panel.panelStatus)">
                    </div>
                  </div>
                </div>
                
                <!-- Slab -->
                <div class="delivery-item">
                  <label class="checkbox-label" [class.checked]="slabChecked">
                    <input 
                      type="checkbox" 
                      [checked]="slabChecked"
                      disabled
                      class="checkbox-input">
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Slab</span>
                    <span class="check-icon" *ngIf="slabChecked">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    </span>
                  </label>
                </div>
                
                <!-- Soffit -->
                <div class="delivery-item">
                  <label class="checkbox-label" [class.checked]="soffitChecked">
                    <input 
                      type="checkbox" 
                      [checked]="soffitChecked"
                      disabled
                      class="checkbox-input">
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">Soffit</span>
                    <span class="check-icon" *ngIf="soffitChecked">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    </span>
                  </label>
                </div>
                
                <!-- Empty state -->
                <div class="delivery-item empty-state" *ngIf="boxPanels.length === 0 && !slabChecked && !soffitChecked">
                  <span class="empty-message">No panels configured for this box</span>
                </div>
              </div>
            </div>

            <!-- Pod Delivery Card -->
            <div class="info-card delivery-card pod-delivery-card">
              <div class="card-header-with-icon">
                <div class="icon-wrapper pod-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                  </svg>
                </div>
                <h3 class="card-title">Pod Delivery</h3>
              </div>
              
              <div class="pod-delivery-container">
                <label class="checkbox-label pod-deliver-checkbox" [class.checked]="podDeliverChecked">
                  <input 
                    type="checkbox" 
                    [checked]="podDeliverChecked"
                    disabled
                    class="checkbox-input">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text">Pod Deliver</span>
                  <span class="check-icon" *ngIf="podDeliverChecked">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  </span>
                </label>
                
                <div class="pod-details" *ngIf="podDeliverChecked">
                  <div class="pod-details-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="12" y1="18" x2="12" y2="12"/>
                      <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                    <span>Pod Information</span>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="podType">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                          <circle cx="8.5" cy="7" r="4"/>
                        </svg>
                        Pod Type
                      </label>
                      <input 
                        type="text" 
                        id="podType"
                        [value]="podType"
                        disabled
                        class="form-input"
                        placeholder="No pod type">
                    </div>
                    <div class="form-group">
                      <label for="podName">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                          <circle cx="12" cy="7" r="4"/>
                        </svg>
                        Pod Name
                      </label>
                      <input 
                        type="text" 
                        id="podName"
                        [value]="podName"
                        disabled
                        class="form-input"
                        placeholder="No pod name">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer" *ngIf="!loading && !error && box">
      <button class="btn-secondary" (click)="closeModal()">Close</button>
      <button class="btn-primary" (click)="viewFullDetails()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
          <polyline points="15 3 21 3 21 9"/>
          <line x1="10" y1="14" x2="21" y2="3"/>
        </svg>
        View Full Details
      </button>
    </div>
  </div>
</div>
