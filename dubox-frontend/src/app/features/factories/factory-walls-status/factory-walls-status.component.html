<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading walls status...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-container">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <h3>Error Loading Data</h3>
      <p>{{ error }}</p>
      <button class="btn-primary" (click)="loadData()">Try Again</button>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading && !error && factory" class="walls-status-container">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-left">
          <button class="btn-back" (click)="goBack()" title="Back to Factory Layout">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
          </button>
          <div class="header-info">
            <h1>Panels, Slab & Soffit Status</h1>
            <div class="factory-name">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
              </svg>
              {{ factory.factoryName }}
            </div>
          </div>
        </div>
        <div class="header-right">
          <div class="factory-badge">
            <span class="badge-label">Code:</span>
            <span class="badge-value">{{ factory.factoryCode }}</span>
          </div>
        </div>
      </div>

      <!-- Project Selection + Filters Section with Inline KPI Cards -->
      <div class="filters-section">
        <div class="filters-with-kpis">
          <!-- Project Selection (Schedule-style behaviour) -->
          <div class="filter-group">
            <label for="projectFilter" class="filter-label">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3h18v18H3z"/>
                <path d="M3 9h18M9 21V9"/>
              </svg>
              Project:
            </label>
            <select 
              id="projectFilter" 
              [(ngModel)]="selectedProjectId" 
              (ngModelChange)="onProjectSelect()" 
              class="filter-select">
              <option value="">Select a project...</option>
              <option *ngFor="let project of projects" [value]="project.id">{{ project.name }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="buildingFilter" class="filter-label">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <line x1="3" y1="9" x2="21" y2="9"/>
                <line x1="9" y1="21" x2="9" y2="9"/>
              </svg>
              Building:
            </label>
            <select id="buildingFilter" [(ngModel)]="selectedBuildingNumber" (change)="applyFilters()" class="filter-select">
              <option value="">All Buildings</option>
              <option *ngFor="let building of availableBuildingNumbers" [value]="building">{{ building }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="floorFilter" class="filter-label">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <line x1="3" y1="9" x2="21" y2="9"/>
                <line x1="9" y1="21" x2="9" y2="9"/>
              </svg>
              Level:
            </label>
            <select id="floorFilter" [(ngModel)]="selectedFloor" (change)="applyFilters()" class="filter-select">
              <option value="">All Levels</option>
              <option *ngFor="let floor of availableFloors" [value]="floor">{{ floor }}</option>
            </select>
          </div>

          <button class="btn-clear-filters" (click)="clearFilters()" *ngIf="selectedProjectId || selectedBuildingNumber || selectedFloor">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Clear Filters
          </button>

          <div class="inline-kpi-cards" *ngIf="selectedProjectId && filteredBoxes.length > 0">
            <div class="inline-kpi-card total-kpi">
              <div class="kpi-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
              </div>
              <div class="kpi-content">
                <div class="kpi-value">{{ getCompletionStats().total }}</div>
                <div class="kpi-label">Total Boxes</div>
              </div>
            </div>

            <div class="inline-kpi-card complete-kpi">
              <div class="kpi-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              <div class="kpi-content">
                <div class="kpi-value">{{ getCompletionStats().allComplete }}</div>
                <div class="kpi-label">Fully Complete</div>
                <div class="kpi-percentage">{{ getCompletionPercentage(getCompletionStats().allComplete) }}%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No Project Selected State -->
      <div *ngIf="!selectedProjectId && !loading && !error" class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M3 9h18M9 21V9"/>
        </svg>
        <h3>Select a Project</h3>
        <p>Choose a project from the dropdown above to view its panels, slab and soffit status.</p>
      </div>

      <!-- Statistics Cards Grid -->
      <div class="stats-grid" *ngIf="selectedProjectId && filteredBoxes.length > 0">

        <!-- Dynamic Panel Stats (per Panel Type) -->
        <div class="stat-card wall-stat" *ngFor="let panelType of getPanelTypeColumns()">
          <div class="stat-content">
            <div class="stat-label">{{ panelType.panelTypeName }}</div>
            <div class="stat-progress">
              <div class="progress-bar">
                <div class="progress-fill" 
                     [style.width.%]="getCompletionPercentage(getCompletionStats().panelStats.get(panelType.panelTypeName)?.green || 0)"
                     [style.backgroundColor]="'#10b981'"></div>
              </div>
              <div class="status-summary">
                <div class="status-summary-row">
                  <div class="status-item status-green">
                    <span class="status-dot"></span>
                    <span class="status-label">Green</span>
                    <span class="status-count">{{ getCompletionStats().panelStats.get(panelType.panelTypeName)?.green || 0 }}</span>
                  </div>
                  <div class="status-item status-yellow">
                    <span class="status-dot"></span>
                    <span class="status-label">Yellow</span>
                    <span class="status-count">{{ getCompletionStats().panelStats.get(panelType.panelTypeName)?.yellow || 0 }}</span>
                  </div>
                </div>
                <div class="status-summary-row">
                  <div class="status-item status-red">
                    <span class="status-dot"></span>
                    <span class="status-label">Red</span>
                    <span class="status-count">{{ getCompletionStats().panelStats.get(panelType.panelTypeName)?.red || 0 }}</span>
                  </div>
                  <div class="status-item status-gray">
                    <span class="status-dot"></span>
                    <span class="status-label">Gray</span>
                    <span class="status-count">{{ getCompletionStats().panelStats.get(panelType.panelTypeName)?.gray || 0 }}</span>
                  </div>
                </div>
                <div class="status-total">
                  <span class="total-label">Total:</span>
                  <span class="total-count">{{ getCompletionStats().panelStats.get(panelType.panelTypeName)?.total || 0 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Combined Slab, Soffit, and POD Delivery Card -->
        <div class="stat-card combined-delivery-stat">
          <div class="stat-content">
            <div class="stat-label">Delivery Status</div>
            <div class="delivery-items">
              <div class="delivery-item">
                <div class="delivery-header">
                  <span class="delivery-name">Slab</span>
                  <span class="delivery-count">{{ getCompletionStats().slabComplete }}/{{ getCompletionStats().total }}</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" 
                       [style.width.%]="getCompletionPercentage(getCompletionStats().slabComplete)"
                       [style.backgroundColor]="getCompletionStats().slabComplete === getCompletionStats().total ? '#10b981' : '#e2e8f0'"></div>
                </div>
              </div>
              
              <div class="delivery-item">
                <div class="delivery-header">
                  <span class="delivery-name">Soffit</span>
                  <span class="delivery-count">{{ getCompletionStats().soffitComplete }}/{{ getCompletionStats().total }}</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" 
                       [style.width.%]="getCompletionPercentage(getCompletionStats().soffitComplete)"
                       [style.backgroundColor]="getCompletionStats().soffitComplete === getCompletionStats().total ? '#10b981' : '#e2e8f0'"></div>
                </div>
              </div>
              
              <div class="delivery-item pod-item">
                <div class="delivery-header">
                  <span class="delivery-name">POD Delivery</span>
                  <span class="delivery-count">{{ getCompletionStats().podDeliverComplete }}/{{ getCompletionStats().total }}</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" 
                       [style.width.%]="getCompletionPercentage(getCompletionStats().podDeliverComplete)"
                       [style.backgroundColor]="getCompletionStats().podDeliverComplete === getCompletionStats().total ? '#c084fc' : '#e2e8f0'"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="table-card">
        <div class="table-header">
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <line x1="3" y1="9" x2="21" y2="9"/>
              <line x1="9" y1="21" x2="9" y2="9"/>
            </svg>
            Detailed Status Table
          </h3>
          <div class="table-header-right">
            <div class="table-info">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              <span>{{ filteredBoxes.length }} box(es)</span>
            </div>
            <button 
              class="btn-export-excel" 
              (click)="exportToExcel()"
              *ngIf="selectedProjectId && filteredBoxes.length > 0"
              title="Export to Excel">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export to Excel
            </button>
          </div>
        </div>

        <div class="table-wrapper" *ngIf="selectedProjectId && filteredBoxes.length > 0">
          <table class="walls-table">
            <thead>
              <tr>
                <th class="sticky-col">Box Tag / Box Number / Serial Number</th>
                <th>Building</th>
                <th>Floor</th>
                <th *ngFor="let panelType of getPanelTypeColumns()">
                  {{ panelType.panelTypeName }}
                </th>
                <th>Slab</th>
                <th>Soffit</th>
                <th>POD Deliver</th>
                <th>POD Name</th>
                <th>POD Type</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let box of filteredBoxes" (click)="viewBox(box.id)" class="clickable-row">
                <td class="sticky-col box-identifier">
                  <div class="box-number" *ngIf="box.boxNumber">#{{ box.boxNumber }}</div>
                  <div class="box-tag">{{ box.code }}</div>
                  <div class="box-serial" *ngIf="box.serialNumber">{{ box.serialNumber }}</div>
                </td>
                <td class="box-info">
                  <span *ngIf="box.buildingNumber">{{ box.buildingNumber }}</span>
                  <span *ngIf="!box.buildingNumber" class="no-data">-</span>
                </td>
                <td class="box-info">
                  <span *ngIf="box.floor">{{ box.floor }}</span>
                  <span *ngIf="!box.floor" class="no-data">-</span>
                </td>
                <!-- Dynamic Panel Columns -->
                <td *ngFor="let panelType of getPanelTypeColumns()" 
                    [class.panel-cell]="true"
                    [class.panel-green]="getAggregatedPanelStatus(box, panelType) === PanelStatus.SecondApprovalApproved"
                    [class.panel-yellow]="getAggregatedPanelStatus(box, panelType) === PanelStatus.FirstApprovalApproved"
                    [class.panel-red]="getAggregatedPanelStatus(box, panelType) === PanelStatus.SecondApprovalRejected"
                    [class.panel-not-started]="getAggregatedPanelStatus(box, panelType) === PanelStatus.NotStarted"
                    [class.panel-not-have]="getPanelsForPanelType(box, panelType).length === 0">
                  <div class="panel-content">
                    <div *ngIf="getPanelsForPanelType(box, panelType).length > 0; else noPanelTemplate">
                      <div class="panel-name-section" *ngFor="let panel of getPanelsForPanelType(box, panelType)">
                        <span class="panel-name">{{ panel.panelName }}</span>
                        <span class="panel-status-text" [ngClass]="getPanelStatusTextClass(box, panel.typeName || panel.panelName)">
                          {{ getPanelStatusLabel(box, panel.typeName || panel.panelName) }}
                        </span>
                      </div>
                    </div>
                    <ng-template #noPanelTemplate>
                      <div class="panel-name-section">
                        <span class="panel-name">{{ panelType.panelTypeName }}</span>
                        <span class="panel-status-text status-text-not-have">
                          Not Have This Panel
                        </span>
                      </div>
                    </ng-template>
                  </div>
                </td>
                <td [class.status-finished]="box.slab" [class.status-not-finished]="!box.slab">
                  <span class="status-icon" *ngIf="box.slab">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  </span>
                  <span class="status-icon" *ngIf="!box.slab">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </span>
                </td>
                <td [class.status-finished]="box.soffit" [class.status-not-finished]="!box.soffit">
                  <span class="status-icon" *ngIf="box.soffit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  </span>
                  <span class="status-icon" *ngIf="!box.soffit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </span>
                </td>
                <td [class.status-finished]="box.podDeliver" [class.status-not-finished]="!box.podDeliver">
                  <span class="status-icon" *ngIf="box.podDeliver">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  </span>
                  <span class="status-icon" *ngIf="!box.podDeliver">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </span>
                </td>
                <td class="pod-info">
                  <span *ngIf="box.podName">{{ box.podName }}</span>
                  <span *ngIf="!box.podName" class="no-data">-</span>
                </td>
                <td class="pod-info">
                  <span *ngIf="box.podType">{{ box.podType }}</span>
                  <span *ngIf="!box.podType" class="no-data">-</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty State when a project is selected but no boxes are available -->
        <div class="empty-state" *ngIf="selectedProjectId && filteredBoxes.length === 0 && !loading">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <line x1="3" y1="9" x2="21" y2="9"/>
            <line x1="9" y1="21" x2="9" y2="9"/>
          </svg>
          <h3>No Boxes Available</h3>
          <p>There are no boxes with position data for the selected project in this factory.</p>
          <button class="btn-primary" (click)="goBack()">Back to Layout</button>
        </div>

        <!-- Legend -->
        <div class="table-legend" *ngIf="selectedProjectId && filteredBoxes.length > 0">
          <div class="legend-item">
            <span class="legend-panel-cell panel-not-started">Not Started</span>
            <span>Not Started (Gray)</span>
          </div>
          <div class="legend-item">
            <span class="legend-panel-cell panel-yellow">First Approval Approved</span>
            <span>First Approval Approved (Yellow)</span>
          </div>
          <div class="legend-item">
            <span class="legend-panel-cell panel-green">Second Approval Approved</span>
            <span>Second Approval Approved (Green)</span>
          </div>
          <div class="legend-item">
            <span class="legend-panel-cell panel-red">Second Approval Rejected</span>
            <span>Second Approval Rejected (Red)</span>
          </div>
          <div class="legend-item">
            <span class="legend-panel-cell panel-not-have">P-001</span>
            <span>Not Have This Panel</span>
          </div>
          <div class="legend-item hint">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>
            </svg>
            <span>Click on any row to view box details</span>
          </div>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container" *ngIf="totalPages > 1">
          <div class="pagination-left">
            <div class="pagination-info-text">
              <span class="info-label">Showing</span>
              <span class="info-value">{{ ((currentPage - 1) * pageSize) + 1 }}</span>
              <span class="info-separator">-</span>
              <span class="info-value">{{ Math.min(currentPage * pageSize, totalCount) }}</span>
              <span class="info-label">of</span>
              <span class="info-total">{{ totalCount }}</span>
              <span class="info-label">boxes</span>
            </div>
            <div class="page-size-selector">
              <label class="page-size-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <line x1="3" y1="9" x2="21" y2="9"/>
                  <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                Per page:
              </label>
              <select 
                class="page-size-select" 
                [ngModel]="pageSize" 
                (ngModelChange)="onPageSizeChange($event)"
              >
                <option [value]="25">25</option>
                <option [value]="50">50</option>
                <option [value]="100">100</option>
              </select>
            </div>
          </div>
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              [disabled]="currentPage === 1"
              (click)="onPageChange(1)"
              title="First page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="11 17 6 12 11 7"/>
                <polyline points="18 17 13 12 18 7"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              [disabled]="currentPage === 1"
              (click)="onPageChange(currentPage - 1)"
              title="Previous page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
              </svg>
            </button>
            <div class="page-numbers">
              <button 
                *ngFor="let page of getPageNumbers()"
                class="page-number"
                [class.active]="page === currentPage"
                (click)="onPageChange(page)"
              >
                {{ page }}
              </button>
            </div>
            <button 
              class="pagination-btn" 
              [disabled]="currentPage === totalPages"
              (click)="onPageChange(currentPage + 1)"
              title="Next page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              [disabled]="currentPage === totalPages"
              (click)="onPageChange(totalPages)"
              title="Last page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="13 17 18 12 13 7"/>
                <polyline points="6 17 11 12 6 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

