<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading material details...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="error-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 8v4M12 16h.01"/>
        </svg>
        <p>{{ error }}</p>
        <button class="btn btn-secondary" (click)="backToList()">Back to Materials</button>
      </div>

    <!-- Material Details -->
    <div *ngIf="material && !loading">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-left">
          <button class="btn-back" (click)="backToList()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
            Back to Materials
          </button>
          <div class="title-section">
            <h1 class="page-title">{{ material.materialName }}</h1>
            <span class="badge" [class.active]="material.isActive" [class.inactive]="!material.isActive">
              {{ material.isActive ? 'Active' : 'Inactive' }}
            </span>
          </div>
          <p class="page-subtitle">{{ material.materialCode }} â€¢ {{ material.materialCategory || 'No Category' }}</p>
        </div>
        <div class="header-right">
          <button class="btn btn-secondary" (click)="openRestockModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Restock
          </button>
          <button class="btn btn-primary" (click)="editMaterial()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab" 
          [class.active]="activeTab === 'overview'"
          (click)="setActiveTab('overview')"
        >
          Overview
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab === 'transactions'"
          (click)="setActiveTab('transactions')"
        >
          Transactions ({{ transactions.length }})
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <div *ngIf="activeTab === 'overview'" class="overview-tab">
          <div class="content-grid">
            <!-- Stock Information Card -->
            <div class="info-card">
              <h3 class="card-title">Stock Information</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Current Stock</span>
                  <span class="value" [class]="getStockStatusClass()">
                    {{ material.currentStock ?? 0 }} {{ material.unit || '' }}
                  </span>
                  <span class="badge" [class]="getStockStatusClass()" style="margin-top: 4px;">
                    {{ getStockStatusText() }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="label">Minimum Stock</span>
                  <span class="value">{{ material.minimumStock ?? '-' }} {{ material.unit || '' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Reorder Level</span>
                  <span class="value">{{ material.reorderLevel ?? '-' }} {{ material.unit || '' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Unit Cost</span>
                  <span class="value">{{ material.unitCost ? '$' + material.unitCost.toFixed(2) : '-' }}</span>
                </div>
              </div>
            </div>

            <!-- Material Information Card -->
            <div class="info-card">
              <h3 class="card-title">Material Information</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Material Code</span>
                  <span class="value">{{ material.materialCode }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Material Name</span>
                  <span class="value">{{ material.materialName }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Category</span>
                  <span class="value">{{ material.materialCategory || '-' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Unit</span>
                  <span class="value">{{ material.unit || '-' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Supplier</span>
                  <span class="value">{{ material.supplierName || '-' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Status</span>
                  <span class="value">
                    <span class="badge" [class.active]="material.isActive" [class.inactive]="!material.isActive">
                      {{ material.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Transactions Tab -->
        <div *ngIf="activeTab === 'transactions'" class="transactions-tab">
          <div class="transactions-container">
            <table class="transactions-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Quantity</th>
                  <th>Reference</th>
                  <th>Performed By</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let transaction of transactions">
                  <td>{{ formatDate(transaction.transactionDate) }}</td>
                  <td>
                    <span class="transaction-type" [class]="getTransactionTypeClass(transaction.transactionType)">
                      {{ transaction.transactionType || '-' }}
                    </span>
                  </td>
                  <td class="quantity-cell">
                    <span [class.positive]="transaction.transactionType?.toLowerCase() === 'receipt'"
                          [class.negative]="transaction.transactionType?.toLowerCase() === 'issue'">
                      {{ transaction.transactionType?.toLowerCase() === 'receipt' ? '+' : '' }}{{ transaction.quantity ?? 0 }}
                    </span>
                  </td>
                  <td>{{ transaction.reference || '-' }}</td>
                  <td>{{ transaction.performedByUserName || '-' }}</td>
                  <td>{{ transaction.remarks || '-' }}</td>
                </tr>
              </tbody>
            </table>

            <div *ngIf="transactions.length === 0" class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              <h3>No Transactions</h3>
              <p>No transaction history recorded for this material</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Restock Modal -->
    <div *ngIf="showRestockModal" class="modal-overlay" (click)="closeRestockModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Restock Material</h2>
            <button class="modal-close" (click)="closeRestockModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          <form [formGroup]="restockForm" (ngSubmit)="onRestock()">
            <!-- Alert Messages -->
            <div *ngIf="restockMessage" class="restock-alert" [class.alert-success]="restockMessageType === 'success'" [class.alert-error]="restockMessageType === 'error'">
              <div class="alert-content">
                <svg *ngIf="restockMessageType === 'success'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <svg *ngIf="restockMessageType === 'error'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>{{ restockMessage }}</span>
              </div>
            </div>

            <div class="modal-body">
              <div class="form-group">
                <label>Current Stock</label>
                <div class="current-stock-display">
                  {{ material?.currentStock ?? 0 }} {{ material?.unit || '' }}
                </div>
              </div>

              <div class="form-group">
                <label for="quantity">Quantity to Add <span class="required">*</span></label>
                <input 
                  type="number" 
                  id="quantity"
                  formControlName="quantity"
                  class="form-control"
                  step="0.01"
                  min="0.01"
                  placeholder="Enter quantity"
                  [class.invalid]="restockForm.get('quantity')?.invalid && restockForm.get('quantity')?.touched"
                />
                <div *ngIf="restockForm.get('quantity')?.invalid && restockForm.get('quantity')?.touched" class="error-text">
                  Quantity is required and must be greater than 0
                </div>
              </div>

              <div class="form-group">
                <label for="reference">Reference</label>
                <input 
                  type="text" 
                  id="reference"
                  formControlName="reference"
                  class="form-control"
                  placeholder="e.g., PO-12345"
                />
              </div>

              <div class="form-group">
                <label for="remarks">Remarks</label>
                <textarea 
                  id="remarks"
                  formControlName="remarks"
                  class="form-control"
                  rows="3"
                  placeholder="Additional notes..."
                ></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeRestockModal()" [disabled]="restocking">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="restocking || restockForm.invalid">
                <span *ngIf="restocking">Restocking...</span>
                <span *ngIf="!restocking">Restock Material</span>
              </button>
            </div>
          </form>
        </div>
      </div>
  </div>
</div>

