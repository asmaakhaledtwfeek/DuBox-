<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="create-project-page">
  <div class="page-container">
    <main class="main-content">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a routerLink="/projects" class="breadcrumb-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          Projects
        </a>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="breadcrumb-separator">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
        <span class="breadcrumb-item active">{{ isEdit ? 'Edit Project' : 'Create Project' }}</span>
      </nav>

      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-icon">
            <svg *ngIf="!isEdit" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="16"/>
              <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
            <svg *ngIf="isEdit" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </div>
          <div>
            <h1 class="page-title">{{ isEdit ? 'Edit Project' : 'Create New Project' }}</h1>
            <p class="page-subtitle">{{ isEdit ? 'Update project information and settings' : 'Add a new construction project to the system' }}</p>
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div *ngIf="successMessage" class="alert alert-success">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        {{ successMessage }}
      </div>

      <div *ngIf="initializing" class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        Loading project details...
      </div>

      <div *ngIf="error" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 8v4M12 16h.01"/>
        </svg>
        {{ error }}
      </div>

      <!-- Form Container -->
      <div class="form-container">
        <form [formGroup]="projectForm" (ngSubmit)="onSubmit()">
          
          <!-- Basic Information Section -->
          <div class="form-section">
            <div class="section-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              <div>
                <h3 class="section-title">Project Information</h3>
                <p class="section-description">Basic details and identification</p>
              </div>
            </div>

            <div class="form-grid">
              <!-- Project Name -->
              <div class="form-group">
                <label for="projectName">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  </svg>
                  Project Name <span class="required">*</span>
                </label>
                <input
                  id="projectName"
                  type="text"
                  formControlName="projectName"
                  class="form-control"
                  placeholder="e.g., Dubai Marina Tower Construction"
                  [class.invalid]="isFieldInvalid('projectName')"
                  (blur)="capitalizeProjectName()"
                />
                <div class="error-text" *ngIf="isFieldInvalid('projectName')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('projectName') }}
                </div>
              </div>

              <!-- Project Code -->
              <div class="form-group">
                <label for="projectCode">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7V5c0-1.1.9-2 2-2h2"/>
                    <path d="M17 3h2c1.1 0 2 .9 2 2v2"/>
                    <path d="M21 17v2c0 1.1-.9 2-2 2h-2"/>
                    <path d="M7 21H5c-1.1 0-2-.9-2-2v-2"/>
                    <rect x="7" y="7" width="10" height="10" rx="1"/>
                  </svg>
                  Project Code <span class="required">*</span>
                  <span class="readonly-badge" *ngIf="isEdit">(Read-only)</span>
                </label>
                <input
                  id="projectCode"
                  type="text"
                  formControlName="projectCode"
                  class="form-control"
                  placeholder="e.g., DUB-2024-001"
                  [class.invalid]="isFieldInvalid('projectCode')"
                  [disabled]="isEdit"
                  [hidden]="isEdit"
                />
                <div *ngIf="isEdit" class="form-control readonly-field">
                  {{ projectForm.get('projectCode')?.value }}
                </div>
                <div class="error-text" *ngIf="isFieldInvalid('projectCode')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('projectCode') }}
                </div>
                <small class="field-hint" *ngIf="isEdit">Project code cannot be changed after creation.</small>
              </div>

              <!-- Client Name -->
              <div class="form-group">
                <label for="clientName">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                  Client Name
                </label>
                <input
                  id="clientName"
                  type="text"
                  formControlName="clientName"
                  class="form-control"
                  placeholder="e.g., Amana Contracting"
                  [class.invalid]="isFieldInvalid('clientName')"
                  (blur)="capitalizeClientName()"
                />
                <div class="error-text" *ngIf="isFieldInvalid('clientName')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('clientName') }}
                </div>
              </div>

              <!-- Location -->
              <div class="form-group">
                <label for="location">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  Location <span class="required">*</span>
                  <span class="readonly-badge" *ngIf="isEdit">(Read-only)</span>
                </label>
                <select
                  id="location"
                  *ngIf="!isEdit"
                  formControlName="location"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('location')"
                >
                  <option [ngValue]="null">Select Location</option>
                  <option *ngFor="let loc of locations" [ngValue]="loc.value">{{ loc.label }}</option>
                </select>
                <div *ngIf="isEdit" class="form-control readonly-field">
                  {{ getLocationLabel(projectForm.get('location')?.value) }}
                </div>
                
                <input type="hidden" formControlName="location" />
                <div class="error-text" *ngIf="isFieldInvalid('location')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('location') }}
                </div>
                <small class="field-hint" *ngIf="isEdit">Location cannot be changed after creation.</small>
              </div>

             
            </div>
          </div>

          <!-- Timeline Section -->
          <div class="form-section">
            <div class="section-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              <div>
                <h3 class="section-title">Timeline & Schedule</h3>
                <p class="section-description">Project start date and duration</p>
              </div>
            </div>

            <div class="form-grid">
              <!-- Planned Start Date -->
              <div class="form-group">
                <label for="plannedStartDate">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  Planned Start Date <span class="required">*</span>
                </label>
                <input
                  id="plannedStartDate"
                  type="date"
                  formControlName="plannedStartDate"
                  class="form-control"
                  [min]="minStartDate"
                  [max]="maxStartDate"
                  [class.invalid]="isFieldInvalid('plannedStartDate')"
                />
                <div class="error-text" *ngIf="isFieldInvalid('plannedStartDate')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('plannedStartDate') }}
                </div>
              </div>

              <!-- Duration -->
              <div class="form-group">
                <label for="duration">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                  </svg>
                  Duration (days)
                </label>
                <input
                  id="duration"
                  type="number"
                  formControlName="duration"
                  class="form-control"
                  min="1"
                  placeholder="e.g., 180"
                  [class.invalid]="isFieldInvalid('duration')"
                />
                <div class="error-text" *ngIf="isFieldInvalid('duration')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('duration') }}
                </div>
                <small class="field-hint">Auto-calculated when Projected End Date is set</small>
              </div>

              <!-- Projected End Date -->
              <div class="form-group">
                <label for="projectedEndDate">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  Projected End Date
                </label>
                <input
                  id="projectedEndDate"
                  type="date"
                  formControlName="projectedEndDate"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('projectedEndDate')"
                />
                <div class="error-text" *ngIf="isFieldInvalid('projectedEndDate')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('projectedEndDate') }}
                </div>
                <small class="field-hint">Auto-calculated when Duration is set</small>
              </div>

              <!-- Project Value -->
              <div class="form-group">
                <label for="projectValue">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                  </svg>
                  Project Value
                </label>
                <input
                  id="projectValue"
                  type="number"
                  formControlName="projectValue"
                  class="form-control"
                  min="0"
                  step="0.01"
                  placeholder="e.g., 5000000"
                  [class.invalid]="isFieldInvalid('projectValue')"
                />
                <div class="error-text" *ngIf="isFieldInvalid('projectValue')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('projectValue') }}
                </div>
                <small class="field-hint">Total estimated project value</small>
              </div>

              <!-- Project Manager -->
              <div class="form-group">
                <label for="projectManager">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                  Project Manager
                </label>
                <!-- Show readonly input if current user is project manager -->
                <input
                  *ngIf="isCurrentUserProjectManager"
                  type="text"
                  class="form-control"
                  [value]="currentUserFullName"
                  readonly
                  style="background-color: #f8fafc; cursor: not-allowed;"
                />
                
                <!-- Show dropdown for other users or in edit mode -->
                <select
                  *ngIf="!isCurrentUserProjectManager"
                  id="projectManager"
                  formControlName="projectManager"
                  class="form-control"
                  [class.invalid]="isFieldInvalid('projectManager')"
                  [disabled]="loadingProjectManagers"
                >
                  <option [ngValue]="null">{{ loadingProjectManagers ? 'Loading...' : 'Select project manager' }}</option>
                  <option *ngFor="let manager of projectManagers" [ngValue]="manager.userId">
                    {{ manager.fullName }} ({{ manager.email }})
                  </option>
                </select>
                
                <small *ngIf="isCurrentUserProjectManager" class="helper-text" style="color: #64748b; margin-top: 4px; display: block;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  You are automatically assigned as the project manager for this project.
                </small>
                <div class="error-text" *ngIf="isFieldInvalid('projectManager')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('projectManager') }}
                </div>
                <small class="field-hint">Assigned project manager</small>
              </div>
            </div>
          </div>

          <!-- Description Section -->
          <div class="form-section">
            <div class="section-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
              <div>
                <h3 class="section-title">Additional Details</h3>
                <p class="section-description">Description and notes about the project</p>
              </div>
            </div>

            <div class="form-grid">
              <!-- Description -->
              <div class="form-group full-width">
                <label for="description">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="17" y1="10" x2="3" y2="10"/>
                    <line x1="21" y1="6" x2="3" y2="6"/>
                    <line x1="21" y1="14" x2="3" y2="14"/>
                    <line x1="17" y1="18" x2="3" y2="18"/>
                  </svg>
                  Project Description
                </label>
                <textarea
                  id="description"
                  formControlName="description"
                  class="form-control"
                  rows="4"
                  placeholder="Enter a detailed description of the project scope, objectives, and key deliverables..."
                  [class.invalid]="isFieldInvalid('description')"
                ></textarea>
                <div class="error-text" *ngIf="isFieldInvalid('description')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('description') }}
                </div>
              </div>

              <!-- BIM Link -->
              <div class="form-group full-width">
                <label for="bimLink">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                  </svg>
                  BIM Link
                </label>
                <input
                  id="bimLink"
                  type="url"
                  formControlName="bimLink"
                  class="form-control"
                  placeholder="https://example.com/bim-model"
                  [class.invalid]="isFieldInvalid('bimLink')"
                />
                <div class="error-text" *ngIf="isFieldInvalid('bimLink')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  {{ getFieldError('bimLink') }}
                </div>
              </div>
            </div>
          </div>

          <!-- Project Configuration Section -->
          <div class="form-section config-section">
            <div class="section-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <polyline points="2 17 12 22 22 17"/>
                <polyline points="2 12 12 17 22 12"/>
              </svg>
              <div>
                <h3 class="section-title">Project Configuration</h3>
                <p class="section-description">Add items one at a time or multiple comma-separated values (press Enter or click Add) - Optional</p>
              </div>
            </div>

            <!-- Buildings -->
            <div class="config-item">
              <label class="config-label">Building Numbers</label>
              <div class="add-row">
                <input 
                  type="text" 
                  [(ngModel)]="newBuilding" 
                  [ngModelOptions]="{standalone: true}"
                  placeholder="e.g., B01, B02, B03" 
                  class="form-control config-input"
                  (input)="onBuildingInput($event)"
                  (blur)="capitalizeBuildingInput()"
                  (keydown.enter)="$event.preventDefault(); addBuilding()"
                />
                <button type="button" class="btn-config-add" (click)="addBuilding()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Add
                </button>
              </div>
              <div class="chips-container">
                <div class="chip" *ngFor="let building of buildings; let i = index">
                  <span>{{ building.buildingCode }}</span>
                  <button type="button" class="chip-remove" (click)="removeBuilding(i)">×</button>
                </div>
                <span class="empty-hint" *ngIf="buildings.length === 0">No buildings added</span>
              </div>
            </div>

            <!-- Levels/Floors -->
            <div class="config-item">
              <label class="config-label">Building Levels/Floors</label>
              <div class="add-row">
                <input 
                  type="text" 
                  [(ngModel)]="newLevel" 
                  [ngModelOptions]="{standalone: true}"
                  placeholder="e.g., GF, 1F, 2F, 3F" 
                  class="form-control config-input"
                  (input)="onLevelInput($event)"
                  (blur)="capitalizeLevelInput()"
                  (keydown.enter)="$event.preventDefault(); addLevel()"
                />
                <button type="button" class="btn-config-add" (click)="addLevel()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Add
                </button>
              </div>
              <div class="chips-container">
                <div class="chip" *ngFor="let level of levels; let i = index">
                  <span>{{ level.levelCode }}</span>
                  <button type="button" class="chip-remove" (click)="removeLevel(i)">×</button>
                </div>
                <span class="empty-hint" *ngIf="levels.length === 0">No levels added</span>
              </div>
            </div>

            <!-- Box Types -->
            <div class="config-item">
              <label class="config-label">Box Types</label>
              <div class="add-row">
                <input 
                  type="text" 
                  [(ngModel)]="newBoxType" 
                  [ngModelOptions]="{standalone: true}"
                  placeholder="e.g., S1, S2, S3, S4" 
                  class="form-control config-input"
                  (input)="onBoxTypeInput($event)"
                  (blur)="capitalizeBoxTypeInput()"
                  (keydown.enter)="$event.preventDefault(); addBoxType()"
                />
                <button type="button" class="btn-config-add" (click)="addBoxType()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Add
                </button>
              </div>
              <div class="type-cards">
                <div class="type-card" *ngFor="let type of boxTypes; let i = index">
                  <div class="type-header">
                    <span class="type-name">{{ type.typeName }}</span>
                    <div class="type-actions">
                      <label class="checkbox-inline">
                        <input 
                          type="checkbox" 
                          [checked]="type.hasSubTypes" 
                          (change)="toggleHasSubTypes(i)"
                        />
                        <span>Has Sub-Types</span>
                      </label>
                      <button type="button" class="btn-remove-type" (click)="removeBoxType(i)">×</button>
                    </div>
                  </div>
                  <div class="subtype-section" *ngIf="type.hasSubTypes">
                    <div class="add-row-sm">
                      <input 
                        type="text" 
                        [(ngModel)]="newBoxSubTypes[i]" 
                        [ngModelOptions]="{standalone: true}"
                        placeholder="e.g., Type A, Type B, Type C" 
                        class="form-control config-input-sm"
                        (input)="onSubTypeInput($event, i)"
                        (blur)="capitalizeSubTypeInput(i)"
                        (keydown.enter)="$event.preventDefault(); addSubType(i)"
                        (focus)="selectedTypeForSubType = i"
                      />
                      <button 
                        type="button" 
                        class="btn-config-add-sm" 
                        (click)="addSubType(i)"
                        [disabled]="selectedTypeForSubType !== i || !newBoxSubTypes[i]?.trim()"
                      >
                        Add
                      </button>
                    </div>
                    <div class="chips-container-sm">
                      <div class="chip-sm" *ngFor="let subType of type.subTypes; let j = index">
                        <span>{{ subType.subTypeName }}</span>
                        <button type="button" class="chip-remove" (click)="removeSubType(i, j)">×</button>
                      </div>
                      <span class="empty-hint-sm" *ngIf="!type.subTypes || type.subTypes.length === 0">No sub-types</span>
                    </div>
                  </div>
                </div>
                <span class="empty-hint" *ngIf="boxTypes.length === 0">No box types added</span>
              </div>
            </div>

            <!-- Zones -->
            <div class="config-item">
              <label class="config-label">Zones</label>
              <div class="add-row">
                <input 
                  type="text" 
                  [(ngModel)]="newZone" 
                  [ngModelOptions]="{standalone: true}"
                  placeholder="e.g., Zone A, Zone B, Zone C" 
                  class="form-control config-input"
                  (input)="onZoneInput($event)"
                  (blur)="capitalizeZoneInput()"
                  (keydown.enter)="$event.preventDefault(); addZone()"
                />
                <button type="button" class="btn-config-add" (click)="addZone()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Add
                </button>
              </div>
              <div class="chips-container">
                <div class="chip" *ngFor="let zone of zones; let i = index">
                  <span>{{ zone.zoneCode }}</span>
                  <button type="button" class="chip-remove" (click)="removeZone(i)">×</button>
                </div>
                <span class="empty-hint" *ngIf="zones.length === 0">No zones added</span>
              </div>
            </div>

            <!-- Box Functions -->
            <div class="config-item">
              <label class="config-label">Box Functions</label>
              <div class="add-row">
                <input 
                  type="text" 
                  [(ngModel)]="newBoxFunction" 
                  [ngModelOptions]="{standalone: true}"
                  placeholder="e.g., Storage, Distribution, Assembly" 
                  class="form-control config-input"
                  (input)="onBoxFunctionInput($event)"
                  (blur)="capitalizeBoxFunctionInput()"
                  (keydown.enter)="$event.preventDefault(); addBoxFunction()"
                />
                <button type="button" class="btn-config-add" (click)="addBoxFunction()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Add
                </button>
              </div>
              <div class="chips-container">
                <div class="chip" *ngFor="let func of boxFunctions; let i = index">
                  <span>{{ func.functionName }}</span>
                  <button type="button" class="chip-remove" (click)="removeBoxFunction(i)">×</button>
                </div>
                <span class="empty-hint" *ngIf="boxFunctions.length === 0">No functions added</span>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="loading || initializing">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="loading || initializing">
              <span class="spinner" *ngIf="loading"></span>
              <svg *ngIf="!loading" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
              </svg>
              <span *ngIf="!loading">{{ isEdit ? 'Save Changes' : 'Create Project' }}</span>
              <span *ngIf="loading">{{ isEdit ? 'Saving...' : 'Creating...' }}</span>
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>
</div>

