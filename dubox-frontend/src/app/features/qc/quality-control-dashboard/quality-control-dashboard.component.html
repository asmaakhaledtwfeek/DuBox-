<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <div class="title-section">
          <h1 class="page-title">QA/QC Workspace</h1>
          <p class="page-subtitle">Monitor checkpoints and track quality issues for all issues in a single view.</p>
        </div>
      </div>
      <div class="header-right" *ngIf="isSystemAdmin">
        <button class="btn btn-admin" routerLink="/qc/predefined-checklists">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          Manage Predefined Checklists
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button 
        class="tab" 
        [class.active]="activeTab === 'checkpoints'"
        (click)="setTab('checkpoints')"
      >
        WIR (Checkpoints)
      </button>
      <button 
        class="tab" 
        [class.active]="activeTab === 'quality-issues'"
        (click)="setTab('quality-issues')"
      >
        Quality Issues
      </button>
    </div>

    <!-- Summary Cards -->
    <div class="qc-summary-grid">
      <div class="summary-card" *ngFor="let card of summaryCards" [class]="'tone-' + card.tone">
        <p>{{ card.label }}</p>
        <strong>{{ card.value }}</strong>
      </div>
    </div>

    <!-- Checkpoints Tab Content -->
    <div *ngIf="activeTab === 'checkpoints'" class="qc-panel">
      <!-- Filters -->
      <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filter-row">
        <div class="field">
          <label>WIR Number</label>
          <input type="text" formControlName="wirNumber" placeholder="e.g. MBI-12" />
        </div>
        <div class="field">
          <label>Box Tag</label>
          <input type="text" formControlName="boxTag" placeholder="e.g. B-12" />
        </div>
        <div class="field">
          <label>Project Code</label>
          <input type="text" formControlName="projectCode" placeholder="e.g. PROJ-001" />
        </div>
        <div class="field">
          <label>Status</label>
          <select formControlName="status">
            <option value="">All</option>
            <option *ngFor="let status of statusOptions" [value]="status">{{ getStatusLabel(status) }}</option>
          </select>
        </div>
        <div class="field">
          <label>From Date</label>
          <input type="date" formControlName="from" />
        </div>
        <div class="field">
          <label>To Date</label>
          <input type="date" formControlName="to" />
        </div>
        <div class="filter-actions">
          <button type="button" class="btn btn-secondary" (click)="resetFilters()">Reset</button>
          <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
      </form>

      <!-- Checkpoints Table -->
      <div class="quality-table-wrapper">
        <div class="table-state" *ngIf="checkpointsLoading">
          <div class="spinner"></div>
          <p>Loading checkpoints...</p>
        </div>

        <div class="table-state error" *ngIf="!checkpointsLoading && checkpointsError">
          <p>{{ checkpointsError }}</p>
          <button class="btn btn-primary" (click)="fetchCheckpoints()">Retry</button>
        </div>

        <table class="designer-table" *ngIf="!checkpointsLoading && !checkpointsError && checkpoints.length > 0">
          <thead>
            <tr>
              <th>WIR Number</th>
              <th>Box</th>
              <th>Project</th>
              <th>Status</th>
              <th>Requested Date</th>
              <th *ngIf="canManageWIRCheckpoints">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let checkpoint of checkpoints">
              <td>
                <strong>{{ checkpoint.wirNumber }}</strong>
               <!--<div class="text-muted" *ngIf="checkpoint.wirName">{{ checkpoint.wirName }}</div>-->
              </td>
              <td>
                <div>{{ checkpoint.box?.boxTag || '—' }}</div>
                <div class="text-muted">{{ checkpoint.box?.boxName || '—' }}</div>
              </td>
              <td>
               
                <div class="text-muted" *ngIf="checkpoint.projectName">{{ checkpoint.projectName }}</div>
              </td>
              <td>
                <span class="status-pill" [ngClass]="getCheckpointStatusClass(checkpoint.status)">
                  {{ getStatusLabel(checkpoint.status) }}
                </span>
              </td>
              <td>{{ formatDate(checkpoint.requestedDate) }}</td>
              <td class="col-actions" *ngIf="canManageWIRCheckpoints">
                <div class="action-stack">
                  <button 
                    class="action-btn ghost" 
                    *ngIf="canNavigateToAddChecklist(checkpoint)"
                    (click)="onAddChecklist(checkpoint)"
                    title="Add Checklist Items"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                  <button 
                    class="action-btn primary" 
                    *ngIf="canNavigateToReview(checkpoint)"
                    (click)="onReviewCheckpoint(checkpoint)"
                    title="Review Checkpoint"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                      <polyline points="10 9 9 9 8 9"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="table-state" *ngIf="!checkpointsLoading && !checkpointsError && checkpoints.length === 0">
          <p>No checkpoints found.</p>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container" *ngIf="!checkpointsLoading && !checkpointsError && checkpointsTotalPages > 0">
          <div class="pagination-info">
            <span>Showing {{ (checkpointsCurrentPage - 1) * checkpointsPageSize + 1 }} - {{ Math.min(checkpointsCurrentPage * checkpointsPageSize, checkpointsTotalCount) }} of {{ checkpointsTotalCount }} checkpoints</span>
            <div class="page-size-selector">
              <label for="checkpointsPageSize">Items per page:</label>
              <select id="checkpointsPageSize" [ngModel]="checkpointsPageSize" (ngModelChange)="onCheckpointsPageSizeChange($event)" class="page-size-select" [ngModelOptions]="{standalone: true}">
                <option [value]="10">10</option>
                <option [value]="25">25</option>
                <option [value]="50">50</option>
                <option [value]="100">100</option>
              </select>
            </div>
          </div>
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              [disabled]="checkpointsCurrentPage === 1"
              (click)="onCheckpointsPageChange(1)"
              title="First page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="11 17 6 12 11 7"/>
                <polyline points="18 17 13 12 18 7"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              [disabled]="checkpointsCurrentPage === 1"
              (click)="onCheckpointsPageChange(checkpointsCurrentPage - 1)"
              title="Previous page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
              </svg>
            </button>
            <div class="page-numbers">
              <button 
                *ngFor="let page of getCheckpointsPageNumbers()"
                class="page-number"
                [class.active]="page === checkpointsCurrentPage"
                (click)="onCheckpointsPageChange(page)"
              >
                {{ page }}
              </button>
            </div>
            <button 
              class="pagination-btn" 
              [disabled]="checkpointsCurrentPage === checkpointsTotalPages"
              (click)="onCheckpointsPageChange(checkpointsCurrentPage + 1)"
              title="Next page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              [disabled]="checkpointsCurrentPage === checkpointsTotalPages"
              (click)="onCheckpointsPageChange(checkpointsTotalPages)"
              title="Last page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="13 17 18 12 13 7"/>
                <polyline points="6 17 11 12 6 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Quality Issues Tab Content -->
    <div *ngIf="activeTab === 'quality-issues'" class="qc-panel">
      <!-- Filters -->
      <form [formGroup]="qualityIssuesFilterForm" class="filter-row">
        <div class="field">
          <label>WIR Number</label>
          <input type="text" formControlName="wirNumber" placeholder="e.g. MBI-12" />
        </div>
        <div class="field">
          <label>Box Tag</label>
          <input type="text" formControlName="boxTag" placeholder="e.g. B-12" />
        </div>
        <div class="field">
          <label>Project Code</label>
          <input type="text" formControlName="projectCode" placeholder="e.g. PROJ-001" />
        </div>
        <div class="field">
          <label>Status</label>
          <select formControlName="status">
            <option value="">All</option>
            <option *ngFor="let status of qualityIssueStatuses" [value]="status">{{ getQualityIssueStatusLabel(status) }}</option>
          </select>
        </div>
        <div class="field">
          <label>Issue Type</label>
          <select formControlName="issueType">
            <option value="">All</option>
            <option value="Defect">Defect</option>
            <option value="NonConformance">Non-Conformance</option>
            <option value="Observation">Observation</option>
          </select>
        </div>
        <div class="field">
          <label>Severity</label>
          <select formControlName="severity">
            <option value="">All</option>
            <option value="Critical">Critical</option>
            <option value="Major">Major</option>
            <option value="Minor">Minor</option>
          </select>
        </div>
        <div class="filter-actions">
          <button type="button" class="btn btn-secondary" (click)="resetQualityIssuesFilters()">Reset</button>
        </div>
      </form>

      <!-- Quality Issues Table -->
      <div class="quality-table-wrapper">
        <div class="table-state" *ngIf="qualityIssuesLoading">
          <div class="spinner"></div>
          <p>Loading quality issues...</p>
        </div>

        <div class="table-state error" *ngIf="!qualityIssuesLoading && qualityIssuesError">
          <p>{{ qualityIssuesError }}</p>
          <button class="btn btn-primary" (click)="fetchCheckpoints()">Retry</button>
        </div>

        <div class="table-header-actions" *ngIf="!qualityIssuesLoading && !qualityIssuesError && qualityIssues.length > 0">
          <button class="btn btn-primary" (click)="exportQualityIssuesToExcel()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export to Excel
          </button>
        </div>

        <table class="designer-table" *ngIf="!qualityIssuesLoading && !qualityIssuesError && qualityIssues.length > 0">
          <thead>
            <tr>
              <th>Status</th>
              <th>Issue Date</th>
              <th>Type</th>
              <th>Severity</th>
              <th>Project</th>
              <th>Box</th>
              <th>WIR</th>
              <th>Assigned To</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let issue of qualityIssues">
              <td>
                <span class="status-pill" [ngClass]="getQualityIssueStatusClass(issue.issueStatus || issue.status)">
                  {{ getQualityIssueStatusLabel(issue.issueStatus || issue.status) }}
                </span>
              </td>
              <td>{{ formatIssueDate(issue.issueDate) }}</td>
              <td>{{ issue.issueType || '—' }}</td>
              <td>{{ issue.severity || '—' }}</td>
              <td>
                <div class="text-truncate" [title]="issue.projectName || '—'">
                  {{ issue.projectName || '—' }}
                </div>
              </td>
              <td>
                <div>{{ issue.boxTag || '—' }}</div>
                <div class="text-muted">{{ issue.boxName || '—' }}</div>
              </td>
              <td>
                <div>{{ issue.wirNumber || '—' }}</div>
                <div class="text-muted" *ngIf="issue.wirName">{{ issue.wirName }}</div>
              </td>
              <td>
                <div class="text-truncate" [title]="issue.assignedTeamName || '—'">
                  {{ issue.assignedTeamName || '—' }}
                </div>
              </td>
              <td class="col-actions">
                <div class="action-stack">
                  <button 
                    class="action-btn ghost" 
                    (click)="openIssueDetails(issue)"
                    title="View Details"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                  <button 
                    class="action-btn assign" 
                    (click)="openAssignModal(issue); $event.stopPropagation()"
                    title="Assign to Team"
                    *ngIf="canUpdateQualityIssueStatus && canPerformQualityIssueActions(issue)"
                    type="button"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                      <circle cx="9" cy="7" r="4"/>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                  </button>
                  <button 
                    class="action-btn primary" 
                    (click)="openStatusModal(issue)"
                    title="Update Status"
                    *ngIf="canUpdateQualityIssueStatus && canPerformQualityIssueActions(issue)"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="table-state" *ngIf="!qualityIssuesLoading && !qualityIssuesError && qualityIssues.length === 0">
          <p>No quality issues found.</p>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container" *ngIf="!qualityIssuesLoading && !qualityIssuesError && qualityIssuesTotalPages > 0">
          <div class="pagination-info">
            <span>Showing {{ (qualityIssuesCurrentPage - 1) * qualityIssuesPageSize + 1 }} - {{ Math.min(qualityIssuesCurrentPage * qualityIssuesPageSize, qualityIssuesTotalCount) }} of {{ qualityIssuesTotalCount }} issues</span>
            <div class="page-size-selector">
              <label for="qualityIssuesPageSize">Items per page:</label>
              <select id="qualityIssuesPageSize" [ngModel]="qualityIssuesPageSize" (ngModelChange)="onQualityIssuesPageSizeChange($event)" class="page-size-select" [ngModelOptions]="{standalone: true}">
                <option [value]="10">10</option>
                <option [value]="25">25</option>
                <option [value]="50">50</option>
                <option [value]="100">100</option>
              </select>
            </div>
          </div>
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              [disabled]="qualityIssuesCurrentPage === 1"
              (click)="onQualityIssuesPageChange(1)"
              title="First page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="11 17 6 12 11 7"/>
                <polyline points="18 17 13 12 18 7"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              [disabled]="qualityIssuesCurrentPage === 1"
              (click)="onQualityIssuesPageChange(qualityIssuesCurrentPage - 1)"
              title="Previous page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
              </svg>
            </button>
            <div class="page-numbers">
              <button 
                *ngFor="let page of getQualityIssuesPageNumbers()"
                class="page-number"
                [class.active]="page === qualityIssuesCurrentPage"
                (click)="onQualityIssuesPageChange(page)"
              >
                {{ page }}
              </button>
            </div>
            <button 
              class="pagination-btn" 
              [disabled]="qualityIssuesCurrentPage === qualityIssuesTotalPages"
              (click)="onQualityIssuesPageChange(qualityIssuesCurrentPage + 1)"
              title="Next page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              [disabled]="qualityIssuesCurrentPage === qualityIssuesTotalPages"
              (click)="onQualityIssuesPageChange(qualityIssuesTotalPages)"
              title="Last page"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="13 17 18 12 13 7"/>
                <polyline points="6 17 11 12 6 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<div class="status-modal-backdrop" *ngIf="isStatusModalOpen && selectedIssueForStatus" (click)="closeStatusModal()">
  <div class="status-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-title-section">
          <h3 class="modal-title">Update Issue Status</h3>
          <div class="header-badges">
            <span class="issue-type-badge-small">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
              {{ selectedIssueForStatus.issueType || 'Issue' }}
            </span>
            <span class="severity-badge-small" [ngClass]="'severity-' + (selectedIssueForStatus.severity ? selectedIssueForStatus.severity.toLowerCase() : '')">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="selectedIssueForStatus.severity && selectedIssueForStatus.severity.toLowerCase() === 'critical'">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="selectedIssueForStatus.severity && selectedIssueForStatus.severity.toLowerCase() === 'major'">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="selectedIssueForStatus.severity && selectedIssueForStatus.severity.toLowerCase() === 'minor'">
                <circle cx="12" cy="12" r="10"/>
              </svg>
              {{ selectedIssueForStatus.severity || '—' }}
            </span>
          </div>
        </div>
      </div>
      <button class="icon-button" (click)="closeStatusModal()" [disabled]="statusUpdateLoading" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <div class="modal-content">
      <div class="modal-body">
      <div class="form-group">
        <label class="modal-label">Status <span class="required">*</span></label>
        <select 
          class="modal-input" 
          [(ngModel)]="statusUpdateForm.status"
          [disabled]="statusUpdateLoading"
        >
          <option *ngFor="let status of qualityIssueStatuses" [value]="status">
            {{ getQualityIssueStatusLabel(status) }}
          </option>
        </select>
      </div>

      <div class="form-group" *ngIf="requiresResolutionDescription(statusUpdateForm.status)">
        <label class="modal-label">Resolution Description <span class="required">*</span></label>
        <textarea 
          class="modal-input" 
          rows="4"
          [(ngModel)]="statusUpdateForm.resolutionDescription"
          [disabled]="statusUpdateLoading"
          placeholder="Describe how this issue was resolved..."
        ></textarea>
      </div>

      <!-- Photo Upload Section -->
      <div class="form-group photo-upload-section">
        <label class="modal-label">Photos / Documents <span class="image-count-badge" *ngIf="selectedImages.length > 0">{{ selectedImages.length }}</span></label>
        <p class="photo-upload-hint">Add multiple images from upload, camera, or URL</p>
        
        <!-- Selected Images Preview List -->
        <div class="selected-images-list" *ngIf="selectedImages.length > 0">
          <div class="image-preview-item" *ngFor="let image of selectedImages; let i = index">
            <div class="image-preview-wrapper">
              <img [src]="image.preview || image.url" [alt]="image.name || 'Image preview'" />
              <button 
                type="button" 
                class="remove-image-btn" 
                (click)="removeImage(image.id)" 
                [disabled]="isUploadingPhoto || statusUpdateLoading"
                title="Remove image"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
              <div class="image-type-badge" [class.type-file]="image.type === 'file' || image.type === 'camera'" [class.type-url]="image.type === 'url'">
                {{ image.type === 'file' || image.type === 'camera' ? 'File' : 'URL' }}
              </div>
            </div>
            <div class="image-info" *ngIf="image.name || image.url">
              <p class="image-name" *ngIf="image.name">{{ image.name }}</p>
              <p class="image-url" *ngIf="image.url">{{ image.url }}</p>
              <p class="image-size" *ngIf="image.file">{{ (image.file.size / 1024).toFixed(1) }} KB</p>
            </div>
          </div>
          <button 
            type="button" 
            class="btn-clear-all" 
            (click)="clearAllImages()" 
            [disabled]="isUploadingPhoto || statusUpdateLoading"
            *ngIf="selectedImages.length > 1"
          >
            Clear All
          </button>
        </div>
        
        <!-- Tabs for different input methods -->
        <div class="photo-input-tabs" *ngIf="!showCamera">
          <button 
            type="button"
            class="tab-button"
            [class.active]="currentImageInputMode === 'url'"
            (click)="currentImageInputMode = 'url'; showCamera = false"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            URL
          </button>
          <button 
            type="button"
            class="tab-button"
            [class.active]="currentImageInputMode === 'upload'"
            (click)="openFileInput(); currentImageInputMode = 'upload'"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Upload
          </button>
          <button 
            type="button"
            class="tab-button"
            [class.active]="currentImageInputMode === 'camera'"
            (click)="openCamera()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Camera
          </button>
        </div>

        <!-- URL Input -->
        <div *ngIf="currentImageInputMode === 'url' && !showCamera" class="photo-input-content">
          <div class="url-input-group">
            <input
              type="text"
              class="form-control"
              placeholder="Enter photo URL (e.g., https://example.com/photo.jpg)"
              [(ngModel)]="currentUrlInput"
              [ngModelOptions]="{standalone: true}"
              [disabled]="isUploadingPhoto || statusUpdateLoading"
              (keydown.enter)="addImageFromUrl(); $event.preventDefault()"
            />
            <button 
              type="button" 
              class="btn-add-url" 
              (click)="addImageFromUrl()"
              [disabled]="isUploadingPhoto || statusUpdateLoading || !currentUrlInput || !currentUrlInput.trim()"
            >
              Add URL
            </button>
          </div>
        </div>

        <!-- File Upload Input (hidden, supports multiple) -->
        <input
          id="issue-photo-file-input"
          type="file"
          accept="image/*"
          multiple
          style="display: none"
          (change)="onFileSelected($event)"
          [disabled]="isUploadingPhoto || statusUpdateLoading"
        />

        <!-- Camera Preview -->
        <div *ngIf="showCamera" id="camera-preview-container" class="camera-preview-container">
          <video 
            id="issue-camera-preview" 
            autoplay 
            playsinline 
            muted
            style="display: block; visibility: visible; opacity: 1;"
          ></video>
          <div class="camera-controls">
            <button type="button" class="btn btn-secondary btn-sm" (click)="stopCamera()">
              Cancel
            </button>
            <button type="button" class="btn btn-primary btn-sm" (click)="capturePhoto()" [disabled]="statusUpdateLoading">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
              </svg>
              Capture
            </button>
          </div>
        </div>

        <p class="modal-error" *ngIf="photoUploadError">{{ photoUploadError }}</p>
      </div>

      <p class="modal-error" *ngIf="statusUpdateError">{{ statusUpdateError }}</p>
    </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="closeStatusModal()" [disabled]="statusUpdateLoading">
        Cancel
      </button>
      <button 
        class="btn btn-primary" 
        (click)="submitStatusUpdate()" 
        [disabled]="!canSubmitStatusUpdate() || statusUpdateLoading"
      >
        <span *ngIf="statusUpdateLoading">Updating...</span>
        <span *ngIf="!statusUpdateLoading">Update Status</span>
      </button>
    </div>
  </div>
</div>

<!-- Assign to Team Modal -->
<div class="status-modal-backdrop" *ngIf="isAssignModalOpen" (click)="closeAssignModal()">
  <div class="status-modal" (click)="$event.stopPropagation()" *ngIf="selectedIssueForAssign">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-title-section">
          <h3 class="modal-title">Assign to Team</h3>
          <div class="header-badges">
            <span class="issue-type-badge-small">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
              {{ selectedIssueForAssign.issueType || 'Issue' }}
            </span>
            <span class="severity-badge-small" [ngClass]="'severity-' + (selectedIssueForAssign.severity ? selectedIssueForAssign.severity.toLowerCase() : '')">
              {{ selectedIssueForAssign.severity || '—' }}
            </span>
          </div>
        </div>
      </div>
      <button class="icon-button" (click)="closeAssignModal()" [disabled]="assignLoading" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <div class="modal-content">
      <div class="modal-body">
        <div class="form-group">
          <label class="modal-label">Assign to Team</label>
          <select 
            class="modal-input" 
            [(ngModel)]="selectedTeamId"
            [disabled]="assignLoading || loadingTeams"
          >
            <option [value]="null">Unassign (No Team)</option>
            <option *ngFor="let team of availableTeams" [value]="team.teamId">
              {{ team.teamName }} ({{ team.teamCode }})
            </option>
          </select>
          <div class="loading-text" *ngIf="loadingTeams">Loading teams...</div>
          <small class="helper-text" *ngIf="!loadingTeams && availableTeams.length === 0">
            No teams available. Please contact your administrator.
          </small>
        </div>

        <div class="current-assignment" *ngIf="selectedIssueForAssign?.assignedTeamName">
          <p class="info-text">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            Currently assigned to: <strong>{{ selectedIssueForAssign.assignedTeamName }}</strong>
          </p>
        </div>

        <p class="modal-error" *ngIf="assignError">{{ assignError }}</p>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="closeAssignModal()" [disabled]="assignLoading">
        Cancel
      </button>
      <button 
        class="btn btn-primary" 
        (click)="assignIssueToTeam()" 
        [disabled]="assignLoading || loadingTeams"
      >
        <span *ngIf="assignLoading">Assigning...</span>
        <span *ngIf="!assignLoading">{{ selectedTeamId ? 'Assign' : 'Unassign' }}</span>
      </button>
    </div>
  </div>
</div>

<!-- Quality Issue Details Modal -->
<app-quality-issue-details-modal
  [issue]="selectedIssueDetails"
  [wirCheckpoints]="checkpoints"
  [isOpen]="isDetailsModalOpen"
  (close)="closeIssueDetails()"
></app-quality-issue-details-modal>
