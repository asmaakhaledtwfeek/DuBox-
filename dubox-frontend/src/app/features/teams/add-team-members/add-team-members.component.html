<app-header></app-header>
<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="page-content">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading crew information...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 8v4M12 16h.01"/>
      </svg>
      <p>{{ error }}</p>
      <button class="btn btn-secondary" (click)="onCancel()">Back to Crew</button>
    </div>

    <!-- Form Content -->
    <div *ngIf="!loading && team" class="form-container">
      <!-- Page Header -->
      <div class="page-header">
        <button class="btn-back" (click)="onCancel()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Back to Crew
        </button>
        <div class="header-content">
          <div class="header-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
          <div>
            <h1 class="page-title">Add Members to Crew</h1>
            <p class="page-subtitle">{{ team.teamName }} ({{ team.teamCode }}) â€¢ {{ team.departmentName }}</p>
          </div>
        </div>
      </div>

      <!-- Info Message -->
      <div class="info-message">
        <div class="alert-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
          </svg>
        </div>
        <div class="alert-content">
          <div class="alert-title">Department Filter</div>
          <div class="alert-message">Only users from the same department ({{ team.departmentName }}) are available for selection.</div>
        </div>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="success-message">
        <div class="alert-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <div class="alert-content">
          <div class="alert-title">Success!</div>
          <div class="alert-message">{{ successMessage }}</div>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="error && !loading" class="error-message">
        <div class="alert-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
        </div>
        <div class="alert-content">
          <div class="alert-title">Error</div>
          <div class="alert-message">{{ error }}</div>
        </div>
      </div>

      <!-- Users List -->
      <div class="users-section">
        <div class="section-header">
          <div>
            <h2 class="section-title">Available Users</h2>
            <p class="section-description">Select users to add to this crew</p>
          </div>
          <span class="selection-count" [class.has-selection]="getSelectedCount() > 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            {{ getSelectedCount() }} selected
          </span>
        </div>

        <!-- Search Section -->
        <div class="search-section">
          <div class="search-wrapper">
            <span class="search-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
            </span>
            <input 
              type="text" 
              class="search-input" 
              placeholder="Search by name or email..."
              [(ngModel)]="searchTerm"
              (input)="onSearchChange()"
            />
            <button 
              *ngIf="searchTerm" 
              class="clear-search-btn" 
              (click)="clearSearch()"
              type="button"
              aria-label="Clear search"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
          <div *ngIf="searchTerm && filteredUsers.length === 0" class="search-no-results">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            <p>No users found matching "{{ searchTerm }}"</p>
            <button class="btn-link" (click)="clearSearch()">Clear search</button>
          </div>
        </div>

        <div *ngIf="availableUsers.length === 0 && !searchTerm" class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75M13 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0z"/>
          </svg>
          <h3>No Users Available</h3>
          <p>No active users found in the {{ team.departmentName }} department.</p>
        </div>

        <div *ngIf="(searchTerm ? filteredUsers : availableUsers).length > 0" class="users-grid">
          <div 
            *ngFor="let user of (searchTerm ? filteredUsers : availableUsers)" 
            class="user-card"
            [class.selected]="isUserSelected(user.userId)"
            (click)="toggleUserSelection(user.userId)"
          >
            <div class="user-checkbox">
              <input 
                type="checkbox" 
                [checked]="isUserSelected(user.userId)"
                (change)="toggleUserSelection(user.userId)"
                (click)="$event.stopPropagation()"
              />
            </div>
            <div class="user-avatar" [class.selected]="isUserSelected(user.userId)">
              <span class="avatar-initials">{{ getUserInitials(user.fullName || user.email) }}</span>
              <div class="avatar-check-icon" *ngIf="isUserSelected(user.userId)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
            </div>
            <div class="user-info">
              <div class="user-name">{{ user.fullName || user.email }}</div>
              <div class="user-email">{{ user.email }}</div>
              <div class="user-department" *ngIf="user.department">{{ user.department }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn btn-cancel" 
          (click)="onCancel()"
          [disabled]="saving"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Cancel
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="onSubmit()"
          [disabled]="saving || selectedUserIds.length === 0"
        >
          <svg *ngIf="!saving" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <svg *ngIf="saving" class="spinner-btn" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="2" x2="12" y2="6"/>
            <line x1="12" y1="18" x2="12" y2="22"/>
            <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/>
            <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/>
            <line x1="2" y1="12" x2="6" y2="12"/>
            <line x1="18" y1="12" x2="22" y2="12"/>
            <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/>
            <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
          </svg>
          <span *ngIf="saving">Adding Members...</span>
          <span *ngIf="!saving">Add {{ getSelectedCount() }} Member(s)</span>
        </button>
      </div>
    </div>
  </div>
</div>


