<div class="comments-container">
  <!-- Header -->
  <div class="comments-header">
    <h3 class="comments-title">
      <i class="bi bi-chat-left-text"></i>
      Comments & Discussion
    </h3>
    <span class="comments-count">{{ comments.length }} comment{{ comments.length !== 1 ? 's' : '' }}</span>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading comments...</span>
    </div>
  </div>

  <!-- Comments List -->
  <div *ngIf="!loading" class="comments-list">
    <!-- Empty State -->
    <div *ngIf="comments.length === 0" class="empty-state">
      <i class="bi bi-chat-square-dots"></i>
      <p>No comments yet. Be the first to comment!</p>
    </div>

    <!-- Comment Thread -->
    <div *ngFor="let comment of comments" class="comment-thread">
      <div class="comment" [class.status-update-comment]="comment.isStatusUpdateComment">
        <!-- Avatar -->
        <div class="comment-avatar">
          <div class="avatar-circle" [style.background-color]="'#' + (comment.authorId.substring(0, 6))">
            {{ getInitials(comment.authorName) }}
          </div>
        </div>

        <!-- Content -->
        <div class="comment-content">
          <!-- Header -->
          <div class="comment-header">
            <span class="comment-author">{{ comment.authorName }}</span>
            <span class="comment-date">{{ formatDate(comment.createdDate) }}</span>
            <span *ngIf="comment.isEdited" class="edited-badge">(edited)</span>
            <span *ngIf="comment.isStatusUpdateComment" class="status-badge" [ngClass]="getStatusBadgeClass(comment.relatedStatus)">
              <i class="bi bi-arrow-right-circle"></i>
              {{ getStatusLabel(comment.relatedStatus) }}
            </span>
          </div>

          <!-- Body -->
          <div class="comment-body">
            <!-- View Mode -->
            <div *ngIf="editingComment?.commentId !== comment.commentId" class="comment-text">
              {{ comment.commentText }}
            </div>

            <!-- Edit Mode -->
            <div *ngIf="editingComment?.commentId === comment.commentId" class="edit-mode">
              <textarea
                [(ngModel)]="editedCommentText"
                class="form-control"
                rows="3"
                placeholder="Edit your comment..."
              ></textarea>
              <div class="edit-actions">
                <button class="btn btn-sm btn-primary" (click)="saveEdit()">
                  <i class="bi bi-check2"></i> Save
                </button>
                <button class="btn btn-sm btn-outline-secondary" (click)="cancelEdit()">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="comment-actions" *ngIf="!comment.isDeleted">
            <button class="action-btn" (click)="startReply(comment)">
              <i class="bi bi-reply"></i> Reply
            </button>
            <button *ngIf="canEdit(comment)" class="action-btn" (click)="startEdit(comment)">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button *ngIf="canDelete(comment)" class="action-btn text-danger" (click)="deleteComment(comment)">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>

          <!-- Deleted Message -->
          <div *ngIf="comment.isDeleted" class="deleted-message">
            <i class="bi bi-trash"></i> This comment has been deleted
          </div>
        </div>
      </div>

      <!-- Replies (Nested) -->
      <div *ngIf="comment.replies && comment.replies.length > 0" class="replies-container">
        <div *ngFor="let reply of comment.replies" class="comment reply">
          <!-- Avatar -->
          <div class="comment-avatar">
            <div class="avatar-circle" [style.background-color]="'#' + (reply.authorId.substring(0, 6))">
              {{ getInitials(reply.authorName) }}
            </div>
          </div>

          <!-- Content -->
          <div class="comment-content">
            <!-- Header -->
            <div class="comment-header">
              <span class="comment-author">{{ reply.authorName }}</span>
              <span class="comment-date">{{ formatDate(reply.createdDate) }}</span>
              <span *ngIf="reply.isEdited" class="edited-badge">(edited)</span>
            </div>

            <!-- Body -->
            <div class="comment-body">
              <!-- View Mode -->
              <div *ngIf="editingComment?.commentId !== reply.commentId" class="comment-text">
                {{ reply.commentText }}
              </div>

              <!-- Edit Mode -->
              <div *ngIf="editingComment?.commentId === reply.commentId" class="edit-mode">
                <textarea
                  [(ngModel)]="editedCommentText"
                  class="form-control"
                  rows="2"
                  placeholder="Edit your reply..."
                ></textarea>
                <div class="edit-actions">
                  <button class="btn btn-sm btn-primary" (click)="saveEdit()">
                    <i class="bi bi-check2"></i> Save
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="cancelEdit()">
                    Cancel
                  </button>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="comment-actions" *ngIf="!reply.isDeleted">
              <button *ngIf="canEdit(reply)" class="action-btn" (click)="startEdit(reply)">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button *ngIf="canDelete(reply)" class="action-btn text-danger" (click)="deleteComment(reply)">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>

            <!-- Deleted Message -->
            <div *ngIf="reply.isDeleted" class="deleted-message">
              <i class="bi bi-trash"></i> This reply has been deleted
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Comment Form -->
  <div class="add-comment-section">
    <!-- Reply Indicator -->
    <div *ngIf="replyingTo" class="reply-indicator">
      <i class="bi bi-reply"></i>
      Replying to <strong>{{ replyingTo.authorName }}</strong>
      <button class="btn-close-reply" (click)="cancelReply()">
        <i class="bi bi-x"></i>
      </button>
    </div>

    <!-- Comment Input -->
    <div class="comment-input-wrapper">
      <div class="current-user-avatar">
        <div class="avatar-circle">
          {{ getInitials((authService.getUserInfo()?.firstName || '') + ' ' + (authService.getUserInfo()?.lastName || '')) || 'You' }}
        </div>
      </div>
      <div class="input-container">
        <textarea
          [(ngModel)]="newCommentText"
          class="form-control comment-textarea"
          rows="3"
          [placeholder]="replyingTo ? 'Write a reply...' : 'Add a comment...'"
          (keydown.ctrl.enter)="addComment()"
        ></textarea>
        <div class="input-footer">
          <span class="input-hint">
            <i class="bi bi-info-circle"></i>
            Press Ctrl+Enter to post
          </span>
          <button
            class="btn btn-primary"
            (click)="addComment()"
            [disabled]="!newCommentText.trim()"
          >
            <i class="bi bi-send"></i>
            {{ replyingTo ? 'Reply' : 'Comment' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

