<div class="status-modal-backdrop" *ngIf="isOpen && issue" (click)="onBackdropClick()">
  <div class="details-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h3>Quality Issue Details</h3>
        <p class="modal-subtitle">{{ issue.issueType || 'Issue' }} • {{ issue.severity || '—' }}</p>
      </div>
      <button class="icon-button" (click)="onClose()" aria-label="Close modal">&times;</button>
    </div>

    <div class="details-grid">
      <div class="details-row">
        <span class="label">Status</span>
        <span class="value">
          <span class="status-pill" [ngClass]="getQualityIssueStatusClass(issue.status)">
            {{ getQualityIssueStatusLabel(issue.status) }}
          </span>
        </span>
      </div>
      <div class="details-row">
        <span class="label">Reported By</span>
        <span class="value">{{ issue.reportedBy || '—' }}</span>
      </div>
      <div class="details-row">
        <span class="label">Issue Date</span>
        <span class="value">{{ formatIssueDate(issue.issueDate) }}</span>
      </div>
      <div class="details-row">
        <span class="label">Assigned To</span>
        <span class="value">{{ issue.assignedTeamName || '—' }}</span>
      </div>
      <div class="details-row">
        <span class="label">Due Date</span>
        <span class="value">{{ formatIssueDate(issue.dueDate) }}</span>
      </div>
      <div class="details-row" *ngIf="issue.isOverdue">
        <span class="label text-danger">Overdue</span>
        <span class="value text-danger">{{ issue.overdueDays || 0 }} days</span>
      </div>
      <div class="details-row">
        <span class="label">Description</span>
        <span class="value multiline">{{ issue.issueDescription || '—' }}</span>
      </div>
      <div class="details-row">
        <span class="label">Resolution Notes</span>
        <span class="value multiline">{{ issue.resolutionDescription || '—' }}</span>
      </div>
      <div class="details-row">
        <span class="label">Resolution Date</span>
        <span class="value">{{ formatIssueDate(issue.resolutionDate) }}</span>
      </div>
      <div class="details-row">
        <span class="label">Inspector</span>
        <span class="value">{{ issue.inspectorName || '—' }}</span>
      </div>
      <div class="details-row">
        <span class="label">Box</span>
        <span class="value">{{ issue.boxName || issue.boxTag || '—' }}</span>
      </div>
      <div class="details-row">
        <span class="label">WIR</span>
        <span class="value">
          {{ getQualityIssueWir(issue) }}
          <small *ngIf="issue.wirStatus">
            • {{ getWIRCheckpointStatusLabel(issue.wirStatus) }}
          </small>
        </span>
      </div>
      <div class="details-row">
        <span class="label">WIR Requested</span>
        <span class="value">{{ formatIssueDate(issue.wirRequestedDate) }}</span>
      </div>
    </div>

    <!-- Images Section (Last Section) -->
    <div class="images-section" *ngIf="imageUrls.length > 0">
      <div class="images-section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
        <h3>Images</h3>
        <span class="images-count">({{ imageUrls.length }})</span>
      </div>
      <div class="quality-issue-images-gallery">
        <div class="image-item" *ngFor="let imageUrl of imageUrls; let i = index">
          <div class="image-wrapper">
            <img [src]="imageUrl" 
                 [alt]="'Quality issue image ' + (i + 1)"
                 class="image-thumbnail"
                 (click)="openImageInNewTab(imageUrl)"
                 (error)="onImageError($event)"
                 loading="lazy" />
            <div class="image-overlay">
              <button class="image-view-btn" (click)="openImageInNewTab(imageUrl); $event.stopPropagation()" title="View full size">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
              <button class="image-download-btn" (click)="downloadImage(imageUrl); $event.stopPropagation()" title="Download image">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
              </button>
            </div>
            <div class="image-number">{{ i + 1 }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions single">
      <button class="btn btn-secondary" (click)="onClose()">Close</button>
    </div>
  </div>
</div>

