<div class="status-modal-backdrop" *ngIf="isOpen && issue" (click)="onBackdropClick()">
  <div class="details-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>
        <div>
          <h3>Quality Issue Details</h3>
          <div class="header-meta">
            <span class="issue-number" *ngIf="issue.issueNumber">#{{ issue.issueNumber }}</span>
            <span class="separator" *ngIf="issue.issueNumber">•</span>
            <span class="issue-type">{{ issue.issueType || 'Defect' }}</span>
            <span class="separator">•</span>
            <span class="severity" [class.severity-critical]="issue.severity === 'Critical'" 
                                    [class.severity-major]="issue.severity === 'Major'"
                                    [class.severity-minor]="issue.severity === 'Minor'">
              {{ issue.severity || 'MAJOR' }}
            </span>
            <span class="separator">•</span>
            <span class="status-pill" [ngClass]="getQualityIssueStatusClass(issue.status)">
              {{ getQualityIssueStatusLabel(issue.status) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Scrollable Content -->
    <div class="modal-body">
      <!-- Issue Information Section -->
      <div class="info-section">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          <h4>Issue Information</h4>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Reported By</span>
              <span class="info-value">{{ issue.reportedBy || '—' }}</span>
            </div>
          </div>
          <div class="info-item">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Issue Date</span>
              <span class="info-value">{{ formatIssueDate(issue.issueDate) }}</span>
            </div>
          </div>
          <div class="info-item">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Assigned To</span>
              <span class="info-value">
                <span *ngIf="issue.assignedTeamName">{{ issue.assignedTeamName }}</span>
                <span *ngIf="!issue.assignedTeamName && !issue.assignedToUserName">—</span>
                <span class="assigned-member" *ngIf="issue.assignedToUserName" [style.display]="issue.assignedTeamName ? 'block' : 'inline'" [style.marginTop]="issue.assignedTeamName ? '4px' : '0'" [style.fontSize]="'13px'" [style.color]="'#64748b'">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                  {{ issue.assignedToUserName }}
                </span>
              </span>
            </div>
          </div>
          <div class="info-item" *ngIf="issue.ccUserName">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <path d="M20 8v6M23 11h-6"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">CC User</span>
              <span class="info-value">{{ issue.ccUserName }}</span>
            </div>
          </div>
          <div class="info-item" [class.overdue]="issue.isOverdue">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Due Date</span>
              <span class="info-value">
                {{ formatIssueDate(issue.dueDate) }}
                <span class="overdue-badge" *ngIf="issue.isOverdue">
                  Overdue by {{ issue.overdueDays || 0 }} days
                </span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Description Section -->
      <div class="description-section">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          <h4>Description</h4>
        </div>
        <div class="description-content">
          <p>{{ issue.issueDescription || 'No description provided.' }}</p>
        </div>
      </div>

      <!-- Resolution Section -->
      <div class="resolution-section" *ngIf="issue.resolutionDescription || issue.resolutionDate || issue.inspectorName">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 11 12 14 22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          <h4>Resolution</h4>
        </div>
        <div class="info-grid">
          <div class="info-item" *ngIf="issue.resolutionDate">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Resolution Date</span>
              <span class="info-value">{{ formatIssueDate(issue.resolutionDate) }}</span>
            </div>
          </div>
         <!-- <div class="info-item" *ngIf="issue.inspectorName">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Inspector</span>
              <span class="info-value">{{ issue.inspectorName }}</span>
            </div>
          </div>-->
        </div>
        <div class="description-content" *ngIf="issue.resolutionDescription">
          <p>{{ issue.resolutionDescription }}</p>
        </div>
        <div class="description-content" *ngIf="!issue.resolutionDescription">
          <p class="no-data">No resolution notes provided.</p>
        </div>
      </div>

      <!-- Related Information Section -->
      <div class="related-section">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          <h4>Related Information</h4>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Box</span>
              <span class="info-value">
                <span *ngIf="issue.boxTag">{{ issue.boxTag }}</span>
                <span *ngIf="issue.boxTag && issue.boxName"> - </span>
                <span *ngIf="issue.boxName">{{ issue.boxName }}</span>
                <span *ngIf="!issue.boxTag && !issue.boxName">—</span>
              </span>
            </div>
          </div>
          <div class="info-item">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Stage</span>
              <span class="info-value">
                {{ getQualityIssueWir(issue) }}
                <span class="wir-status-badge" *ngIf="issue.wirStatus">
                  {{ getWIRCheckpointStatusLabel(issue.wirStatus) }}
                </span>
              </span>
            </div>
          </div>
          <div class="info-item" *ngIf="issue.wirRequestedDate">
            <div class="info-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
            </div>
            <div class="info-content">
              <span class="info-label">Stage Requested</span>
              <span class="info-value">{{ formatIssueDate(issue.wirRequestedDate) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Images Section -->
      <div class="images-section" *ngIf="imageUrls.length > 0">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          <h4>Attached Images</h4>
          <span class="images-count">{{ imageUrls.length }}</span>
        </div>
        <div class="images-gallery">
          <div class="image-card" *ngFor="let imageUrl of imageUrls; let i = index">
            <div class="image-wrapper" (click)="openImageInNewTab(imageUrl)">
              <img [src]="imageUrl" 
                   [alt]="'Quality issue image ' + (i + 1)"
                   class="image-thumbnail"
                   (error)="onImageError($event)"
                   loading="lazy" />
              <div class="image-overlay">
                <button class="image-action-btn" (click)="openImageInNewTab(imageUrl); $event.stopPropagation()" title="View full size">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
                <button class="image-action-btn" (click)="downloadImage(imageUrl); $event.stopPropagation()" title="Download image">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                </button>
              </div>
              <div class="image-badge">{{ i + 1 }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Update Status Section -->
      <div class="update-status-section">
        <div class="section-header clickable" (click)="toggleUpdateStatus()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          <h4>Update Status</h4>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" [style.transform]="showUpdateStatus ? 'rotate(180deg)' : 'rotate(0deg)'" style="margin-left: auto; transition: transform 0.3s;">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </div>

        <div class="update-status-content" *ngIf="showUpdateStatus">
          <!-- Status Options -->
          <div class="status-options">
            <div *ngFor="let status of statuses" class="status-option" [class.selected]="selectedStatus === status.value" (click)="selectedStatus = status.value">
              <div class="status-icon" [ngClass]="status.class">
                <i class="bi bi-{{ status.icon }}"></i>
              </div>
              <span>{{ status.label }}</span>
            </div>
          </div>

          <!-- Resolution Description -->
          <div class="form-group" *ngIf="requiresResolution()">
            <label>Resolution Description <span class="required">*</span></label>
            <textarea [(ngModel)]="resolutionDescription" class="form-control" rows="4" placeholder="Describe how the issue was resolved..."></textarea>
          </div>

          <!-- Status Comment -->
          <div class="form-group">
            <label>Add Comment (Optional)</label>
            <textarea [(ngModel)]="statusComment" class="form-control" rows="3" placeholder="Add a comment about this status update..."></textarea>
          </div>

          <!-- File Upload -->
          <div class="form-group">
            <label>Attach Images (Optional)</label>
            <input type="file" id="statusFileInput" multiple accept="image/*" (change)="onFileSelected($event)" hidden />
            <label for="statusFileInput" class="file-upload-btn">
              <i class="bi bi-cloud-upload"></i> Choose Images
            </label>
            <div *ngIf="selectedFiles.length > 0" class="selected-files">
              <div *ngFor="let file of selectedFiles; let i = index" class="file-item">
                <i class="bi bi-image"></i>
                <span>{{ file.name }}</span>
                <button type="button" (click)="removeFile(i)"><i class="bi bi-x"></i></button>
              </div>
            </div>
          </div>

          <!-- Update Button -->
          <button class="btn-update-status" [disabled]="!isUpdateValid() || isSubmitting" (click)="updateStatus()">
            <span *ngIf="!isSubmitting"><i class="bi bi-check2"></i> Update Status</span>
            <span *ngIf="isSubmitting"><span class="spinner-border spinner-border-sm"></span> Updating...</span>
          </button>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="comments-section" *ngIf="issue">
        <div class="section-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h4>Comments & Discussion</h4>
        </div>
        <app-issue-comments [issueId]="issue.issueId" [issueNumber]="issue.issueNumber || ''" [issueTitle]="issue.issueDescription || ''"></app-issue-comments>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn btn-close" (click)="onClose()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Close
      </button>
    </div>
  </div>
</div>

